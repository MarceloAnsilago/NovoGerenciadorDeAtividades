{% extends "core/base.html" %}
{% load i18n %}

{% block title %}Minhas Metas{% endblock %}

{% block content %}
<style>
  .meta-click-card {
    cursor: pointer;
    transition: box-shadow 0.2s ease, border-color 0.2s ease;
  }
  .meta-click-card:focus {
    outline: 2px solid var(--bs-primary);
    outline-offset: 2px;
  }
  .meta-card-selected {
    border-color: var(--bs-primary) !important;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
  }
  .meta-status-pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:.75rem;
    font-weight:600;
    padding:.35rem .8rem;
    border-radius:999px;
    border:1px solid transparent;
    line-height:1;
    white-space:nowrap;
  }
  .meta-status-pill.status-andamento{
    background:#fff4e5;
    color:#92400e;
    border-color:#ffdcb3;
  }
  .meta-status-pill.status-concluida{
    background:#e8f5ef;
    color:#0f5132;
    border-color:#bcd8ca;
  }
  .meta-status-pill.status-encerrada{
    background:#f8f9fa;
    color:#343a40;
    border-color:#ced4da;
  }
  .meta-click-card .card-title{
    font-size:1.05rem;
    line-height:1.2;
  }
</style>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Minhas Metas</h1>

    <div></div>
  </div>

  <div class="mb-3 d-flex flex-wrap align-items-center justify-content-between gap-3" id="metaMonthTabsWrapper">
    <div class="flex-grow-1">
      {% if meta_month_filters %}
      <ul class="nav nav-tabs mb-0" id="metaMonthTabs" role="tablist">
        {% for filter in meta_month_filters %}
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if filter.key == meta_month_default %}active{% elif forloop.first and not meta_month_default %}active{% endif %}" type="button" role="tab" data-month-filter="{{ filter.key }}">
              {{ filter.label }}
            </button>
          </li>
        {% endfor %}
      </ul>
      {% else %}
        <p class="text-muted mb-0 small">Nenhuma meta com data limite para o filtro atual.</p>
      {% endif %}
    </div>
    <div class="d-flex align-items-center gap-2">
      <label for="metaYearSelect" class="form-label small mb-0">Ano</label>
      <select id="metaYearSelect" class="form-select form-select-sm" aria-label="Filtrar metas por ano">
        {% if years %}
          {% for y in years %}
            <option value="{{ y }}" {% if ano_selected == y %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        {% else %}
          <option value="" selected>Sem anos dispon√≠veis</option>
        {% endif %}
      </select>
    </div>
  </div>

  {# ====== 1) GRID DE METAS (EM CIMA) ====== #}
    <div class="row g-3" id="metaCardsGrid">
    {% for aloc in alocacoes %}
      {% with meta=aloc.meta %}
    <div class="col-12 col-md-6 col-lg-4" data-month-key="{{ meta.month_key|default:'nodate' }}">
        <div class="card h-100 shadow-sm meta-click-card{% if meta_filter_id == meta.id %} meta-card-selected{% endif %}"
             data-status="{{ meta.status_key|default:'andamento' }}"
              role="button"
              tabindex="0"
              data-meta-id="{{ meta.id }}"
              data-meta-title="{{ meta.display_titulo|default:meta.titulo }}">
          <div class="card-body d-flex flex-column">

                <div class="d-flex align-items-start mb-2 pb-2 border-bottom border-secondary-subtle">
                  <i class="bi bi-bullseye text-primary fs-4 me-2"></i>
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center justify-content-between gap-2 mb-1">
                    <h5 class="card-title mb-0 d-flex align-items-center gap-2">
                      <i class="bi bi-card-text text-primary me-1" aria-hidden="true"></i>
                      {{ meta.display_titulo|default:meta.titulo }}
                    </h5>
                    <span class="meta-status-pill status-{{ meta.status_key|default:'andamento' }}"
                          aria-label="Status: {{ meta.status_label|default:'Em andamento' }}">
                      {{ meta.status_label|default:"Em andamento" }}
                    </span>
                  </div>

                {% if meta.descricao %}
                  <p class="card-text text-muted small mb-2">{{ meta.descricao }}</p>
                {% endif %}

                <div class="small text-secondary">
                  ID Meta: {{ meta.id }} - Criada por: {{ meta.criado_por.username }}
                  <br>Unidade criadora: {{ meta.unidade_criadora.nome }}
                </div>

                {% if meta.atividade %}
                  <div class="small text-secondary mt-1">
                    Atividade: {{ meta.atividade.titulo }} (ID: {{ meta.atividade.id }})
                  </div>
                {% endif %}
                <div class="small text-secondary mt-1">
                  Em programacao: {{ meta.programadas_total|default_if_none:"0" }}
                </div>
              </div>
            </div>

            {% if meta.data_limite %}
              <div class="small text-muted mb-2">
                <i class="bi bi-calendar-event me-1"></i>
                Data limite: {{ meta.data_limite|date:"d/m/Y" }}
              </div>
            {% endif %}

            <div class="mb-2">
              <div class="d-flex justify-content-between small">
                <span>Executado</span>
                <span><strong>{{ meta.realizado_total }}</strong> / {{ meta.alocado_total }}</span>
              </div>

              {# Barra de progresso: sem nested .progress e blindada #}
              <div class="progress" style="height:6px;">
                {% if meta.alocado_total %}
                  {% if meta.realizado_total > meta.alocado_total %}
                    <div class="progress-bar bg-success"
                         role="progressbar"
                         style="width:100%"
                         aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                  {% else %}
                    {% widthratio meta.realizado_total meta.alocado_total 100 as pct %}
                    <div class="progress-bar bg-success"
                         role="progressbar"
                         data-pct="{{ pct|default_if_none:'0' }}"
                         style="width:0%"
                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                  {% endif %}
                {% else %}
                  <div class="progress-bar bg-secondary"
                       role="progressbar"
                       style="width:0%"
                      aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                {% endif %}
              </div>
            </div>

            <div class="mb-2">
              <div class="d-flex justify-content-between small">
                <span>Alocado nesta unidade</span>
                {% with executado_local=aloc.realizado_unidade|default_if_none:0 total_local=aloc.quantidade_alocada total_meta=meta.alocado_total %}
                  <span><strong>{{ executado_local }}</strong>/{{ total_local }}{% if total_meta %}-{{ total_meta }}{% endif %}</span>
                {% endwith %}
              </div>
              <div class="progress" style="height:6px;">
                {% with executado_local=aloc.realizado_unidade|default_if_none:0 total_local=aloc.quantidade_alocada %}
                  {% if total_local %}
                    {% if executado_local >= total_local %}
                      <div class="progress-bar bg-info"
                           role="progressbar"
                           style="width:100%"
                           aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    {% else %}
                      {% widthratio executado_local total_local 100 as pct_exec_local %}
                      <div class="progress-bar bg-info"
                           role="progressbar"
                           data-pct="{{ pct_exec_local|default_if_none:'0' }}"
                           style="width:0%"
                           aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    {% endif %}
                  {% else %}
                    <div class="progress-bar bg-secondary"
                         role="progressbar"
                         style="width:0%"
                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                  {% endif %}
                {% endwith %}
              </div>
            </div>

          </div>
        </div>
      </div>
      {% endwith %}
    {% empty %}
      <div class="col-12">
        <div class="alert alert-info mb-0">Nao ha metas atribuidas a sua unidade.</div>
      </div>
    {% endfor %}
  </div>

  {# ====== 2) CARD ANDAMENTO (EMBAIXO) ====== #}
  <div class="card border-0 shadow-sm mt-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
          <h5 class="mb-1">Andamento das Atividades</h5>
          <div class="text-muted small">
            Periodo:
            <strong>{{ dt_start|date:"d/m/Y" }}</strong>
            &rarr;
            <strong>{{ dt_end|date:"d/m/Y" }}</strong>
          </div>
          <div id="metaAndamentoBadge" class="mt-2{% if not meta_filter_title %} d-none{% endif %}">
            <span class="badge bg-info-subtle text-info-emphasis">
              Filtrando meta: <strong id="metaAndamentoNome">{{ meta_filter_title }}</strong>
            </span>
            <button type="button" id="btnClearMetaFiltro" class="btn btn-link btn-sm text-decoration-none">
              Limpar filtro
            </button>
          </div>
        </div>

        <form method="get" class="d-flex align-items-center gap-2">
          <input type="date" name="start" value="{{ dt_start|date:'Y-m-d' }}" class="form-control form-control-sm">
          <input type="date" name="end"   value="{{ dt_end|date:'Y-m-d' }}"   class="form-control form-control-sm">
          <input type="hidden" name="month" value="{{ request.GET.month|default:'' }}">
          <input type="hidden" name="ano" value="{{ ano_selected|default:'' }}">
          <select name="status" class="form-select form-select-sm" style="max-width: 160px;">
            <option value="" {% if not status_filter %}selected{% endif %}>Todas</option>
            <option value="concluidas" {% if status_filter == 'concluidas' %}selected{% endif %}>Concluidas</option>
            <option value="nao_executadas" {% if status_filter == 'nao_executadas' %}selected{% endif %}>Nao executadas</option>
            <option value="pendentes" {% if status_filter == 'pendentes' %}selected{% endif %}>Pendentes</option>
          </select>
          <button class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-calendar-range"></i> Atualizar
          </button>
        </form>
      </div>

      <div class="table-responsive mt-3" id="andamentoTabelaWrap">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:105px;">Data</th>
              <th>Meta / Atividade</th>
              <th style="width:32%;">Servidores</th>
              <th style="width:150px;">Veiculo</th>
              <th style="width:160px;">Status</th>
            </tr>
          </thead>
          <tbody id="andamentoTbody">
            {% include "minhas_metas/partials/_andamento_rows.html" with andamento=andamento %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{# ====== JS: filtros de mes/ano ===== #}
<script>
(function () {
  var grid = document.getElementById("metaCardsGrid");
  var tabs = Array.from(document.querySelectorAll("#metaMonthTabs .nav-link"));
  var startInput = document.querySelector('input[name="start"]');
  var endInput = document.querySelector('input[name="end"]');
  var yearSelect = document.getElementById("metaYearSelect");

  if (yearSelect) {
    yearSelect.addEventListener("change", function () {
      var url = new URL(window.location.href);
      var ano = yearSelect.value;
      if (ano) url.searchParams.set("ano", ano);
      else url.searchParams.delete("ano");
      url.searchParams.delete("month");
      window.location.href = url.toString();
    });
  }

  if (!grid || !tabs.length) return;

  var cards = Array.from(grid.querySelectorAll("[data-month-key]"));
  function formatIso(d) {
    var month = String(d.getMonth() + 1).padStart(2, "0");
    var day = String(d.getDate()).padStart(2, "0");
    return d.getFullYear() + "-" + month + "-" + day;
  }

  function getRangeFromMonthKey(key) {
    if (!key || key === "nodate") return null;
    var parts = key.split("-");
    if (parts.length !== 2) return null;
    var year = Number(parts[0]);
    var month = Number(parts[1]);
    if (!Number.isFinite(year) || !Number.isFinite(month) || month < 1 || month > 12) return null;
    var start = new Date(year, month - 1, 1);
    var end = new Date(year, month, 0);
    return { start: formatIso(start), end: formatIso(end) };
  }

  function applyRangeToInputs(range) {
    if (!range) return;
    if (startInput) startInput.value = range.start;
    if (endInput) endInput.value = range.end;
  }

  function reloadWithRange(range, monthKey) {
    if (!range) return;
    var url = new URL(window.location.href);
    url.searchParams.set("start", range.start);
    url.searchParams.set("end", range.end);
    if (monthKey) {
      url.searchParams.set("month", monthKey);
    } else {
      url.searchParams.delete("month");
    }
    window.location.href = url.toString();
  }

  function applyMonthFilter(key) {
    cards.forEach(function (card) {
      var matches = !key || card.dataset.monthKey === key;
      card.style.display = matches ? "" : "none";
    });
    tabs.forEach(function (tab) {
      var tabKey = tab.dataset.monthFilter || "";
      tab.classList.toggle("active", tabKey === (key || ""));
    });
  }

  tabs.forEach(function (tab) {
    tab.addEventListener("click", function () {
      var key = tab.dataset.monthFilter || "";
      applyMonthFilter(key);
      var range = getRangeFromMonthKey(key);
      if (range) {
        applyRangeToInputs(range);
        reloadWithRange(range, key);
      }
    });
  });

  var urlObj = new URL(window.location.href);
  var initialMonth = urlObj.searchParams.get("month") || "";
  var activeTab = tabs.find(function (t) { return t.classList.contains("active"); });
  var initialKey = initialMonth || (activeTab ? activeTab.dataset.monthFilter || "" : "");
  applyMonthFilter(initialKey);
})();
</script>
{# ====== JS: aplica o width das barras a partir do data-pct ====== #}
<script>
(function () {
  var selectedClass = "meta-card-selected";
  var cards = document.querySelectorAll(".meta-click-card");
  var tbody = document.getElementById("andamentoTbody");
  var badgeWrap = document.getElementById("metaAndamentoBadge");
  var badgeName = document.getElementById("metaAndamentoNome");
  var clearBtn = document.getElementById("btnClearMetaFiltro");

  function updateCardSelection(metaId) {
    cards.forEach(function (card) {
      if (metaId && card.dataset.metaId === String(metaId)) {
        card.classList.add(selectedClass);
      } else {
        card.classList.remove(selectedClass);
      }
    });
  }

  function updateBadge(metaId, title) {
    if (!badgeWrap) return;
    if (metaId) {
      badgeWrap.classList.remove("d-none");
      if (badgeName) {
        badgeName.textContent = title || ("Meta #" + metaId);
      }
    } else {
      badgeWrap.classList.add("d-none");
    }
  }

  function buildUrl(metaId) {
    var url = new URL(window.location.href);
    if (metaId) {
      url.searchParams.set("meta", metaId);
    } else {
      url.searchParams.delete("meta");
    }
    return url;
  }

  function fetchAndamento(metaId) {
    var urlObj = buildUrl(metaId);
    var finalUrl = urlObj.toString();
    fetch(finalUrl, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(function (resp) { return resp.json(); })
      .then(function (data) {
        if (tbody && typeof data.html === "string") {
          tbody.innerHTML = data.html;
        }
        updateCardSelection(data.meta);
        updateBadge(data.meta, data.meta_title);
        history.replaceState(null, "", finalUrl);
      })
      .catch(function (err) {
        console.error("Erro ao atualizar andamento:", err);
      });
  }

  cards.forEach(function (card) {
    function handleActivate() {
      var current = document.querySelector(".meta-click-card." + selectedClass);
      var currentId = current ? current.dataset.metaId : null;
      var clickedId = card.dataset.metaId;
      var nextId = (currentId === clickedId) ? null : clickedId;
      fetchAndamento(nextId);
    }
    card.addEventListener("click", function (ev) {
      ev.preventDefault();
      handleActivate();
    });
    card.addEventListener("keydown", function (ev) {
      if (ev.key === "Enter" || ev.key === " ") {
        ev.preventDefault();
        handleActivate();
      }
    });
  });

  if (clearBtn) {
    clearBtn.addEventListener("click", function (ev) {
      ev.preventDefault();
      fetchAndamento(null);
    });
  }

  document.querySelectorAll(".progress-bar[data-pct]").forEach(function (el) {
    var raw = el.getAttribute("data-pct");
    var v = Number(raw);
    if (!Number.isFinite(v) || v < 0) v = 0;
    if (v > 100) v = 100;
    el.style.width = v + "%";
    el.setAttribute("aria-valuenow", String(v));
  });
})();
</script>
{% endblock %}
