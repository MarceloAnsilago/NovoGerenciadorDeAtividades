{# templates/descanso/feriados.html #}
{% extends "core/base.html" %}

{% block title %}Feriados - Descanso{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <style>
    #descanso-feriados-calendar {
      background: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 0.5rem;
    }

    #descanso-feriados-calendar .fc-toolbar-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    #descanso-feriados-calendar .fc-event {
      cursor: pointer;
    }

    #descanso-feriados-calendar .descanso-feriado-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      width: 100%;
    }

    #descanso-feriados-calendar .descanso-feriado-x {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      width: 1.2rem;
      height: 1.2rem;
      border-radius: 0.2rem;
      font-weight: 700;
      font-size: 0.8rem;
      line-height: 1;
      background: #dc3545;
      color: #ffffff;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
    <div>
      <h1 class="h4 mb-1">Feriados</h1>
      <p class="text-muted small mb-0">Calendario para registrar e visualizar feriados da unidade.</p>
    </div>
    <a href="{% url 'descanso:lista_servidores' %}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left"></i> Voltar
    </a>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-light d-flex align-items-center justify-content-between flex-wrap gap-2">
      <strong><i class="bi bi-calendar-event me-1"></i> Calendario de feriados</strong>
      <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#descanso-feriados-modal">
        <i class="bi bi-plus-lg me-1"></i> Novo cadastro de feriados
      </button>
    </div>
    <div class="card-body">
      <div class="text-muted small mb-3">
        Selecione um cadastro na tela de descansos ou crie um novo cadastro para abrir o calendario.
      </div>
      <div id="descanso-feriados-info" class="text-muted small d-none"></div>
      <div id="descanso-feriados-calendar" class="d-none mt-2"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="descanso-feriados-modal" tabindex="-1" aria-labelledby="descansoFeriadosModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="descansoFeriadosModalLabel">Cadastro de feriados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <label for="descanso-feriados-descricao" class="form-label">Descricao</label>
        <input
          type="text"
          class="form-control"
          id="descanso-feriados-descricao"
          placeholder="Ex.: feriados do decreto 50"
          maxlength="120"
          autocomplete="off"
        >
        <div class="form-text">Use esta descricao para identificar o conjunto de feriados.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="descanso-feriados-salvar">Abrir calendario</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="descanso-feriados-item-modal" tabindex="-1" aria-labelledby="descansoFeriadoItemLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="descansoFeriadoItemLabel">Cadastrar feriado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="descanso-feriado-data" class="form-label">Data</label>
          <input type="text" class="form-control" id="descanso-feriado-data" readonly>
        </div>
        <div class="mb-1">
          <label for="descanso-feriado-descricao" class="form-label">Descricao do feriado</label>
          <input
            type="text"
            class="form-control"
            id="descanso-feriado-descricao"
            placeholder="Ex.: Confraternizacao universal"
            maxlength="120"
            autocomplete="off"
          >
        </div>
        <div class="form-text">Informe o nome do feriado para este dia.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="descanso-feriado-salvar">Salvar feriado</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const el = document.getElementById("descanso-feriados-calendar");
      const info = document.getElementById("descanso-feriados-info");
      const modalEl = document.getElementById("descanso-feriados-modal");
      const salvarBtn = document.getElementById("descanso-feriados-salvar");
      const descricaoInput = document.getElementById("descanso-feriados-descricao");
      const itemModalEl = document.getElementById("descanso-feriados-item-modal");
      const itemSalvarBtn = document.getElementById("descanso-feriado-salvar");
      const itemDataInput = document.getElementById("descanso-feriado-data");
      const itemDescricaoInput = document.getElementById("descanso-feriado-descricao");
      if (!el || !window.FullCalendar) return;

      const params = new URLSearchParams(window.location.search || "");
      const initialCadastro = (params.get("cadastro") || "").trim();
      const initialMonth = (params.get("mes") || params.get("month") || "").trim();
      const initialDate = (params.get("data") || "").trim();
      let pendingDate = null;
      if (/^\d{4}-\d{2}-\d{2}$/.test(initialDate)) {
        pendingDate = initialDate;
      } else if (/^\d{4}-\d{2}$/.test(initialMonth)) {
        pendingDate = `${initialMonth}-01`;
      }

      const getCookie = (name) => {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
        return "";
      };

      const urls = {
        feed: "{% url 'descanso:feriados_feed' %}",
        cadastros: "{% url 'descanso:feriados_cadastros' %}",
        novoCadastro: "{% url 'descanso:feriados_cadastro_novo' %}",
        registrar: "{% url 'descanso:feriados_registrar' %}",
        excluir: "{% url 'descanso:feriados_excluir' %}",
      };

      let cadastroAtual = null;
      let dataSelecionada = null;
      const calendar = new FullCalendar.Calendar(el, {
        locale: "pt-br",
        initialView: "dayGridMonth",
        buttonText: {
          today: "Hoje",
          month: "Mes",
          week: "Semana",
          day: "Dia"
        },
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,timeGridDay"
        },
        height: "auto",
        eventContent(info) {
          const wrapper = document.createElement("span");
          wrapper.className = "descanso-feriado-pill";
          const title = document.createElement("span");
          title.textContent = info.event.title || "Feriado";
          const close = document.createElement("span");
          close.className = "descanso-feriado-x";
          close.textContent = "x";
          wrapper.appendChild(title);
          wrapper.appendChild(close);
          return { domNodes: [wrapper] };
        },
        dateClick(info) {
          if (!cadastroAtual) {
            alert("Selecione um cadastro de feriados primeiro.");
            return;
          }
          dataSelecionada = info.dateStr;
          if (itemDataInput) {
            const dataBr = new Date(info.dateStr + "T00:00:00").toLocaleDateString("pt-BR");
            itemDataInput.value = dataBr;
          }
          if (itemDescricaoInput) itemDescricaoInput.value = "";
          const modal = new bootstrap.Modal(itemModalEl);
          modal.show();
        },
        eventClick(info) {
          if (!cadastroAtual) return;
          if (!confirm("Excluir este feriado?")) return;
          fetch(urls.excluir, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ feriado_id: info.event.id }),
          })
            .then((resp) => resp.json())
            .then((json) => {
              if (!json.ok) {
                alert(json.error || "Nao foi possivel excluir o feriado.");
                return;
              }
              info.event.remove();
            })
            .catch(() => alert("Erro ao excluir o feriado."));
        },
        events: []
      });

      const setCadastro = (id, descricao) => {
        if (!id) return;
        cadastroAtual = { id: String(id), descricao: descricao || "" };
        const label = cadastroAtual.descricao?.trim();
        if (!label) return;
        info.textContent = `Cadastro atual: ${label}`;
        info.classList.remove("d-none");
        el.classList.remove("d-none");
        calendar.removeAllEventSources();
        calendar.addEventSource({
          url: urls.feed,
          extraParams: { cadastro_id: cadastroAtual.id }
        });
        calendar.render();
        if (pendingDate) {
          calendar.gotoDate(pendingDate);
          pendingDate = null;
        }
      };

      salvarBtn?.addEventListener("click", () => {
        const label = descricaoInput?.value || "";
        if (!label.trim()) {
          descricaoInput?.classList.add("is-invalid");
          descricaoInput?.focus();
          return;
        }
        descricaoInput?.classList.remove("is-invalid");
        fetch(urls.novoCadastro, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ descricao: label }),
        })
          .then((resp) => resp.json())
          .then((json) => {
            if (!json.ok) {
              alert(json.error || "Nao foi possivel criar o cadastro.");
              return;
            }
            const cadastro = json.cadastro;
            setCadastro(cadastro.id, cadastro.descricao);
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
            descricaoInput.value = "";
          })
          .catch(() => alert("Erro ao criar o cadastro."));
      });

      descricaoInput?.addEventListener("input", () => {
        descricaoInput.classList.remove("is-invalid");
      });

      itemSalvarBtn?.addEventListener("click", () => {
        const descricao = (itemDescricaoInput?.value || "").trim();
        if (!descricao) {
          itemDescricaoInput?.classList.add("is-invalid");
          itemDescricaoInput?.focus();
          return;
        }
        if (!cadastroAtual || !dataSelecionada) return;
        fetch(urls.registrar, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({
            cadastro_id: cadastroAtual.id,
            data: dataSelecionada,
            descricao: descricao,
          }),
        })
          .then((resp) => resp.json())
          .then((json) => {
            if (!json.ok) {
              alert(json.error || "Nao foi possivel cadastrar o feriado.");
              return;
            }
            calendar.refetchEvents();
            const modal = bootstrap.Modal.getInstance(itemModalEl) || new bootstrap.Modal(itemModalEl);
            modal.hide();
          })
          .catch(() => alert("Erro ao cadastrar o feriado."));
      });

      itemDescricaoInput?.addEventListener("input", () => {
        itemDescricaoInput.classList.remove("is-invalid");
      });

      if (initialCadastro) {
        fetch(urls.cadastros, { headers: { "X-Requested-With": "XMLHttpRequest" } })
          .then((resp) => resp.json())
          .then((json) => {
            const cadastros = Array.isArray(json.cadastros) ? json.cadastros : [];
            const isId = /^\d+$/.test(initialCadastro);
            const target = cadastros.find((cad) => {
              if (!cad) return false;
              if (isId) return String(cad.id) === initialCadastro;
              return String(cad.descricao || "").trim().toLowerCase() === initialCadastro.toLowerCase();
            });
            if (target) {
              setCadastro(target.id, target.descricao || "");
            }
          })
          .catch(() => {});
      }
    });
  </script>
{% endblock %}
