{# templates/descanso/descansos_unidade.html #}
{% extends "core/base.html" %}
{% block title %}Descansos da unidade{% endblock %}

{% block content %}
{% now 'Y-m-d' as hoje %}
{% now 'Y' as ano_atual %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
    <div>
      <h1 class="h4 mb-1">Descansos da unidade</h1>
      <p class="text-muted small mb-0">Visualize os descansos registrados para todos os servidores da unidade.</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'descanso:lista_servidores' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Voltar para a lista
      </a>
      <a href="{% url 'descanso:relatorio_mapa' %}?ano={{ ano_atual }}" class="btn btn-outline-dark btn-sm">
        <i class="bi bi-calendar3"></i> Mapa de ferias/descanso
      </a>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light d-flex align-items-start justify-content-between flex-wrap gap-3">
      <div class="d-flex align-items-start gap-2">
        <i class="bi bi-calendar-week text-primary fs-4"></i>
        <div>
          <strong>Visão geral</strong>
          <div class="text-muted small">Use as abas para filtrar o mês e selecione o ano acima.</div>
        </div>
      </div>
    </div>
    <div class="card-body">
      {% if month_filters %}
        <div class="mb-3" id="descansosMonthTabsWrapper">
          <div class="d-flex flex-wrap align-items-end justify-content-between gap-3">
            <ul class="nav nav-tabs small flex-wrap gap-2" id="descansosMonthTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link{% if not month_default %} active{% endif %}" type="button" role="tab" data-month-filter="">
                  Todos
                  <span class="badge bg-primary text-white ms-1 rounded-pill">{{ total_descansos }}</span>
                </button>
              </li>
              {% for filter in month_filters %}
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link{% if filter.key == month_default %} active{% endif %}"
                    type="button"
                    role="tab"
                    data-month-filter="{{ filter.key }}">
                    {{ filter.label }}
                    <span class="badge bg-primary text-white ms-1 rounded-pill">{{ filter.count }}</span>
                  </button>
                </li>
              {% endfor %}
            </ul>
            <form method="get" class="d-flex align-items-end gap-2 flex-wrap" id="descansosYearForm">
              <div class="d-flex flex-column">
                <label class="form-label small text-muted mb-1">Ano</label>
                <select name="ano" class="form-select form-select-sm">
                  {% for ano_opcao in anos_opcoes %}
                    <option value="{{ ano_opcao }}" {% if ano_opcao == ano %}selected{% endif %}>
                      {{ ano_opcao }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <button class="btn btn-sm btn-outline-primary" type="submit">
                <i class="bi bi-arrow-repeat me-1"></i> Atualizar
              </button>
            </form>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-light d-flex align-items-center">
      <strong><i class="bi bi-table me-1"></i> Descansos cadastrados</strong>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table id="descansosTable" class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Servidor</th>
              <th>Tipo</th>
              <th>Periodo</th>
              <th class="text-center">Situacao</th>
              <th>Observacoes</th>
              <th class="text-end">Acoes</th>
            </tr>
          </thead>
          <tbody>
            {% for d in descansos %}
              <tr data-descanso-months="{{ d.month_keys|join:',' }}">
                <td class="fw-medium">
                  <a href="{% url 'descanso:descansos_servidor' d.servidor_id %}" class="text-decoration-none">
                    {{ d.servidor.nome }}
                  </a>
                </td>
                <td>{{ d.get_tipo_display }}</td>
                <td>{{ d.data_inicio }} &ndash; {{ d.data_fim }}</td>
                <td class="text-center">
                  {% if d.data_inicio|stringformat:"s" <= hoje and d.data_fim|stringformat:"s" >= hoje %}
                    <span class="badge bg-warning text-dark">Em andamento</span>
                  {% elif d.data_inicio|stringformat:"s" > hoje %}
                    <span class="badge bg-info text-dark">Programado</span>
                  {% else %}
                    <span class="badge bg-secondary">Encerrado</span>
                  {% endif %}
                </td>
                <td class="text-muted small">{{ d.observacoes|default:"&mdash;" }}</td>
                <td class="text-end">
                  {% url 'descanso:editar_descanso' d.id as edit_base %}
                  {% url 'descanso:excluir_descanso' d.id as delete_base %}
                  {% include "partials/_botoes_acoes.html" %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">Nenhum descanso encontrado.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
(function () {
  const tabs = Array.from(document.querySelectorAll("#descansosMonthTabs button[data-month-filter]"));
  const tbody = document.querySelector("#descansosTable tbody");
  if (!tabs.length || !tbody) return;

  let selectedKey = "{{ month_default|default:''|lower }}";

  const applyFilter = () => {
    const key = (selectedKey || "").toLowerCase();
    tbody.querySelectorAll("tr").forEach((row) => {
      const rowKeys = (row.getAttribute("data-descanso-months") || "")
        .split(",")
        .map((value) => value.trim().toLowerCase())
        .filter(Boolean);
      const show = !key || rowKeys.includes(key);
      row.classList.toggle("d-none", !show);
    });
  };

  tabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      selectedKey = (tab.getAttribute("data-month-filter") || "").toLowerCase();
      tabs.forEach((inner) => {
        const innerKey = (inner.getAttribute("data-month-filter") || "").toLowerCase();
        inner.classList.toggle("active", innerKey === selectedKey);
      });
      applyFilter();
    });
  });

  // ensure the initial tab is highlighted if necessary
  tabs.forEach((tab) => {
    const key = (tab.getAttribute("data-month-filter") || "").toLowerCase();
    tab.classList.toggle("active", key === selectedKey);
  });

  applyFilter();
})();
const yearForm = document.querySelector("#descansosYearForm");
const yearSelect = yearForm?.querySelector("select[name='ano']");
if (yearForm && yearSelect) {
  yearSelect.addEventListener("change", () => yearForm.submit());
}
</script>
{% endblock %}
