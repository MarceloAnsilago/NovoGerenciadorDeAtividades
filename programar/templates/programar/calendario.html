{% extends "programar/base.html" %}

{% block page_body %}

  {# GRID do calendário #}
  {% include "programar/partials/_calendar_grid.html" %}
  
  {% include "programar/partials/_servidores_disponiveis_logic.html" %}
  {# ⬇️ Barra de controles (agora entre o calendário e o relatório) #}
  {% include "programar/partials/_controls_bar.html" %}

  {# Container dos relatórios #}
  {% include "programar/partials/_relatorios_container.html" %}

  {# Modal (fica no fim do body) #}
  {% include "programar/partials/_modal_programacao.html" %}

{% endblock %}

{% block page_scripts %}
  {% include "programar/scripts/_atividades_logic.html" %}
  {% include "programar/scripts/_metas_logic.html" %}
  {% include "programar/scripts/_relatorios_logic.html" %}
  {% include "programar/scripts/_modal_logic.html" %}
  {% include "programar/scripts/_calendar_init.html" %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const toggles = document.querySelectorAll('[data-bs-toggle="dropdown"]');
      toggles.forEach((el) => {
        try { bootstrap.Dropdown.getOrCreateInstance(el); } catch (_) {}
      });
    });
  </script>
  <script>
    document.addEventListener('click', (ev) => {
      const toggle = ev.target.closest?.('.navbar [data-bs-toggle="dropdown"]');
      if (!toggle) return;
      ev.preventDefault();
      ev.stopPropagation();
      try {
        bootstrap.Dropdown.getOrCreateInstance(toggle).toggle();
      } catch (_) {}
    }, true);
  </script>
  <script>
    (function(){
      function fixTitulo(){
        try{
          const cont = document.getElementById('programar-relatoriosContainer');
          if (!cont) return;
          const ttl = cont.querySelector('#relatorioPrintArea h5.card-title');
          if (ttl) ttl.textContent = 'Programação semanal de atividades';
        }catch(_e){}
      }
      const mo = new MutationObserver(function(muts){
        for (const m of muts){
          for (const n of m.addedNodes){
            if (!(n instanceof Element)) continue;
            if (n.id === 'relatorioPrintArea' || n.querySelector?.('#relatorioPrintArea')){
              setTimeout(fixTitulo, 0);
              return;
            }
          }
        }
      });
      document.addEventListener('DOMContentLoaded', function(){
        fixTitulo();
        const root = document.getElementById('programar-relatoriosContainer') || document.documentElement;
        mo.observe(root, {childList:true, subtree:true});
      });
    })();
  </script>
{% endblock %}
