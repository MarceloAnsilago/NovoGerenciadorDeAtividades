<script>
(function(){
  window.PROGRAMAR = window.PROGRAMAR || {};

  // ======= CONFIG/Padrões ====================================================
  const DEFAULTS = {
    targetSelector:  '#servidoresLivres, #poolServidores, .js-servidores-livres',
    badgeSelector:   '#countLivres, .js-count-livres',

    // Expediente administrativo
    expedienteSelector: '#expedienteAdmin, .js-expediente-admin',
    expedienteBadgeSelector: '#countExpediente, .js-count-expediente',

    excludeAllocated: true,
    cardSelectorInMetas: '.servidor-chip, .srv-chip, .chip-servidor',
    cardIdAttr:  'data-id',
    itemIdAttr:  'data-id',
    renderItem:  defaultRenderItem
  };

  // ======= Utils DOM/HTML ====================================================
  function escapeHtml(s){
    return String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }
  function getContainer(sel){ return document.querySelector(sel); }

  function getBadgeForContainer(containerEl, explicitSelector) {
    // 1) tenta seletor explícito (ex.: #countLivres)
    if (explicitSelector) {
      const el = document.querySelector(explicitSelector);
      if (el) return el;
    }
    // 2) fallback: badge no header do card pai
    const card = containerEl?.closest?.('.card');
    return card ? card.querySelector('.card-header .badge') : null;
  }

  function setBadgeFor(containerEl, count, explicitSelector) {
    const badge = getBadgeForContainer(containerEl, explicitSelector);
    if (badge) badge.textContent = String(count);
  }

  function updateBadges(opts){
    const pool = document.querySelector(opts.targetSelector);
    const exp  = document.querySelector(opts.expedienteSelector);
    if (pool) setBadgeFor(pool, pool.children.length, opts.badgeSelector);
    if (exp)  setBadgeFor(exp,  exp.children.length,  opts.expedienteBadgeSelector);
  }

  function defaultRenderItem(servidor){
    const el = document.createElement('div');
    el.className = 'servidor-card';
    el.setAttribute('draggable','true'); // mantém DnD
    el.dataset.id = servidor.id;
    el.innerHTML = `
      <span class="srv-icon"><i class="bi bi-person-fill"></i></span>
      <span class="srv-name">${escapeHtml(servidor.nome)}</span>`;
    return el;
  }
  function defaultRenderExpedienteItem(servidor){
    const el = document.createElement('div');
    el.className = 'servidor-card';
    el.dataset.id = servidor.id;   // no expediente não arrasta
    el.innerHTML = `
      <span class="srv-icon"><i class="bi bi-person-fill"></i></span>
      <span class="srv-name">${escapeHtml(servidor.nome)}</span>`;
    return el;
  }

  function getAllocatedIds(opts){
    if (!opts.excludeAllocated) return new Set();
    const ids = new Set();
    document.querySelectorAll(opts.cardSelectorInMetas).forEach(chip => {
      const sid = chip.getAttribute(opts.cardIdAttr) || chip.dataset.id || chip.dataset.servidorId;
      if (sid) ids.add(String(sid));
    });
    return ids;
  }

  // ======= Render "por diff" (preserva a ordem atual) ========================
  function diffRenderPool(target, livres, opts){
    const livresIds = new Set(livres.map(s => String(s.id)));

    // remove quem não está mais na lista
    Array.from(target.children).forEach(child => {
      const sid = child.getAttribute(opts.itemIdAttr) || child.dataset.id || child.dataset.servidorId;
      if (!sid || !livresIds.has(String(sid))) child.remove();
    });

    const presentes = new Set(
      Array.from(target.children).map(ch => String(ch.getAttribute(opts.itemIdAttr) || ch.dataset.id || ch.dataset.servidorId))
    );

    livres.forEach(s => {
      const sid = String(s.id);
      if (presentes.has(sid)) return;
      const el = opts.renderItem(s);
      if (!el.getAttribute(opts.itemIdAttr)) el.setAttribute(opts.itemIdAttr, sid);
      target.appendChild(el);
    });

    setBadgeFor(target, target.children.length, opts.badgeSelector);
  }

  function renderExpedienteFromLivres(livres, opts){
    const exp = getContainer(opts.expedienteSelector);
    if (!exp) return;
    exp.innerHTML = '';
    livres.forEach(s => exp.appendChild(defaultRenderExpedienteItem(s)));
    setBadgeFor(exp, exp.children.length, opts.expedienteBadgeSelector);
  }

  // ======= Fetch + aplicar ===================================================
  async function loadServidoresDisponiveis(iso, options = {}){
    const opts = { ...DEFAULTS, ...options };

    const urlBase = window.PROGRAMAR?.urls?.servidores;
    if (!urlBase) {
      console.error('[programar] URL programar:servidores_para_data não definida.');
      return { livres: [], impedidos: [] };
    }
    if (!/^\d{4}-\d{2}-\d{2}$/.test(String(iso||''))) {
      console.warn('[programar] Data inválida:', iso);
      return { livres: [], impedidos: [] };
    }

    const target = getContainer(opts.targetSelector);
    if (target) {
      target.classList.add('is-loading');
      target.innerHTML = `<div class="text-muted">Carregando…</div>`;
      setBadgeFor(target, 0, opts.badgeSelector);
    }

    try {
      const url = new URL(urlBase, window.location.origin);
      url.searchParams.set('data', iso);
      const resp = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const json = await resp.json();

      let livres = Array.isArray(json.livres) ? json.livres : [];
      const impedidos = Array.isArray(json.impedidos) ? json.impedidos : [];

      // não mostrar na pool quem já está alocado nos cards
      const alocados = getAllocatedIds(opts);
      if (alocados.size) {
        livres = livres.filter(s => !alocados.has(String(s.id)));
      }

      if (target) {
        target.classList.add('servidores-grid');
        target.innerHTML = '';
        diffRenderPool(target, livres, opts);
        target.classList.remove('is-loading');
      }

      // expediente = cópia dos livres inicialmente
      renderExpedienteFromLivres(livres, opts);
      updateBadges(opts);

      document.dispatchEvent(new CustomEvent('programar:servidoresLoaded', {
        detail: { iso, livres, impedidos }
      }));

      return { livres, impedidos };
    } catch (err) {
      console.error('[programar] Falha ao carregar servidores:', err);
      if (target) {
        target.innerHTML = `<div class="text-danger">Erro ao carregar.</div>`;
        target.classList.remove('is-loading');
      }
      return { livres: [], impedidos: [] };
    }
  }

  // ======= Observers (mantém badges atualizados) ============================
  function wireBadgeObservers(options = {}){
    const opts = { ...DEFAULTS, ...options };
    let poolObsAttached = false;
    let expObsAttached  = false;

    const tryAttach = () => {
      const pool = getContainer(opts.targetSelector);
      const exp  = getContainer(opts.expedienteSelector);

      if (pool && !poolObsAttached) {
        new MutationObserver(() => updateBadges(opts)).observe(pool, { childList: true });
        poolObsAttached = true;
      }
      if (exp && !expObsAttached) {
        new MutationObserver(() => updateBadges(opts)).observe(exp, { childList: true });
        expObsAttached = true;
      }
      if (poolObsAttached && expObsAttached) installer.disconnect();
    };

    const installer = new MutationObserver(tryAttach);
    installer.observe(document.documentElement, { childList: true, subtree: true });
    tryAttach(); // tentativa imediata
  }
  document.addEventListener('DOMContentLoaded', () => wireBadgeObservers());

  // ======= Integrações convenientes =========================================
  document.addEventListener('shown.bs.modal', (ev) => {
    // se quiser filtrar: if (!ev.target.matches('#programar-modalAtividade')) return;
    const hidden = document.getElementById('programar-dataAtividade') ||
                   document.getElementById('programar-data') ||
                   document.querySelector('[data-programar-data]');
    const iso = hidden?.value || hidden?.getAttribute?.('data-programar-data');
    if (iso) loadServidoresDisponiveis(iso);
  });

  document.addEventListener('programar:diaSelecionado', (e) => {
    const iso = e?.detail?.iso;
    if (iso) loadServidoresDisponiveis(iso);
  });

  // API pública
  window.PROGRAMAR.loadServidoresDisponiveis = loadServidoresDisponiveis;
})();
</script>
