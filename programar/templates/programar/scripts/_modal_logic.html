<script>
(function(){
  const modalEl = document.getElementById('programar-modalAtividade');
  const inputData = document.getElementById('programar-dataAtividade');
  const btnSalvar = document.getElementById('programar-btnSalvar');

  window.PROGRAMAR = window.PROGRAMAR || {};
  window.PROGRAMAR.openProgramarModal = function(dateStr, labelText){
    if (!modalEl) return;

    /* ğŸ”§ anti-duplicaÃ§Ã£o: mantÃ©m sÃ³ a PRIMEIRA linha de cards, remove demais */
    const rows = modalEl.querySelectorAll('#programar-atividadesRow, .cards-row');
    if (rows.length > 1) rows.forEach((r, i) => { if (i > 0) r.remove(); });

    inputData.value = dateStr || '';
    const lbl = document.getElementById('programar-modalAtividadeLabel');
    if (lbl) lbl.textContent = labelText ? `Programar atividades â€” ${labelText}` : 'Programar atividades';
    bootstrap.Modal.getOrCreateInstance(modalEl).show();
    btnSalvar.disabled = true;

    window.PROGRAMAR.loadMetas?.(dateStr);
    window.PROGRAMAR.loadServidores?.(dateStr);
  };
})();


(function(){
  const NS = window.PROGRAMAR = window.PROGRAMAR || {};
  const btn = document.getElementById('programar-btnSalvar');
  const inputData = document.getElementById('programar-dataAtividade');
  const cont = () => document.getElementById('metaCardsContainer');

  // habilita/desabilita o salvar conforme existirem cards de meta
  function refreshSalvar(){
    const hasItems = !!cont()?.querySelector('[data-meta-id]');
    if (btn) btn.disabled = !hasItems;
  }
  // observar mudanÃ§as nos cards
  document.addEventListener('DOMContentLoaded', ()=>{
    const c = cont();
    if (c){
      new MutationObserver(refreshSalvar).observe(c, {childList:true, subtree:true});
      refreshSalvar();
    }
  });

  function extractVeiculoId(card){
    // cobre vÃ¡rios formatos que vocÃª jÃ¡ usou no projeto
    const sel = card.querySelector('select[name="card_veiculos"], select.card-veiculos, [data-veiculo-id]');
    if (!sel) return null;
    const v = sel.value ?? sel.dataset.veiculoId;
    return v ? Number(v) : null;
  }

  function extractItem(card){
    const metaId = Number(card.dataset.metaId);
    const drop = card.querySelector('.meta-dropzone') || card;
    const chips = drop.querySelectorAll('[data-id], [data-servidor-id], .servidor-chip');
    const servidores_ids = Array.from(chips)
      .map(el => Number(el.getAttribute('data-id') || el.getAttribute('data-servidor-id')))
      .filter(Boolean);

    const obs = (card.querySelector('textarea[name="observacao"]')?.value || '').trim();
    const veiculo_id = extractVeiculoId(card);
    return { meta_id: metaId, observacao: obs, veiculo_id, servidores_ids };
  }

  async function salvar(){
    const url = NS.urls?.salvar;
    if (!url){ console.error('NS.urls.salvar nÃ£o configurado'); return; }

    const dateStr = inputData?.value;
    if (!dateStr){ alert('Selecione uma data para salvar.'); return; }

    const cards = Array.from(cont()?.querySelectorAll('[data-meta-id]') || []);
    if (!cards.length){ alert('Adicione pelo menos uma atividade.'); return; }

    const itens = cards.map(extractItem);
    const payload = { data: dateStr, observacao: '', itens };

    btn.disabled = true;
    const original = btn.textContent; btn.textContent = 'Salvando...';

    try{
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(payload)
      });
      const json = await resp.json().catch(()=> ({}));
      if (!resp.ok || json.ok === false){
        throw new Error(json.error || 'Falha ao salvar.');
      }

      // sucesso: fecha modal e (se quiser) recarrega programaÃ§Ã£o do dia
      const modalEl = document.getElementById('programar-modalAtividade');
      bootstrap.Modal.getOrCreateInstance(modalEl).hide();

      // opcional: limpar cards / dar um toast / atualizar calendÃ¡rio
      console.log('Salvo com sucesso:', json);
    }catch(err){
      console.error(err);
      alert('Erro ao salvar. Veja o console para detalhes.');
    }finally{
      btn.textContent = original;
      refreshSalvar();
    }
  }

  btn?.addEventListener('click', (e)=>{ e.preventDefault(); salvar(); });
})();
</script>
