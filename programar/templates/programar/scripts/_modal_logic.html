<script>
(function () {
  const NS = (window.PROGRAMAR = window.PROGRAMAR || {});

  const IDS = {
    modal: "programar-modalAtividade",
    date: "programar-dataAtividade",
    title: "programar-modalAtividadeLabel",
    saveBtn: "programar-btnSalvar",
    selectedActivitiesSeparator: "programar-separator-atividades-label",
  };

  function get(id) {
    return document.getElementById(id);
  }

  function isISODate(value) {
    return /^\d{4}-\d{2}-\d{2}$/.test(String(value || "").trim());
  }

  function buildSelectedActivitiesLabel(dateStr, labelText) {
    let dateBR = "";
    let weekday = "";

    const rawDate = String(dateStr || "").trim();
    const match = rawDate.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (match) {
      const year = Number(match[1]);
      const month = Number(match[2]);
      const day = Number(match[3]);
      const dt = new Date(year, month - 1, day, 12, 0, 0, 0);
      if (!Number.isNaN(dt.getTime())) {
        dateBR = dt.toLocaleDateString("pt-BR");
        weekday = dt.toLocaleDateString("pt-BR", { weekday: "long" });
      }
    }

    if ((!dateBR || !weekday) && labelText) {
      const parts = String(labelText).split(",");
      if (parts.length >= 2) {
        if (!weekday) weekday = parts[0].trim();
        if (!dateBR) dateBR = parts.slice(1).join(",").trim();
      }
    }

    if (weekday) weekday = weekday.charAt(0).toUpperCase() + weekday.slice(1);
    if (dateBR && weekday) return `Atividades selecionadas para o dia ${dateBR}, ${weekday}`;
    if (dateBR) return `Atividades selecionadas para o dia ${dateBR}`;
    return "Atividades selecionadas";
  }

  NS.openProgramarModal = function openProgramarModal(dateStr, labelText) {
    const modalEl = get(IDS.modal);
    if (!modalEl) return;
    const rows = modalEl.querySelectorAll("#programar-atividadesRow, .cards-row");
    if (rows.length > 1) rows.forEach((row, index) => { if (index > 0) row.remove(); });

    const inputDate = get(IDS.date);
    const titleEl = get(IDS.title);
    const saveBtn = get(IDS.saveBtn);
    const selectedActivitiesSeparator = get(IDS.selectedActivitiesSeparator);

    if (inputDate) inputDate.value = dateStr || "";
    if (titleEl) titleEl.textContent = labelText ? `Programar atividades - ${labelText}` : "Programar atividades";
    if (selectedActivitiesSeparator) {
      selectedActivitiesSeparator.textContent = buildSelectedActivitiesLabel(dateStr, labelText);
    }
    if (saveBtn) saveBtn.disabled = true;

    if (isISODate(dateStr)) {
      document.dispatchEvent(
        new CustomEvent("programar:diaSelecionado", {
          detail: { iso: dateStr, label: labelText || "" },
        })
      );
    }

    NS.loadMetas?.(dateStr);
    NS.loadServidores?.(dateStr);

    if (window.bootstrap) {
      bootstrap.Modal.getOrCreateInstance(modalEl).show();
    }
  };
})();
</script>
