{# templates/programar/scripts/_urls_context.html #}
<script>
(function () {
  const NS = (window.PROGRAMAR = window.PROGRAMAR || {});
  NS.urls = {
    eventsFeed:     "{% url 'programar:events_feed' %}",
    feriadosFeed:   "{% url 'descanso:feriados_feed' %}",
    feriadosPage:   "{% url 'descanso:feriados' %}",
    metas:          "{% url 'programar:metas_disponiveis' %}",
    servidores:     "{% url 'programar:servidores_para_data' %}",
    impedidosMes:   "{% url 'programar:servidores_impedidos_mes' %}",
    salvar:         "{% url 'programar:salvar_programacao' %}",
    programacaoDia: "{% url 'programar:programacao_do_dia' %}",
    excluir:        "{% url 'programar:excluir_programacao' %}",
    plantaoSemana:  "{% url 'plantao:servidores_por_intervalo' %}",
    relatorios:     "{% url 'programar:relatorios_parcial' %}",
    printRelatorioSemana: "{% url 'programar:print_relatorio_semana' %}",
    printRelatorioJustificativas: "{% url 'programar:print_relatorio_justificativas' %}",
    concluirItemBase: "{% url 'programar:concluir-item-form' 0 %}"
  };
  try {
    NS.veiculosAtivos = JSON.parse("{{ VEICULOS_ATIVOS_JSON|escapejs }}") || [];
  } catch (_err) {
    NS.veiculosAtivos = [];
  }
})();
</script>

<script>
(function () {
  window.PROGRAMAR = window.PROGRAMAR || {};
  // se não vier do backend, cai para null (JS null, não string)
  PROGRAMAR.metaExpedienteId = Number("{{ META_EXPEDIENTE_ID|default_if_none:'null'|default:'null' }}") || null;


  // ---------------- DOM helpers ----------------
  const $tbody = () => document.querySelector('#tabelaImpedidos tbody');
  const $badge = () => document.getElementById('countImpedidos');

  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  // ---------------- data detection ----------------
  function ddmmyyyyToIso(s) {
    const m = String(s || '').match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    return m ? `${m[3]}-${m[2]}-${m[1]}` : null;
  }

  function detectarDataDaTela() {
    // prioridade 1: hidden/attr que você pode manter atualizado quando o dia mudar
    const holder = document.querySelector('#programar-data, [data-programar-data]');
    if (holder) {
      const v = holder.value || holder.getAttribute('data-programar-data') || '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
      const iso = ddmmyyyyToIso(v);
      if (iso) return iso;
    }
    // prioridade 2: título da modal "Programar atividades — 17/09/2025"
    const title = document.querySelector('.modal.show .modal-title, .modal .modal-title');
    if (title) {
      const m = title.textContent.match(/(\d{2}\/\d{2}\/\d{4})/);
      if (m) return ddmmyyyyToIso(m[1]);
    }
    // fallback: hoje
    return new Date().toISOString().slice(0, 10);
  }

  // ---------------- fetch + render ----------------
  let _ultimoIso = null; // evita requisições repetidas

  async function carregarServidoresImpedidos(dataISO) {
    try {
      if (!/^\d{4}-\d{2}-\d{2}$/.test(String(dataISO || ''))) {
        console.warn('Data inválida para impedidos:', dataISO);
        return;
      }
      if (_ultimoIso === dataISO && $tbody()?.dataset.rendered === '1') {
        return; // já renderizado para esta data
      }

      const urlBase = window.PROGRAMAR?.urls?.servidores;
      if (!urlBase) {
        console.error('URL programar:servidores_para_data não definida.');
        return;
      }
      const url = new URL(urlBase, window.location.origin);
      url.searchParams.set('data', dataISO);

      _ultimoIso = dataISO;
      if ($tbody()) {
        $tbody().innerHTML = `<tr><td colspan="2" class="text-muted">Carregando…</td></tr>`;
        delete $tbody().dataset.rendered;
      }
      if ($badge()) $badge().textContent = '0';

      const resp = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const json = await resp.json();

      const impedidos = Array.isArray(json.impedidos) ? json.impedidos : [];
      if ($badge()) $badge().textContent = String(impedidos.length);

      if (!impedidos.length) {
        if ($tbody()) {
          $tbody().innerHTML = `<tr><td colspan="2" class="text-muted">Nenhum servidor impedido.</td></tr>`;
          $tbody().dataset.rendered = '1';
        }
        return;
      }

      const rows = impedidos.map(i => {
        const nome = i.nome ?? i.name ?? i.servidor ?? i.servidor_nome ?? '';
        const motivo = i.motivo ?? i.reason ?? i.justificativa ?? '';
        return `<tr><td>${escapeHtml(nome)}</td><td>${escapeHtml(motivo)}</td></tr>`;
      });
      if ($tbody()) {
        $tbody().innerHTML = rows.join('');
        $tbody().dataset.rendered = '1';
      }
    } catch (e) {
      console.error('Falha ao carregar impedidos:', e);
      if ($tbody()) $tbody().innerHTML = `<tr><td colspan="2" class="text-danger">Erro ao carregar a lista.</td></tr>`;
      if ($badge()) $badge().textContent = '0';
    }
  }

  // ---------------- gatilhos ----------------
  function atualizarPelaUI() {
    const iso = detectarDataDaTela();
    carregarServidoresImpedidos(iso);
  }

  // 1) quando a modal abrir (Bootstrap 5)
  document.addEventListener('shown.bs.modal', atualizarPelaUI);

  // 2) quando o app trocar o dia do calendário
  document.addEventListener('programar:diaSelecionado', (e) => {
    const iso = e?.detail?.iso;
    if (iso) carregarServidoresImpedidos(iso);
  });

  // 3) quando o card/tabela for injetado no DOM
  const mo = new MutationObserver((mutations) => {
    for (const m of mutations) {
      for (const node of m.addedNodes) {
        if (!(node instanceof Element)) continue;
        if (node.id === 'tabelaImpedidos' || node.querySelector?.('#tabelaImpedidos')) {
          setTimeout(atualizarPelaUI, 0);
          return;
        }
      }
    }
  });
  mo.observe(document.documentElement, { childList: true, subtree: true });

  // 4) se a tabela já existir no load inicial
  document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('tabelaImpedidos')) {
      atualizarPelaUI();
    }
  });

  // 5) expõe helpers
  window.PROGRAMAR.carregarServidoresImpedidos = carregarServidoresImpedidos;
  window.PROGRAMAR.atualizarImpedidosPelaUI = atualizarPelaUI;
})();
</script>

<script>
(function () {
  const NS = (window.PROGRAMAR = window.PROGRAMAR || {});
  const listEl = () => document.getElementById('programar-impedidos-mes-list');
  const countEl = () => document.getElementById('programar-impedidos-mes-count');
  const emptyEl = () => document.getElementById('programar-impedidos-mes-empty');
  const labelEl = () => document.getElementById('programar-impedidos-mes-label');

  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function formatMesLabel(ym) {
    if (!/^\d{4}-\d{2}$/.test(String(ym || ''))) return '';
    const parts = String(ym).split('-');
    const year = Number(parts[0]);
    const month = Number(parts[1]) - 1;
    const d = new Date(year, month, 1);
    if (Number.isNaN(d.getTime())) return ym;
    try {
      return d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
    } catch (_err) {
      return ym;
    }
  }

  function currentMesFallback() {
    const ref = NS?.calendar?.view?.currentStart;
    const d = (ref instanceof Date) ? ref : new Date();
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    return `${year}-${month}`;
  }

  let _ultimoMes = null;

  async function carregarImpedidosMes(mes) {
    const list = listEl();
    if (!list) return;
    if (!/^\d{4}-\d{2}$/.test(String(mes || ''))) return;
    if (_ultimoMes === mes && list.dataset.rendered === '1') return;

    const urlBase = NS?.urls?.impedidosMes;
    if (!urlBase) return;

    _ultimoMes = mes;
    list.dataset.rendered = '0';
    list.innerHTML = '';
    if (countEl()) countEl().textContent = '0';
    if (emptyEl()) {
      emptyEl().textContent = 'Carregando...';
      emptyEl().classList.remove('d-none');
    }
    if (labelEl()) labelEl().textContent = formatMesLabel(mes);

    try {
      const url = new URL(urlBase, window.location.origin);
      url.searchParams.set('mes', mes);
      const resp = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const json = await resp.json();

      const impedidos = Array.isArray(json.impedidos) ? json.impedidos : [];
      if (!impedidos.length) {
        if (emptyEl()) {
          emptyEl().textContent = 'Nenhum servidor impedido.';
          emptyEl().classList.remove('d-none');
        }
        list.dataset.rendered = '1';
        return;
      }

      const items = impedidos.map((item) => {
        const nome = item?.nome ?? item?.name ?? item?.servidor ?? '';
        const periodos = Array.isArray(item?.periodos) ? item.periodos : [];
        const titulo = periodos.length ? ` title="${escapeHtml(periodos.join('; '))}"` : '';
        const ranges = periodos.map((p) => {
          const raw = String(p || '');
          const m = raw.match(/\((\d{2}\/\d{2}-\d{2}\/\d{2})\)/);
          return m ? m[1] : raw;
        }).filter(Boolean);
        const prefix = ranges.length
          ? `<span class="programar-impedidos-mes-range">${escapeHtml(ranges.join(', '))}</span>`
          : '';
        return `<li${titulo}>${prefix}<span class="programar-impedidos-mes-name">${escapeHtml(nome)}</span></li>`;
      });
      list.innerHTML = items.join('');
      list.dataset.rendered = '1';
      if (countEl()) countEl().textContent = String(impedidos.length);
      if (emptyEl()) emptyEl().classList.add('d-none');
    } catch (err) {
      console.error('Falha ao carregar impedidos do mes:', err);
      if (emptyEl()) {
        emptyEl().textContent = 'Erro ao carregar.';
        emptyEl().classList.remove('d-none');
      }
    }
  }

  document.addEventListener('programar:mesSelecionado', (e) => {
    const mes = e?.detail?.mes;
    if (mes) carregarImpedidosMes(mes);
  });

  document.addEventListener('DOMContentLoaded', () => {
    if (!listEl()) return;
    carregarImpedidosMes(currentMesFallback());
  });

  NS.carregarImpedidosMes = carregarImpedidosMes;
})();
</script>
