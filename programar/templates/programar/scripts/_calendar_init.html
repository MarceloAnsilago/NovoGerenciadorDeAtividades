<script>
document.addEventListener('DOMContentLoaded', function(){
  const NS = (window.PROGRAMAR = window.PROGRAMAR || {});
  const el = document.getElementById('programar-calendar');
  if (!el) return;

  (function ensureCalendarEventStyles() {
    if (document.getElementById('programar-calendar-event-styles')) return;
    const style = document.createElement('style');
    style.id = 'programar-calendar-event-styles';
    style.textContent = `
      .programar-event-lines{display:flex;flex-direction:column;gap:.15rem;font-size:.75rem;line-height:1.1;word-break:break-word;}
      .programar-event-line{white-space:normal;}
    `;
    document.head.appendChild(style);
  })();

  // desabilita botoes de gerar/imprimir ate escolher uma semana
  const printBtns = [
    'programar-btnImprimirProgramacao','btnImprimirProgramacao',
    'programar-btnImprimirJustificativas','btnImprimirJustificativas'
  ].map(id => document.getElementById(id));
  printBtns.forEach(b => { if (b) b.disabled = true; });

  const calendar = new FullCalendar.Calendar(el, {
    locale: 'pt-br',
    timeZone: 'local',
    firstDay: 6,
    height: 'auto',
    headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
    buttonText: { today: 'Hoje' },

    events: NS.urls.eventsFeed,
    eventContent(info) {
      const nomes = info.event.extendedProps?.nomes_atividades;
      const textos = Array.isArray(nomes) ? nomes : [];
      if (!textos.length) {
        return null;
      }
      const container = document.createElement('div');
      container.className = 'programar-event-lines';
      textos.forEach((line) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'programar-event-line';
        lineEl.textContent = line;
        container.appendChild(lineEl);
      });
      return { domNodes: [container] };
    },
    eventClick(info) {
      if (typeof NS.openProgramarModal === 'function') {
        const data = info.event.start;
        if (data instanceof Date) {
          const dataBR = data.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
          NS.openProgramarModal(data.toISOString().slice(0, 10), dataBR);
        }
      }
    },

    // agora so popula o select; NAO chama o relatorio automaticamente
    datesSet(arg){
      window._lastCalendarArg = arg;
      populateWeeksSelect(arg);
      printBtns.forEach(b => { if (b) { delete b.dataset.start; delete b.dataset.end; b.disabled = true; } });
      const cont = document.getElementById('programar-relatoriosContainer');
      if (cont && !cont.__filled) {
        cont.innerHTML = '<div class="alert alert-light border mb-0">Selecione uma semana.</div>';
      }
    },

    dateClick(info){
      if (typeof NS.openProgramarModal === 'function') {
        const dataBR = info.date.toLocaleDateString('pt-BR', { timeZone:'UTC' });
        NS.openProgramarModal(info.dateStr, dataBR);
      }
    }
  });
  calendar.render();

  function isoDate(d){ return d.toISOString().slice(0,10); }
  function prevOrSameSaturday(d){ const x = new Date(d); const sh=(x.getDay()-6+7)%7; x.setDate(x.getDate()-sh); return x; }

  function populateWeeksSelect(arg){
    const select = document.getElementById('programar-select-semana');
    if (!select) return;
    select.innerHTML = '<option value="">Selecione a semana</option>';
    const viewStart = new Date(arg.start), viewEndEx = new Date(arg.end);
    let sat = prevOrSameSaturday(viewStart);
    while (sat < viewEndEx){
      const ini = new Date(sat), fim = new Date(sat); fim.setDate(fim.getDate()+6);
      const opt = document.createElement('option');
      opt.value = isoDate(ini) + '_' + isoDate(fim);
      opt.dataset.inicio = isoDate(ini);
      opt.dataset.fim = isoDate(fim);
      opt.textContent = ini.toLocaleDateString('pt-BR') + ' â†’ ' + fim.toLocaleDateString('pt-BR');
      select.appendChild(opt);
      sat.setDate(sat.getDate()+7);
    }
  }

  // ao selecionar, apenas habilita os botoes e guarda o intervalo; NAO carrega automaticamente
  const semanaSelect = document.getElementById('programar-select-semana');
  if (semanaSelect) {
    semanaSelect.addEventListener('change', function(){
      const opt = this.options[this.selectedIndex];
      const s = opt?.dataset?.inicio, e = opt?.dataset?.fim;
      // apenas repassa o range para os botoes; nao chama loadRelatoriosForRange aqui
      if (s && e) {
        try { NS.periodo = 'semana'; } catch(_) {}
        printBtns.forEach(b => { if (b) { b.disabled = false; b.dataset.start = s; b.dataset.end = e; }});
      } else {
        printBtns.forEach(b => { if (b) { b.disabled = true; delete b.dataset.start; delete b.dataset.end; } });
      }
    });
  }
});
</script>
