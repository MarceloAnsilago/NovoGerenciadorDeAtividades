<script>
document.addEventListener('DOMContentLoaded', function(){
  const NS = window.PROGRAMAR = window.PROGRAMAR || {};
  const el = document.getElementById('programar-calendar');
  if (!el) return;

  // üîí desabilita bot√µes de imprimir at√© que uma semana seja escolhida
  const printBtns = ['programar-btnImprimirProgramacao','programar-btnImprimirVista']
    .map(id => document.getElementById(id));
  printBtns.forEach(b => { if (b) b.disabled = true; });

  const calendar = new FullCalendar.Calendar(el, {
    locale: 'pt-br',
    timeZone: 'local',
    firstDay: 1,
    height: 'auto',
    headerToolbar: { left: 'prev,next today', center: 'title', right: '' },

    events: NS.urls.eventsFeed,

    // ‚úÖ agora: s√≥ popula o select; N√ÉO chama o relat√≥rio automaticamente
    datesSet(arg){
      window._lastCalendarArg = arg;
      populateWeeksSelect(arg);
      // limpa datasets dos bot√µes enquanto nada foi selecionado
      printBtns.forEach(b => {
        if (b) { delete b.dataset.start; delete b.dataset.end; b.disabled = true; }
      });
      // opcional: mostra dica ‚ÄúSelecione uma semana‚Äù
      const cont = document.getElementById('programar-relatoriosContainer');
      if (cont && !cont.__filled) {
        cont.innerHTML = `<div class="alert alert-light border mb-0">Selecione uma semana.</div>`;
      }
    },

    dateClick(info){
      // (o modal continua igual; n√£o mexemos aqui)
      if (typeof NS.openProgramarModal === 'function') {
        const dataBR = info.date.toLocaleDateString('pt-BR', { timeZone:'UTC' });
        NS.openProgramarModal(info.dateStr, dataBR);
      }
    }
  });
  calendar.render();

  // ---- select de semanas (S√°b‚ÜíSex) j√° existente; mantenha seu populateWeeksSelect ----
  function isoDate(d){ return d.toISOString().slice(0,10); }
  function prevOrSameSaturday(d){ const x = new Date(d); const sh=(x.getDay()-6+7)%7; x.setDate(x.getDate()-sh); return x; }

  function populateWeeksSelect(arg){
    const select = document.getElementById('programar-select-semana');
    if (!select) return;
    select.innerHTML = `<option value="">Selecione a semana</option>`;
    const viewStart = new Date(arg.start), viewEndEx = new Date(arg.end);
    let sat = prevOrSameSaturday(viewStart);
    while (sat < viewEndEx){
      const ini = new Date(sat), fim = new Date(sat); fim.setDate(fim.getDate()+6);
      const opt = document.createElement('option');
      opt.value = isoDate(ini) + '_' + isoDate(fim);
      opt.dataset.inicio = isoDate(ini);
      opt.dataset.fim = isoDate(fim);
      opt.textContent = `${ini.toLocaleDateString('pt-BR')} ‚Üí ${fim.toLocaleDateString('pt-BR')}`;
      select.appendChild(opt);
      sat.setDate(sat.getDate()+7);
    }
    // n√£o seleciona nada automaticamente
  }

  // carrega relat√≥rio APENAS quando selecionar
  document.getElementById('programar-select-semana')?.addEventListener('change', function(){
    const opt = this.options[this.selectedIndex];
    const s = opt?.dataset?.inicio, e = opt?.dataset?.fim;
    if (s && e && typeof NS.loadRelatoriosForRange === 'function') {
      NS.loadRelatoriosForRange(s, e).finally(() => {
        // habilita bot√µes com o range escolhido
        printBtns.forEach(b => { if (b) { b.disabled = false; b.dataset.start = s; b.dataset.end = e; }});
        const cont = document.getElementById('programar-relatoriosContainer');
        if (cont) cont.__filled = true;
      });
    } else {
      // se limpar sele√ß√£o, desabilita de novo
      printBtns.forEach(b => { if (b) b.disabled = true; });
    }
  });
});
</script>
