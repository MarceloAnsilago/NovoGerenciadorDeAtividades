<script>
document.addEventListener('DOMContentLoaded', function(){
  const NS = (window.PROGRAMAR = window.PROGRAMAR || {});
  NS.urls = NS.urls || {};
  const el = document.getElementById('programar-calendar');
  if (!el) return;

  const holidayDates = new Set();
  const updateHolidayCells = () => {
    const cells = el.querySelectorAll('[data-date]');
    cells.forEach((cell) => {
      const date = cell.getAttribute('data-date');
      if (!date) return;
      cell.classList.toggle('fc-day-feriado', holidayDates.has(date));
    });
  };

  (function ensureCalendarEventStyles() {
    if (document.getElementById('programar-calendar-event-styles')) return;
    const style = document.createElement('style');
    style.id = 'programar-calendar-event-styles';
    style.textContent = `
      .programar-event{display:flex;flex-direction:column;gap:.35rem;color:#1f2937;}
      .programar-event-status{display:inline-flex;align-items:center;gap:.35rem;font-size:.8rem;font-weight:700;padding:.3rem .55rem;border-radius:.6rem;line-height:1.2;border:1px solid #c8d9f0;background:#edf3ff;color:#0b4f9c;}
      .programar-event-status i{font-size:.95rem;}
      .programar-event-status .programar-event-count{margin-left:auto;font-weight:700;font-variant-numeric:tabular-nums;color:#0b4f9c;}
      .programar-event-counts{margin-left:auto;display:inline-flex;align-items:center;gap:.35rem;font-variant-numeric:tabular-nums;}
      .programar-event-count-badge{display:inline-flex;align-items:center;gap:.25rem;padding:.1rem .4rem;border-radius:.45rem;font-size:.72rem;font-weight:700;border:1px solid transparent;}
      .programar-event-count-badge.is-done{background:#e8f2ff;border-color:#bcd8ff;color:#0b4f9c;}
      .programar-event-count-badge.is-pending{background:#fdecef;border-color:#f5c2c7;color:#842029;}
      .programar-event-status.is-done{background:#e8f2ff;border-color:#bcd8ff;color:#0b4f9c;}
      .programar-event-status.is-done .programar-event-count{color:#0b4f9c;}
      .programar-event-status.is-partial{background:#f1f7eb;border-color:#d5e8b8;color:#3d5c1f;}
      .programar-event-status.is-partial .programar-event-count{color:#3d5c1f;}
      .programar-event-status.is-pending{background:#fdecef;border-color:#f5c2c7;color:#842029;}
      .programar-event-status.is-pending .programar-event-count{color:#842029;}
      .programar-event-lines{display:flex;flex-direction:column;gap:.2rem;font-size:.78rem;line-height:1.15;word-break:break-word;color:#4b5563;}
      .programar-event-line{display:flex;align-items:flex-start;gap:.35rem;white-space:normal;}
      .programar-event-line-icon{margin-top:.05rem;font-size:.85rem;}
      .programar-event-line-icon.is-done{color:#0f5132;}
      .programar-event-line-icon.is-pending{color:#842029;}
      .prog-event-card{border:1px solid #d8e6fb;background:#f7f9fd;border-radius:.65rem;box-shadow:0 1px 4px rgba(15,23,42,.05);}
      .prog-event-card.is-done{background:#eef6ff;border-color:#c6defc;}
      .prog-event-card.is-partial{background:#f7faf2;border-color:#dfecc9;}
      .prog-event-card.is-pending{background:#fff4f5;border-color:#f5c2c7;}
      .prog-event-card .fc-event-main{padding:8px 9px;}
      .prog-event-feriado{border:1px solid #f5c2c7;background:#fff5f5;border-radius:.65rem;box-shadow:0 1px 4px rgba(15,23,42,.05);}
      .programar-event-feriado{display:flex;flex-direction:column;gap:.35rem;color:#842029;min-width:0;}
      .programar-event-feriado .feriado-badge{display:inline-flex;align-items:center;gap:.4rem;font-size:.78rem;font-weight:700;padding:.28rem .55rem;border-radius:.55rem;border:1px solid #f5c2c7;background:#fdecef;color:#842029;}
      .programar-event-feriado .feriado-desc{font-size:.78rem;line-height:1.2;color:#6b1b24;white-space:normal;word-break:break-word;overflow-wrap:anywhere;}
    `;
    document.head.appendChild(style);
  })();

  // desabilita botoes de gerar/imprimir ate escolher uma semana
  const printBtns = [
    'programar-btnImprimirProgramacao','btnImprimirProgramacao',
    'programar-btnImprimirJustificativas','btnImprimirJustificativas'
  ].map(id => document.getElementById(id));
  printBtns.forEach(b => { if (b) b.disabled = true; });

  function computeStatus(props){
    const total = Number(props?.total_programadas || 0);
    const concluidas = Number(props?.total_concluidas || 0);
      const done = total > 0 && concluidas >= total;
      const partial = !done && concluidas > 0;
      const pendentes = Math.max(total - concluidas, 0);
      return {
        key: done ? 'done' : (partial ? 'partial' : 'pending'),
        total,
        concluidas,
        pendentes,
      };
    }

  const eventSources = [];
  if (NS.urls.eventsFeed) eventSources.push({ url: NS.urls.eventsFeed });
  if (NS.urls.feriadosFeed) eventSources.push({ url: NS.urls.feriadosFeed });

  function buildFeriadoRedirectUrl(event) {
    const baseUrl = NS?.urls?.feriadosPage || "/descanso/feriados/";
    if (!baseUrl || !event) return "";
    const start = event.start;
    const iso = (start instanceof Date) ? start.toISOString().slice(0, 10) : (event.startStr || "").slice(0, 10);
    const month = iso ? iso.slice(0, 7) : "";
    const props = event.extendedProps || {};
    const cadastroId = props.cadastro_id ? String(props.cadastro_id).trim() : "";
    const cadastro = cadastroId || (props.cadastro || "").trim()
      || (Array.isArray(props.cadastros) && props.cadastros.length === 1 ? props.cadastros[0] : "");
    const url = new URL(baseUrl, window.location.origin);
    if (cadastro) url.searchParams.set("cadastro", cadastro);
    if (month) url.searchParams.set("mes", month);
    return url.toString();
  }

  const calendar = new FullCalendar.Calendar(el, {
    locale: 'pt-br',
    timeZone: 'local',
    firstDay: 6,
    height: 'auto',
    headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
    buttonText: { today: 'Hoje' },
    eventOrder: '-isHoliday,start',
    eventOrderStrict: true,

    eventSources: eventSources,
    eventSourceFailure(error) {
      console.error('[programar] falha ao carregar eventos:', error);
    },
    eventsSet(events) {
      holidayDates.clear();
      events.forEach((ev) => {
        if (ev?.extendedProps?.kind === 'feriado' && ev?.start) {
          holidayDates.add(ev.start.toISOString().slice(0, 10));
        }
      });
      updateHolidayCells();
    },
    eventContent(info) {
      const props = info.event.extendedProps || {};
      if (props.kind === "feriado") {
        const wrapper = document.createElement('div');
        wrapper.className = 'programar-event-feriado';
        const badge = document.createElement('div');
        badge.className = 'feriado-badge';
        badge.innerHTML = '<i class="bi bi-calendar-heart"></i> Feriado';
        wrapper.appendChild(badge);
        const desc = document.createElement('div');
        desc.className = 'feriado-desc';
        const descricoes = Array.isArray(props.descricoes) ? props.descricoes : null;
        desc.textContent = (props.descricao || (descricoes ? descricoes.join("; ") : "") || info.event.title || "Feriado");
        wrapper.appendChild(desc);
        return { domNodes: [wrapper] };
      }
      const status = computeStatus(props);
      const nomes = props.nomes_atividades;
      const textos = Array.isArray(nomes) ? nomes : [];
      const atividades = Array.isArray(props.atividades) ? props.atividades : [];
      const hasActivityStatus = atividades.some((it) => it && typeof it === "object" && "titulo" in it);

      const statusCfg = {
        done: { label: 'Concluida' },
        partial: { label: 'Em andamento' },
        pending: { label: 'Pendente' },
      }[status.key] || { label: 'Pendente' };

      const wrapper = document.createElement('div');
      wrapper.className = 'programar-event';

      const statusEl = document.createElement('div');
      statusEl.className = `programar-event-status is-${status.key}`;
      const countsHtml = (status.key === "partial")
        ? ""
        : `
          <span class="programar-event-count-badge is-${status.key === "done" ? "done" : "pending"}">${status.total}</span>
        `;

      statusEl.innerHTML = `
        <span>${statusCfg.label}</span>
        ${countsHtml}
      `;
      wrapper.appendChild(statusEl);

      const container = document.createElement('div');
      container.className = 'programar-event-lines';
      const linhas = hasActivityStatus ? atividades : (textos.length ? textos : [info.event.title || 'Atividades']);
      linhas.forEach((line) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'programar-event-line';
        if (hasActivityStatus && line && typeof line === "object") {
          const done = Boolean(line.concluido);
          const icon = document.createElement('i');
          icon.className = `bi ${done ? "bi-check-circle-fill" : "bi-x-circle-fill"} programar-event-line-icon ${done ? "is-done" : "is-pending"}`;
          lineEl.appendChild(icon);
          const textEl = document.createElement('span');
          const qty = Number(line.quantidade || 0);
          const suffix = qty > 1 ? ` (${qty})` : "";
          textEl.textContent = (line.titulo || 'Atividade') + suffix;
          lineEl.appendChild(textEl);
        } else {
          lineEl.textContent = line;
        }
        container.appendChild(lineEl);
      });
      wrapper.appendChild(container);

      return { domNodes: [wrapper] };
    },
    eventClassNames(arg){
      if (arg.event.extendedProps?.kind === "feriado") {
        return ["prog-event-feriado"];
      }
      const status = computeStatus(arg.event.extendedProps || {});
      return ['prog-event-card', `is-${status.key}`];
    },
    eventDidMount(info) {
      if (info.event.extendedProps?.kind !== "feriado") return;
      const url = buildFeriadoRedirectUrl(info.event);
      if (!url) return;
      info.el.style.cursor = "pointer";
      info.el.addEventListener("click", (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        window.location.href = url;
      });
    },
    eventClick(info) {
      const props = info.event.extendedProps || {};
      if (props.kind === "feriado") {
        const url = buildFeriadoRedirectUrl(info.event);
        if (url) window.location.href = url;
        return;
      }
      if (typeof NS.openProgramarModal === 'function') {
        const data = info.event.start;
        if (data instanceof Date) {
          const dataBR = data.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
          NS.openProgramarModal(data.toISOString().slice(0, 10), dataBR);
        }
      }
    },

    // agora so popula o select; NAO chama o relatorio automaticamente
    datesSet(arg){
      window._lastCalendarArg = arg;
      populateWeeksSelect(arg);
      printBtns.forEach(b => { if (b) { delete b.dataset.start; delete b.dataset.end; b.disabled = true; } });
      const cont = document.getElementById('programar-relatoriosContainer');
      if (cont && !cont.__filled) {
        cont.innerHTML = '<div class="alert alert-light border mb-0">Selecione uma semana.</div>';
      }
    },

    dateClick(info){
      if (typeof NS.openProgramarModal === 'function') {
        const dataBR = info.date.toLocaleDateString('pt-BR', { timeZone:'UTC' });
        NS.openProgramarModal(info.dateStr, dataBR);
      }
    }
  });
  calendar.render();
  NS.calendar = calendar;

  function refreshCalendarEvents() {
    if (!calendar || typeof calendar.refetchEvents !== 'function') return;
    calendar.refetchEvents();
  }
  NS.refreshCalendarEvents = refreshCalendarEvents;
  document.addEventListener('programar:saved', refreshCalendarEvents);
  document.addEventListener('programar:deleted', refreshCalendarEvents);

  function isoDate(d){ return d.toISOString().slice(0,10); }
  function prevOrSameSaturday(d){ const x = new Date(d); const sh=(x.getDay()-6+7)%7; x.setDate(x.getDate()-sh); return x; }

  function populateWeeksSelect(arg){
    const select = document.getElementById('programar-select-semana');
    if (!select) return;
    select.innerHTML = '<option value="">Selecione a semana</option>';
    const viewStart = new Date(arg.start), viewEndEx = new Date(arg.end);
    let sat = prevOrSameSaturday(viewStart);
    while (sat < viewEndEx){
      const ini = new Date(sat), fim = new Date(sat); fim.setDate(fim.getDate()+6);
      const opt = document.createElement('option');
      opt.value = isoDate(ini) + '_' + isoDate(fim);
      opt.dataset.inicio = isoDate(ini);
      opt.dataset.fim = isoDate(fim);
      opt.textContent = ini.toLocaleDateString('pt-BR') + ' â†’ ' + fim.toLocaleDateString('pt-BR');
      select.appendChild(opt);
      sat.setDate(sat.getDate()+7);
    }
  }

  // ao selecionar, apenas habilita os botoes e guarda o intervalo; NAO carrega automaticamente
  const semanaSelect = document.getElementById('programar-select-semana');
  if (semanaSelect) {
    semanaSelect.addEventListener('change', function(){
      const opt = this.options[this.selectedIndex];
      const s = opt?.dataset?.inicio, e = opt?.dataset?.fim;
      // apenas repassa o range para os botoes; nao chama loadRelatoriosForRange aqui
      if (s && e) {
        try { NS.periodo = 'semana'; } catch(_) {}
        printBtns.forEach(b => { if (b) { b.disabled = false; b.dataset.start = s; b.dataset.end = e; }});
      } else {
        printBtns.forEach(b => { if (b) { b.disabled = true; delete b.dataset.start; delete b.dataset.end; } });
      }
    });
  }
});
</script>
