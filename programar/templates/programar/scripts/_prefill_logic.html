<script>
(function () {
  const NS = window.PROGRAMAR = window.PROGRAMAR || {};
  if (NS._prefillBound) return;
  NS._prefillBound = true;
  NS._prefillOverride = true;

  // ==== COOPERAO COM O LOADER ====
  // loader s pode semear o expediente quando estas flags indicarem que NO existe programao salva
  NS._allowExpedienteFromLivres = true;   // default: pode semear
  NS._hasPrefilledExpediente    = false;  // ser true se o expediente veio do banco

  const DEBUG = false;
  NS._prefillRunId = NS._prefillRunId || 0;

  // ---------- helpers ----------
  function isISODate(value) {
    return /^\d{4}-\d{2}-\d{2}$/.test(String(value || "").trim());
  }

  function getModalSelectedDate() {
    return String(document.getElementById("programar-dataAtividade")?.value || "").trim();
  }

  function resolveCurrentPrefillDate() {
    const active = getModalSelectedDate();
    if (isISODate(active)) return active;
    const last = String(NS._lastPrefill?.date || "").trim();
    return isISODate(last) ? last : "";
  }

  function isStalePrefill(runId, requestedDate) {
    if (NS._prefillRunId !== runId) return true;
    const activeDate = getModalSelectedDate();
    if (isISODate(activeDate) && activeDate !== requestedDate) return true;
    return false;
  }

  function waitFor(testFn, timeout = 6000, step = 50){
    return new Promise((resolve, reject)=>{
      const t0 = Date.now();
      (function loop(){
        if (testFn()) return resolve(true);
        if (Date.now() - t0 > timeout) return reject(new Error('waitFor timeout'));
        setTimeout(loop, step);
      })();
    });
  }

  async function waitForMetasGridReady(timeout = 5000) {
    const hasGrid = () => !!document.getElementById("metasGrid");
    if (!hasGrid()) return;
    try {
      await waitFor(() => {
        const grid = document.getElementById("metasGrid");
        if (!grid) return true;
        return !grid.querySelector(".placeholder-glow");
      }, timeout, 60);
    } catch (_) {}
  }

  function metaInfoFromGrid(metaId, fallbackTitle) {
    const card = document.querySelector(`#metasGrid [data-id="${metaId}"]`);
    const n = card?.querySelector(".meta-title");
    const fallbackRaw = String(fallbackTitle || "").trim();
    const normalizedFallback = fallbackRaw.toLowerCase().replace(/\s+/g, " ");
    const normalizedMetaId = String(metaId || "").toLowerCase();
    const fallbackIsOnlyNumericMeta =
      normalizedFallback === `meta #${normalizedMetaId}` ||
      normalizedFallback === `meta ${normalizedMetaId}`;
    const fallback = fallbackIsOnlyNumericMeta ? "" : fallbackRaw;
    return {
      title: (n && n.textContent.trim()) || fallback || "Atividade",
      descricao: (card?.dataset?.metaDescricao || "").trim(),
    };
  }

  // pega o chip no catlogo
  function getCatalogChip(id){
    return document.querySelector(`#servidoresLivres [data-id="${id}"], #servidoresLivres [data-servidor-id="${id}"]`);
  }

  // garante um chip (cpia) no destino SEM retirar do catlogo
  function ensureChipIn(target, id, nomeFallback){
    if (!target) return false;
    if (target.querySelector(`[data-id="${id}"], [data-servidor-id="${id}"]`)) return true;

    const src = getCatalogChip(id);

    const updateCounts = NS.updateCounts || window.ProgramarCards?.updateCounts || function(){};
    const isExpediente = target.id === 'expedienteAdmin' || target.matches?.('#expedienteAdmin, .js-expediente-admin');
    const name = (nomeFallback || src?.querySelector?.('.srv-name')?.textContent || src?.textContent || `Servidor ${id}`).trim();

    if (isExpediente) {
      const card = document.createElement('div');
      card.className = 'servidor-card';
      card.dataset.id = String(id);
      card.setAttribute('draggable','true');
      card.innerHTML = `
        <span class="srv-icon"><i class="bi bi-person-fill"></i></span>
        <span class="srv-name">${name}</span>
        <span class="srv-count-badge"></span>`;

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'srv-close btn btn-sm btn-outline-secondary';
      btn.title = 'Remover do Expediente';
      btn.textContent = 'x';
      btn.style.marginLeft = 'auto';
      card.style.display = 'flex';
      card.style.alignItems = 'center';
      card.style.gap = '6px';
      card.appendChild(btn);

      btn.addEventListener('click', () => {
        const pool = document.getElementById('servidoresLivres');
        if (pool && !pool.querySelector(`.servidor-card[data-id="${id}"]`)) {
          const novo = document.createElement('div');
          novo.className = 'servidor-card';
          novo.dataset.id = String(id);
          novo.setAttribute('draggable','true');
          novo.innerHTML = `
            <span class="srv-icon"><i class="bi bi-person-fill"></i></span>
            <span class="srv-name">${name}</span>
            <span class="srv-count-badge"></span>`;
          pool.appendChild(novo);
        }
        card.remove();
        updateCounts();
      });

      target.appendChild(card);
      updateCounts();
      return true;
    }

    const chip = document.createElement('div');
    chip.className = 'servidor-chip';
    chip.dataset.id = String(id);
    chip.innerHTML = `
      <span class="chip-icon"><i class="bi bi-person-fill"></i></span>
      <span class="chip-name">${name}</span>
      <button type="button" class="chip-remove" title="Remover">&times;</button>`;

    chip.querySelector('.chip-remove')?.addEventListener('click', (ev) => {
      ev.preventDefault();
      chip.remove();
      updateCounts();
    });

    target.appendChild(chip);
    updateCounts();
    return true;
  }
  NS.ensureChipIn = ensureChipIn;

  // limpa todas alocaes visuais (no mexe no catlogo)
  function resetAllocations(opts){
    const options = opts || {};
    const container = document.getElementById('metaCardsContainer');
    const cards = container ? Array.from(container.querySelectorAll('[data-meta-id]')) : [];
    cards.forEach(card => {
      if (options.keepCards) {
        delete card.dataset.itemId;
        window.PROGRAMAR?.syncMetaConclusionLink?.(card);
        const drop = card.querySelector('.meta-dropzone') || card;
        if (drop) drop.innerHTML = '';
      } else {
        try { card.remove(); } catch (_) {}
      }
    });
    const expEl = document.getElementById('expedienteAdmin');
    if (expEl && !options.skipExpediente){
      delete expEl.dataset.itemId;
      expEl.removeAttribute('data-lock');
      expEl.innerHTML = '';
    }
    try { (NS.updateCounts || window.ProgramarCards?.updateCounts || function(){})(); } catch (_){}
  }
  NS.resetAllocations = resetAllocations;

  // guarda ltimo prefill
  NS._lastPrefill = { date: null, itens: [] };

  // ---------- PREFILL ----------
  NS.prefillProgramacaoDia = async function prefillProgramacaoDia(dateStr){
    const requestedDate = String(dateStr || "").trim();
    const urlBase = NS.urls?.programacaoDia;
    if (!urlBase || !isISODate(requestedDate)) return;
    const runId = (Number(NS._prefillRunId) || 0) + 1;
    NS._prefillRunId = runId;

    // containers base
    try { await waitFor(() => document.getElementById('metaCardsContainer') && document.getElementById('servidoresLivres')); } catch {}
    if (isStalePrefill(runId, requestedDate)) return;

    // busca programao do dia
    const url = new URL(urlBase, window.location.origin);
    url.searchParams.set('data', requestedDate);

    let itens = [];
    try{
      const resp = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
      if (!resp.ok) return;
      const data = await resp.json().catch(()=> ({}));
      itens = Array.isArray(data?.itens) ? data.itens : [];
    }catch{ return; }
    if (isStalePrefill(runId, requestedDate)) return;

    NS._lastPrefill = { date: requestedDate, itens };

    // sempre limpa
    resetAllocations({ skipExpediente: itens.length === 0 });
    if (isStalePrefill(runId, requestedDate)) return;

    // por padro, permite semear; caso venham itens, bloqueia
    NS._allowExpedienteFromLivres = itens.length === 0;
    NS._hasPrefilledExpediente    = false;

    if (!itens.length){
      // nada salvo  apenas atualiza contadores e sai (loader poder semear expediente)
      (NS.updateCounts || window.ProgramarCards?.updateCounts || function(){})();
      try { NS.refreshExpedienteFromLivres?.(); } catch (_) {}
      NS._obsDirty = false;
      document.dispatchEvent(new CustomEvent('programar:prefilled', { detail:{ data: requestedDate, count: 0 }}));
      return;
    }

    await waitForMetasGridReady();
    if (isStalePrefill(runId, requestedDate)) return;

    const expEl = document.getElementById('expedienteAdmin');
    const expId = Number(expEl?.dataset.metaId || NS.metaExpedienteId || 0);

    const ordered = [...itens].sort((a, b) => {
      const av = a?.veiculo_id != null;
      const bv = b?.veiculo_id != null;
      if (av !== bv) return av ? 1 : -1;
      return (b?.id || 0) - (a?.id || 0);
    });

    for (const it of ordered){
      // Expediente administrativo: CLONA chips do catlogo
      if (expId && Number(it.meta_id) === expId){
      const nomesExp = new Map((it.servidores || []).map(s => [String(s.id), s.nome]));
      if (expEl){
        expEl.setAttribute('data-lock', '1');   // travado contra semeadura do loader
        if (it.id) expEl.dataset.itemId = String(it.id);
        (it.servidores_ids || []).forEach(sid => ensureChipIn(expEl, sid, nomesExp.get(String(sid))));
        NS._hasPrefilledExpediente = true;
      }
      continue;
    }

    // Demais metas
    const metaInfo = metaInfoFromGrid(it.meta_id, it.titulo);
    const title = metaInfo.title;
    let card = null;
    if (it.id) {
      card = document.querySelector(`#metaCardsContainer [data-meta-id="${it.meta_id}"][data-item-id="${it.id}"]`);
    }
    if (!card) {
      const existingCount = document.querySelectorAll(`#metaCardsContainer [data-meta-id="${it.meta_id}"]`).length;
      const opts = existingCount > 0
        ? { forceNew: true, metaDescricao: metaInfo.descricao }
        : { metaDescricao: metaInfo.descricao };
      card = NS.ensureMetaCard?.(String(it.meta_id), title, opts) || document.querySelector(`#metaCardsContainer [data-meta-id="${it.meta_id}"]`);
    }
    if (!card) continue;

    if (it.id) {
      card.dataset.itemId = String(it.id);
    } else {
      delete card.dataset.itemId;
    }
    card.dataset.concluido = it.concluido ? "true" : "false";
    window.PROGRAMAR?.syncMetaConclusionLink?.(card);

    const ta = card.querySelector('textarea[name="observacao"]');
    if (ta) ta.value = it.observacao || '';
    window.PROGRAMAR?.syncObsIndicator?.(card);

    const sel = card.querySelector('select[name="card_veiculos"], select.card-veiculos, [data-veiculo-id]');
    if (sel && it.veiculo_id != null) {
      if (sel.tagName === 'SELECT') sel.value = String(it.veiculo_id);
      else sel.dataset.veiculoId = String(it.veiculo_id);
    }

      const drop = card.querySelector('.meta-dropzone') || card;
      const nomes = new Map((it.servidores || []).map(s => [String(s.id), s.nome]));
      (it.servidores_ids || []).forEach(sid => ensureChipIn(drop, sid, nomes.get(String(sid))));
      if (isStalePrefill(runId, requestedDate)) return;
  }

    if (isStalePrefill(runId, requestedDate)) return;
    try { NS.refreshExpedienteFromLivres?.(); } catch (_) {}
    (NS.updateCounts || window.ProgramarCards?.updateCounts || function(){})();
    NS._obsDirty = false;
    document.dispatchEvent(new CustomEvent('programar:prefilled', { detail:{ data: requestedDate, count: itens.length }}));
    if (DEBUG) console.debug('[prefill] aplicado', itens.length, 'itens');
  };

  // reaplica assim que o catlogo terminar de carregar
  const moLate = new MutationObserver(() => {
    const targetDate = resolveCurrentPrefillDate();
    if (!targetDate) return;
    const hasCatalog = !!document.querySelector('#servidoresLivres [data-id], #servidoresLivres [data-servidor-id]');
    if (!hasCatalog) return;
    moLate.disconnect();
    NS.prefillProgramacaoDia(targetDate);
  });
  moLate.observe(document.getElementById('servidoresLivres') || document.body, { childList:true, subtree:true });

  // evento que o loader deve disparar quando terminar de montar o catlogo
  document.addEventListener('programar:servidoresLoaded', () => {
    const targetDate = resolveCurrentPrefillDate();
    if (targetDate) NS.prefillProgramacaoDia(targetDate);
  });

  // ao abrir a modal: destrava e busca programao
  document.addEventListener('shown.bs.modal', (ev) => {
    if (ev.target && ev.target.id === 'programar-modalAtividade'){
      const expEl = document.getElementById('expedienteAdmin');
      if (expEl) expEl.removeAttribute('data-lock');
      NS._hasPrefilledExpediente = false;
      NS._allowExpedienteFromLivres = true;

      const dateStr = document.getElementById('programar-dataAtividade')?.value;
      if (dateStr) NS.prefillProgramacaoDia(dateStr);
    }
  });

  // ao trocar de dia (se o app emite esse evento)
  document.addEventListener('programar:diaSelecionado', () => {
    const expEl = document.getElementById('expedienteAdmin');
    if (expEl) expEl.removeAttribute('data-lock');
    NS._hasPrefilledExpediente = false;
    NS._allowExpedienteFromLivres = true;
  });

})();
</script>
