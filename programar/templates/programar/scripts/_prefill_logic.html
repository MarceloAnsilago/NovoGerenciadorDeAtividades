<script>
(function () {
  const NS = window.PROGRAMAR = window.PROGRAMAR || {};
  if (NS._prefillBound) return;
  NS._prefillBound = true;
  NS._prefillOverride = true;

  // ==== COOPERAO COM O LOADER ====
  // loader s pode semear o expediente quando estas flags indicarem que NO existe programao salva
  NS._allowExpedienteFromLivres = true;   // default: pode semear
  NS._hasPrefilledExpediente    = false;  // ser true se o expediente veio do banco

  const DEBUG = false;

  // ---------- helpers ----------
  function waitFor(testFn, timeout = 6000, step = 50){
    return new Promise((resolve, reject)=>{
      const t0 = Date.now();
      (function loop(){
        if (testFn()) return resolve(true);
        if (Date.now() - t0 > timeout) return reject(new Error('waitFor timeout'));
        setTimeout(loop, step);
      })();
    });
  }

  function metaTitleFromGrid(metaId) {
    const n = document.querySelector(`#metasGrid [data-id="${metaId}"] .meta-title`);
    return (n && n.textContent.trim()) || `Meta ${metaId}`;
  }

  // pega o chip no catlogo
  function getCatalogChip(id){
    return document.querySelector(`#servidoresLivres [data-id="${id}"], #servidoresLivres [data-servidor-id="${id}"]`);
  }

  // garante um chip (cpia) no destino SEM retirar do catlogo
  function ensureChipIn(target, id, nomeFallback){
    if (!target) return false;
    if (target.querySelector(`[data-id="${id}"], [data-servidor-id="${id}"]`)) return true;

    const src = getCatalogChip(id);

    const updateCounts = NS.updateCounts || window.ProgramarCards?.updateCounts || function(){};
    const isExpediente = target.id === 'expedienteAdmin' || target.matches?.('#expedienteAdmin, .js-expediente-admin');
    const name = (nomeFallback || src?.querySelector?.('.srv-name')?.textContent || src?.textContent || `Servidor ${id}`).trim();

    if (isExpediente) {
      const card = document.createElement('div');
      card.className = 'servidor-card';
      card.dataset.id = String(id);
      card.setAttribute('draggable','true');
      card.innerHTML = `
        <span class="srv-icon"><i class="bi bi-person-fill"></i></span>
        <span class="srv-name">${name}</span>
        <span class="srv-count-badge"></span>`;

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'srv-close btn btn-sm btn-outline-secondary';
      btn.title = 'Remover do Expediente';
      btn.textContent = 'x';
      btn.style.marginLeft = 'auto';
      card.style.display = 'flex';
      card.style.alignItems = 'center';
      card.style.gap = '6px';
      card.appendChild(btn);

      btn.addEventListener('click', () => {
        const pool = document.getElementById('servidoresLivres');
        if (pool && !pool.querySelector(`.servidor-card[data-id="${id}"]`)) {
          const novo = document.createElement('div');
          novo.className = 'servidor-card';
          novo.dataset.id = String(id);
          novo.setAttribute('draggable','true');
          novo.innerHTML = `
            <span class="srv-icon"><i class="bi bi-person-fill"></i></span>
            <span class="srv-name">${name}</span>
            <span class="srv-count-badge"></span>`;
          pool.appendChild(novo);
        }
        card.remove();
        updateCounts();
      });

      target.appendChild(card);
      updateCounts();
      return true;
    }

    const chip = document.createElement('div');
    chip.className = 'servidor-chip';
    chip.dataset.id = String(id);
    chip.innerHTML = `
      <span class="chip-icon"><i class="bi bi-person-fill"></i></span>
      <span class="chip-name">${name}</span>
      <button type="button" class="chip-remove" title="Remover">&times;</button>`;

    chip.querySelector('.chip-remove')?.addEventListener('click', (ev) => {
      ev.preventDefault();
      chip.remove();
      updateCounts();
    });

    target.appendChild(chip);
    updateCounts();
    return true;
  }
  NS.ensureChipIn = ensureChipIn;

  // limpa todas alocaes visuais (no mexe no catlogo)
  function resetAllocations(opts){
    const options = opts || {};
    document.querySelectorAll('#metaCardsContainer [data-meta-id]').forEach(card => {
      delete card.dataset.itemId;
      const drop = card.querySelector('.meta-dropzone') || card;
      drop.innerHTML = '';
    });
    const expEl = document.getElementById('expedienteAdmin');
    if (expEl && !options.skipExpediente){
      delete expEl.dataset.itemId;
      expEl.removeAttribute('data-lock');
      expEl.innerHTML = '';
    }
  }
  NS.resetAllocations = resetAllocations;

  // guarda ltimo prefill
  NS._lastPrefill = { date: null, itens: [] };

  // ---------- PREFILL ----------
  NS.prefillProgramacaoDia = async function prefillProgramacaoDia(dateStr){
    const urlBase = NS.urls?.programacaoDia;
    if (!urlBase || !dateStr) return;

    // containers base
    try { await waitFor(() => document.getElementById('metaCardsContainer') && document.getElementById('servidoresLivres')); } catch {}

    // busca programao do dia
    const url = new URL(urlBase, window.location.origin);
    url.searchParams.set('data', dateStr);

    let itens = [];
    try{
      const resp = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
      if (!resp.ok) return;
      const data = await resp.json().catch(()=> ({}));
      itens = Array.isArray(data?.itens) ? data.itens : [];
    }catch{ return; }

    NS._lastPrefill = { date: dateStr, itens };

    // sempre limpa
    resetAllocations({ skipExpediente: itens.length === 0 });

    // por padro, permite semear; caso venham itens, bloqueia
    NS._allowExpedienteFromLivres = itens.length === 0;
    NS._hasPrefilledExpediente    = false;

    if (!itens.length){
      // nada salvo  apenas atualiza contadores e sai (loader poder semear expediente)
      (NS.updateCounts || window.ProgramarCards?.updateCounts || function(){})();
      document.dispatchEvent(new CustomEvent('programar:prefilled', { detail:{ data: dateStr, count: 0 }}));
      return;
    }

    const expEl = document.getElementById('expedienteAdmin');
    const expId = Number(expEl?.dataset.metaId || NS.metaExpedienteId || 0);

    const ordered = [...itens].sort((a, b) => {
      const av = a?.veiculo_id != null;
      const bv = b?.veiculo_id != null;
      if (av !== bv) return av ? 1 : -1;
      return (b?.id || 0) - (a?.id || 0);
    });

    for (const it of ordered){
      // Expediente administrativo: CLONA chips do catlogo
      if (expId && Number(it.meta_id) === expId){
      const nomesExp = new Map((it.servidores || []).map(s => [String(s.id), s.nome]));
      if (expEl){
        expEl.setAttribute('data-lock', '1');   // travado contra semeadura do loader
        if (it.id) expEl.dataset.itemId = String(it.id);
        (it.servidores_ids || []).forEach(sid => ensureChipIn(expEl, sid, nomesExp.get(String(sid))));
        NS._hasPrefilledExpediente = true;
      }
      continue;
    }

    // Demais metas
    const title = metaTitleFromGrid(it.meta_id);
    const card  = NS.ensureMetaCard?.(String(it.meta_id), title) || document.querySelector(`#metaCardsContainer [data-meta-id="${it.meta_id}"]`);
    if (!card) continue;

    if (it.id) card.dataset.itemId = String(it.id);

    const ta = card.querySelector('textarea[name="observacao"]');
    if (ta) ta.value = it.observacao || '';

    const sel = card.querySelector('select[name="card_veiculos"], select.card-veiculos, [data-veiculo-id]');
    if (sel && it.veiculo_id != null) {
      if (sel.tagName === 'SELECT') sel.value = String(it.veiculo_id);
      else sel.dataset.veiculoId = String(it.veiculo_id);
    }

    const drop = card.querySelector('.meta-dropzone') || card;
    const nomes = new Map((it.servidores || []).map(s => [String(s.id), s.nome]));
    (it.servidores_ids || []).forEach(sid => ensureChipIn(drop, sid, nomes.get(String(sid))));
  }

    (NS.updateCounts || window.ProgramarCards?.updateCounts || function(){})();
    document.dispatchEvent(new CustomEvent('programar:prefilled', { detail:{ data: dateStr, count: itens.length }}));
    if (DEBUG) console.debug('[prefill] aplicado', itens.length, 'itens');
  };

  // reaplica assim que o catlogo terminar de carregar
  const moLate = new MutationObserver(() => {
    if (!NS._lastPrefill?.date) return;
    const hasCatalog = !!document.querySelector('#servidoresLivres [data-id], #servidoresLivres [data-servidor-id]');
    if (!hasCatalog) return;
    moLate.disconnect();
    NS.prefillProgramacaoDia(NS._lastPrefill.date);
  });
  moLate.observe(document.getElementById('servidoresLivres') || document.body, { childList:true, subtree:true });

  // evento que o loader deve disparar quando terminar de montar o catlogo
  document.addEventListener('programar:servidoresLoaded', () => {
    if (NS._lastPrefill?.date) NS.prefillProgramacaoDia(NS._lastPrefill.date);
  });

  // ao abrir a modal: destrava e busca programao
  document.addEventListener('shown.bs.modal', (ev) => {
    if (ev.target && ev.target.id === 'programar-modalAtividade'){
      const expEl = document.getElementById('expedienteAdmin');
      if (expEl) expEl.removeAttribute('data-lock');
      NS._hasPrefilledExpediente = false;
      NS._allowExpedienteFromLivres = true;

      const dateStr = document.getElementById('programar-dataAtividade')?.value;
      if (dateStr) NS.prefillProgramacaoDia(dateStr);
    }
  });

  // ao trocar de dia (se o app emite esse evento)
  document.addEventListener('programar:diaSelecionado', () => {
    const expEl = document.getElementById('expedienteAdmin');
    if (expEl) expEl.removeAttribute('data-lock');
    NS._hasPrefilledExpediente = false;
    NS._allowExpedienteFromLivres = true;
  });

})();
</script>
