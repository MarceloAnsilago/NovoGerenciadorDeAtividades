<script>
(function(){
  const NS = (window.PROGRAMAR = window.PROGRAMAR || {});
  NS.periodo = NS.periodo || 'semana';
  NS.reportMode = NS.reportMode || 'all';
  const DEBUG = true;

  function setLoading(container){
    container.innerHTML = `
      <div class="text-center my-4">
        <div class="spinner-border" role="status" aria-hidden="true"></div>
        <div class="small text-muted mt-2">Carregando relatório…</div>
      </div>`;
  }

  function showError(container, msg){
    container.innerHTML = `<div class="alert alert-danger mb-0">${msg || 'Erro ao carregar relatórios.'}</div>`;
  }

  function injectRelatorioToolbar(){
    try{
      const area = document.querySelector('#relatorioPrintArea .card-body') || document.querySelector('#relatorioPrintArea');
      if (!area || area.querySelector('#relatorio-toolbar')) return;
      const div = document.createElement('div');
      div.id = 'relatorio-toolbar';
      div.className = 'd-flex justify-content-end mb-2 no-print';
      div.innerHTML = '<div class="btn-group btn-group-sm"><button id="relatorio-btn-print" class="btn btn-outline-secondary">Imprimir</button></div>';
      area.insertBefore(div, area.firstChild);
    }catch(_e){}
  }

  NS.loadRelatoriosForRange = async function(startISO, endISO){
    const container = document.getElementById('programar-relatoriosContainer');
    if (!container) return;
    if (!NS.urls || !NS.urls.relatorios){ showError(container, 'Endpoint de relatórios não configurado.'); return; }

    setLoading(container);
    delete container.dataset.start; delete container.dataset.end;
    delete container.dataset.mode;

    let url = `${NS.urls.relatorios}?start=${encodeURIComponent(startISO)}&end=${encodeURIComponent(endISO)}`;
    try{
      const mode = String(NS.reportMode||'all').toLowerCase();
      if (mode === 'just-only') url += '&only_just=1';
      else if (mode === 'programacao-only') url += '&hide_just=1';
    }catch(_e){}
    if (DEBUG) console.info('[programar] fetch relatorios:', url);

    try{
      const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!resp.ok){ showError(container, `Erro ao gerar relatório (HTTP ${resp.status}).`); return; }
      const ctype = (resp.headers.get('content-type')||'').toLowerCase();
      if (ctype.includes('application/json')){
        const data = await resp.json().catch(()=>null);
        if (data && typeof data.html === 'string'){ container.innerHTML = data.html; injectRelatorioToolbar(); }
        else { showError(container, 'Resposta JSON inválida do servidor.'); return; }
      } else {
        const html = await resp.text();
        container.innerHTML = html || `<div class="alert alert-danger">Resposta vazia do servidor.</div>`;
        injectRelatorioToolbar();
      }

      try{
        const mode = String(NS.reportMode || 'all').toLowerCase();
        ['programar-btnImprimirProgramacao','btnImprimirProgramacao','programar-btnImprimirJustificativas','btnImprimirJustificativas'].forEach(id=>{
          const b=document.getElementById(id); if (b){ b.dataset.start=startISO; b.dataset.end=endISO; b.disabled=false; }
        });
        container.dataset.start = startISO; container.dataset.end = endISO;
        container.dataset.mode = mode;
      }catch(e){ if (DEBUG) console.warn('dataset fail', e); }

    }catch(err){
      if (DEBUG) console.error('[programar] relatorios fetch error', err);
      showError(container, 'Erro ao carregar relatórios.');
    }
  };

  function isoDate(d){
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function monthRangeFromCalendar(){
    try{
      const arg = window._lastCalendarArg;
      const view = arg?.view;
      if (view?.currentStart && view?.currentEnd){
        const start = new Date(view.currentStart);
        const end = new Date(view.currentEnd);
        end.setDate(end.getDate() - 1);
        if (end < start){
          end.setTime(start.getTime());
        }
        return { start, end };
      }
    }catch(_e){}
    return null;
  }

  function fallbackMonthRange(){
    const today = new Date();
    const start = new Date(today.getFullYear(), today.getMonth(), 1);
    const end = new Date(today.getFullYear(), today.getMonth()+1, 0);
    return { start, end };
  }

  // Botão opcional: Imprimir mês (gera relatório do mês na tela)
  document.addEventListener('click', function(ev){
    const btn = ev.target.closest?.('#programar-btnImprimirMes');
    if (!btn) return;
    ev.preventDefault();
    try{
      const range = monthRangeFromCalendar() || fallbackMonthRange();
      NS.reportMode = 'programacao-only';
      NS.loadRelatoriosForRange(isoDate(range.start), isoDate(range.end));
    }catch(_e){}
  });
})();
</script>
