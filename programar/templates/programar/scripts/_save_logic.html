<script>
(function () {
  // Namespace
  const NS = window.PROGRAMAR = window.PROGRAMAR || {};
  if (NS._saveLogicLoaded) return;
  NS._saveLogicLoaded = true;

  // ---------- CSRF ----------
  function getCookie(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? decodeURIComponent(parts.pop().split(';').shift()) : null;
  }
  const CSRF = getCookie('csrftoken');

  // ---------- Toast (com fallback) ----------
  NS.toast = NS.toast || function(message, opts = {}) {
    const { variant = 'success', title = null, delay = 3500 } = opts;
    if (window.bootstrap?.Toast) {
      let cont = document.getElementById('toast-stack');
      if (!cont) {
        cont = document.createElement('div');
        cont.id = 'toast-stack';
        cont.className = 'toast-container position-fixed top-0 end-0 p-3';
        cont.style.zIndex = 1080;
        document.body.appendChild(cont);
      }
      const el = document.createElement('div');
      el.className = `toast text-bg-${variant} border-0`;
      el.setAttribute('role','alert');
      el.setAttribute('aria-live','assertive');
      el.setAttribute('aria-atomic','true');
      el.innerHTML = `
        <div class="toast-header border-0">
          <strong class="me-auto">${title ?? (variant === 'success' ? 'Sucesso' : 'Aviso')}</strong>
          <small class="text-white-50">agora</small>
          <button type="button" class="btn-close btn-close-white ms-2 mb-1" data-bs-dismiss="toast" aria-label="Fechar"></button>
        </div>
        <div class="toast-body">${message}</div>`;
      cont.appendChild(el);
      const t = bootstrap.Toast.getOrCreateInstance(el, { delay, autohide: true });
      t.show();
      el.addEventListener('hidden.bs.toast', () => el.remove());
    } else {
      const el = document.createElement('div');
      el.style.cssText = 'position:fixed;right:1rem;top:1rem;background:#198754;color:#fff;padding:.6rem .8rem;border-radius:.5rem;z-index:1080';
      if (opts.variant === 'danger') el.style.background = '#dc3545';
      el.textContent = message;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), delay);
    }
  };

  // ---------- Helpers ----------
  function getEl(){
    return {
      modal: document.getElementById('programar-modalAtividade'),
      btn: document.getElementById('programar-btnSalvar'),
      deleteBtn: document.getElementById('programar-btnExcluir'),
      date: document.getElementById('programar-dataAtividade'),
      cardsWrap: document.getElementById('metaCardsContainer'),
      expediente: document.getElementById('expedienteAdmin')
    };
  }

  function ensureExpedienteMetaId(){
    const { expediente } = getEl();
    const fallback = window.META_EXPEDIENTE_ID ?? NS.metaExpedienteId;
    if (expediente && !expediente.dataset.metaId && fallback){
      expediente.dataset.metaId = String(fallback);
    }
  }

  function getServidoresIdsFrom(root){
    const chips = root?.querySelectorAll('[data-id], [data-servidor-id], .servidor-chip') || [];
    return Array.from(chips)
      .map(el => Number(el.getAttribute('data-id') || el.getAttribute('data-servidor-id')))
      .filter(Number.isFinite);
  }

  function extractVeiculoId(card){
    const sel = card.querySelector('select[name="card_veiculos"], select.card-veiculos, [data-veiculo-id]');
    if (!sel) return null;
    const raw = sel.tagName === 'SELECT'
      ? (sel.value || sel.dataset.veiculoId || '')
      : (sel.dataset.veiculoId || '');
    const value = String(raw || '').trim();
    if (!value) return null;
    const parsed = Number(value);
    return Number.isFinite(parsed) ? parsed : null;
  }

  function extractItem(card){
    const meta_id = Number(card.dataset.metaId);
    const itemId  = Number(card.dataset.itemId || 0);
    const drop = card.querySelector('.meta-dropzone') || card;
    const servidores_ids = getServidoresIdsFrom(drop);
    const observacao = (card.querySelector('textarea[name="observacao"]')?.value || '').trim();
    const veiculo_id = extractVeiculoId(card);
    const out = { meta_id, observacao, veiculo_id, servidores_ids };
    if (itemId) out.id = itemId;
    return out;
  }

  function addExpedienteItemIfAny(list){
    const { expediente } = getEl();
    if (!expediente) return;
    const meta_id = Number(expediente.dataset.metaId || window.META_EXPEDIENTE_ID || NS.metaExpedienteId || 0);
    if (!meta_id) return;

    const servidores_ids = getServidoresIdsFrom(expediente);
    if (!servidores_ids.length) return; // vazio => backend apaga (delete-orphan)

    const itemId  = Number(expediente.dataset.itemId || 0);
    const item = { meta_id, observacao: '', veiculo_id: null, servidores_ids };
    if (itemId) item.id = itemId;
    list.push(item);
  }

  function hasAnythingToSave(){
    const { cardsWrap, expediente } = getEl();
    const hasCards = !!cardsWrap?.querySelector('[data-meta-id]');
    const hasExp   = !!getServidoresIdsFrom(expediente).length;
    return hasCards || hasExp;
  }

  function refreshSalvarBtn(){
    const { btn } = getEl();
    if (btn) btn.disabled = !hasAnythingToSave();
  }

  function refreshExcluirBtn(){
    const { deleteBtn, date } = getEl();
    if (!deleteBtn) return;
    const iso = date?.value || '';
    deleteBtn.disabled = !isISODate(iso);
  }

  function isISODate(s){ return /^\d{4}-\d{2}-\d{2}$/.test(String(s||'')); }

  // ---------- SALVAR ----------
  async function salvar(){
    const { btn, date, modal, cardsWrap } = getEl();
    const url = NS.urls?.salvar;
    if (!url){ NS.toast('Rota de salvar não configurada.', {variant:'danger', title:'Erro'}); return; }

    const dateStr = date?.value || '';
    if (!isISODate(dateStr)){
      NS.toast('Selecione uma data válida para salvar.', {variant:'warning'});
      return;
    }

    const cards = Array.from(cardsWrap?.querySelectorAll('[data-meta-id]') || []);
    const itens = cards.map(extractItem);
    addExpedienteItemIfAny(itens);

    if (!itens.length){
      NS.toast('Nada para salvar.', {variant:'warning'});
      return;
    }

    const payload = { data: dateStr, observacao: '', itens };

    const original = btn?.innerHTML;
    if (btn){
      btn.disabled = true;
      btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Salvando...`;
    }

    try{
      const headers = {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      };
      if (CSRF) headers['X-CSRFToken'] = CSRF;

      const resp = await fetch(url, {
        method: 'POST',
        headers,
        body: JSON.stringify(payload)
      });

      const json = await resp.json().catch(()=> ({}));
      if (!resp.ok || json.ok === false) {
        const msg = json?.error || `Falha ao salvar (HTTP ${resp.status}).`;
        throw new Error(msg);
      }

      NS._obsDirty = false;
      // impede auto-preencher expediente em cargas futuras
      document.body.dataset.progLoaded = '1';

      // Fecha modal (opcional) e notifica sucesso
      if (modal && window.bootstrap) bootstrap.Modal.getOrCreateInstance(modal).hide();
      NS.toast('Programação salva com sucesso!', { variant:'success' });

      // Evento global p/ quem quiser reagir (ex: recarregar calendário)
      document.dispatchEvent(new CustomEvent('programar:saved', {
        detail: { data: dateStr, programacao_id: json.programacao_id, itens_criados: json.itens_criados || [] }
      }));
      if (typeof NS.refreshCalendarEvents === 'function') NS.refreshCalendarEvents();
      else if (NS.calendar && typeof NS.calendar.refetchEvents === 'function') NS.calendar.refetchEvents();

    } catch (err){
      console.error('[programar] salvar erro:', err);
      NS.toast(err.message || 'Erro ao salvar a programação.', { variant:'danger', title:'Erro' });
    } finally{
      if (btn){ btn.innerHTML = original; refreshSalvarBtn(); }
    }
  }

  // ---------- EXCLUIR ----------
  async function excluirProgramacao(){
    const { deleteBtn, date, modal } = getEl();
    const url = NS.urls?.excluir;
    if (!url){ NS.toast('Rota de excluir não configurada.', {variant:'danger', title:'Erro'}); return; }

    const dateStr = date?.value || '';
    if (!isISODate(dateStr)){
      NS.toast('Selecione uma data vǭlida para excluir.', {variant:'warning'});
      return;
    }

    if (!window.confirm(`Excluir toda a programação do dia ${dateStr}? Esta ação não pode ser desfeita.`)) return;

    const original = deleteBtn?.innerHTML;
    if (deleteBtn){
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Excluindo...`;
    }

    try{
      const headers = {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      };
      if (CSRF) headers['X-CSRFToken'] = CSRF;

      const resp = await fetch(url, {
        method: 'POST',
        headers,
        body: JSON.stringify({ data: dateStr })
      });

      const json = await resp.json().catch(()=> ({}));
      if (!resp.ok || json.ok === false) {
        const msg = json?.error || `Falha ao excluir (HTTP ${resp.status}).`;
        throw new Error(msg);
      }

      document.body.dataset.progLoaded = '0';
      NS.resetAllocations?.({});
      NS.toast(json.deleted ? 'Programação excluída.' : 'Nenhuma programação encontrada.', {
        variant: json.deleted ? 'success' : 'info'
      });
      document.dispatchEvent(new CustomEvent('programar:deleted', {
        detail: { data: dateStr, deleted: !!json.deleted }
      }));
      if (modal && window.bootstrap) bootstrap.Modal.getOrCreateInstance(modal).hide();
    } catch (err){
      console.error('[programar] excluir erro:', err);
      NS.toast(err.message || 'Erro ao excluir a programação.', { variant:'danger', title:'Erro' });
    } finally{
      if (deleteBtn){
        deleteBtn.innerHTML = original || 'Excluir';
        refreshExcluirBtn();
      }
      refreshSalvarBtn();
    }
  }

  // ---------- Bind seguro (ao abrir) ----------
  function bindInsideModal(modalEl){
    if (!modalEl) return;
    if (modalEl.dataset.saveBound === '1') { refreshSalvarBtn(); refreshExcluirBtn(); return; }
    modalEl.dataset.saveBound = '1';

    ensureExpedienteMetaId();
    refreshSalvarBtn();
    refreshExcluirBtn();

    const { btn, deleteBtn, cardsWrap, expediente } = getEl();
    btn?.addEventListener('click', (e)=>{ e.preventDefault(); salvar(); });
    deleteBtn?.addEventListener('click', (e)=>{ e.preventDefault(); excluirProgramacao(); });
    modalEl.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)){
        e.preventDefault(); if (!btn?.disabled) salvar();
      }
    });

    // Observers reativam/habilitam o Salvar conforme arrasta/solta
    if (cardsWrap){
      new MutationObserver(refreshSalvarBtn).observe(cardsWrap, { childList:true, subtree:true });
    }
    if (expediente){
      new MutationObserver(refreshSalvarBtn).observe(expediente, { childList:true, subtree:true });
    }
  }

  document.addEventListener('shown.bs.modal', (ev)=>{
    if (!ev.target || ev.target.id !== 'programar-modalAtividade') return;
    bindInsideModal(ev.target);
  });

  document.addEventListener('programar:prefilled', refreshExcluirBtn);
  document.addEventListener('programar:diaSelecionado', refreshExcluirBtn);

  document.addEventListener('hide.bs.modal', (ev) => {
    if (!ev.target || ev.target.id !== 'programar-modalAtividade') return;
    if (!NS._obsDirty) return;
    const ok = window.confirm('Ha observacoes nao salvas. Deseja salvar antes de fechar?');
    if (!ok) { NS._obsDirty = false; return; }
    ev.preventDefault();
    const btn = document.getElementById('programar-btnSalvar');
    if (btn && !btn.disabled) {
      btn.click();
    }
  });

  // ---------- Bind imediato (se o include for após o footer) ----------
  (function tryImmediateBind(){
    const { modal } = getEl();
    if (modal && modal.classList.contains('show')) {
      bindInsideModal(modal);
    } else if (modal) {
      // prepara para quando abrir pela primeira vez
      // (o listener já cuida acima)
    } else {
      // sem modal ainda — tudo bem; o bind ao abrir cuida
    }
  })();

})();
</script>
