<script>
(function(){
  const NS = window.PROGRAMAR = window.PROGRAMAR || {};

  const allocations = (NS._allocations = NS._allocations || Object.create(null));
  const el = (id) => document.getElementById(id);
  const metaCardsContainer = () => el('metaCardsContainer');

  function updateCounts(){ NS.updateCounts?.(); }

  NS.ensureMetaCard = function(metaId, metaTitle){
    const cont = metaCardsContainer(); 
    if (!cont) return null;

    // já existe? apenas foca/rola e sai
    let card = cont.querySelector(`[data-meta-id="${metaId}"]`);
    if (card){
      card.scrollIntoView({behavior:'smooth', block:'nearest', inline:'start'});
      return card;
    }

    // cria card NOVO com dropzone (sem tarja)
    card = document.createElement('div');
    card.className = 'card shadow-sm servidor-cardbox';
    card.dataset.metaId = metaId;
    card.style.minWidth = '340px';
    card.style.maxWidth = '370px';

    card.innerHTML = `
      <div class="card-header bg-light border-bottom py-2">
        <div class="d-flex align-items-center justify-content-between">
          <b class="meta-title-text">${metaTitle}</b>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-primary count-meta">0</span>
            <button type="button" class="btn-close meta-close" aria-label="Remover" title="Remover card"></button>

          </div>
        </div>
      </div>
      <div class="card-body meta-body">
        <!-- ⬇️ dropzone que recebe os chips -->
        <div class="servidores-grid meta-dropzone dropzone mb-3"></div>
      </div>
    `;

    cont.appendChild(card);

    // remove qualquer tarja/alert legado que outro script tenha colocado
    card.querySelectorAll('.alert').forEach(n => n.remove());

    // Fechar card: limpa chips (se houver), ajusta allocations e contadores
        
    card.querySelector('.btn-close, .meta-close')?.addEventListener('click', (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();

      // 1) replica o clique no X de cada chip (usa a MESMA lógica que já funciona)
      const chipXs = Array.from(card.querySelectorAll('.servidor-chip .chip-remove'));
      chipXs.forEach(b => { try { b.click(); } catch(_){} });

      // 2) fallback: se sobrar algum chip por qualquer motivo
      if (card.querySelector('.servidor-chip')) {
        try { window.ProgramarCards?.returnAllFromCard?.(card); } catch(_) {}
      }

      // 3) remove o card e atualiza contadores
      try { card.remove(); } catch(_) {}
      try { (window.PROGRAMAR?.updateCounts || window.ProgramarCards?.updateCounts)?.(); } catch(_) {}
    }, { capture: true });

    card.scrollIntoView({behavior:'smooth', block:'nearest', inline:'start'});
    updateCounts();
    return card;
  };
})();
</script>
