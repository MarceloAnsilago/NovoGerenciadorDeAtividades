<script>
(function () {
  const NS = (window.PROGRAMAR = window.PROGRAMAR || {});
  if (NS._atividadesLogicLoaded) return;
  NS._atividadesLogicLoaded = true;

  const allocations = (NS._allocations = NS._allocations || Object.create(null));
  const el = (id) => document.getElementById(id);
  const metaCardsContainer = () => el("metaCardsContainer");
  function shouldAutoScroll(){
    try { return Boolean(window.PROGRAMAR?.autoScrollModal); } catch(_) { return false; }
  }

  function updateCounts() { NS.updateCounts?.(); }

  function isCardConcluded(card) {
    if (!card) return false;
    const raw = String(card.dataset.concluido || "").toLowerCase();
    return raw === "true" || raw === "1";
  }

  function applyConclusionStyles(link, concluded) {
    if (!link) return;
    if (concluded) {
      link.classList.add("btn-success");
      link.classList.remove("btn-outline-success");
    } else {
      link.classList.remove("btn-success");
      link.classList.add("btn-outline-success");
    }
    const icon = link.querySelector("i");
    if (icon) {
      icon.classList.toggle("bi-check2-square", !concluded);
      icon.classList.toggle("bi-check-circle", concluded);
    }
    const label = concluded ? "Atividade concluÃ­da em Minhas Metas" : "Concluir item em Minhas Metas";
    link.title = label;
    link.setAttribute("aria-label", label);
  }

  function syncConclusionLink(card) {
    if (!card) return;
    const link = card.querySelector(".meta-concluir");
    if (!link) return;
    const base = link.dataset.urlBase || window.PROGRAMAR?.urls?.concluirItemBase || "";
    const itemId = card.dataset.itemId;
    if (itemId && base) {
      let href = base;
      if (href.includes("/0/")) {
        href = href.replace(/\/0(\/concluir\/?)/, `/${itemId}$1`);
      } else if (href.includes("__ID__")) {
        href = href.replace(/__ID__/g, String(itemId));
      } else if (!/\d+/.test(href.slice(-1))) {
        href = href.replace(/$/, `/${itemId}`);
      }
      const next = encodeURIComponent("/minhas-metas/");
      const query = `?source=minhas-metas&next=${next}`;
      link.href = href + query;
      link.classList.remove("d-none");
      link.setAttribute("aria-disabled", "false");
    } else {
      link.href = "#";
      link.classList.add("d-none");
      link.setAttribute("aria-disabled", "true");
    }
    applyConclusionStyles(link, isCardConcluded(card));
  }
  NS.syncMetaConclusionLink = syncConclusionLink;
  function tryAddVeiculosOptions(select) {
    if (!select || select.dataset.veiculosPopulado === "1") return;
    const data = Array.isArray(window.PROGRAMAR?.veiculosAtivos) ? window.PROGRAMAR.veiculosAtivos : [];
    if (!data.length) return;
    data.forEach((v) => {
      if (!v || v.id == null) return;
      const value = String(v.id);
      if (select.querySelector(`option[value="${value}"]`)) return;
      const opt = document.createElement("option");
      opt.value = value;
      const nome = (v.nome || "").trim();
      const placa = (v.placa || "").trim();
      opt.textContent = placa ? `${nome} - ${placa}` : (nome || placa || `Veiculo #${value}`);
      select.appendChild(opt);
    });
    select.dataset.veiculosPopulado = "1";
  }

  NS.ensureMetaCard = function (metaId, metaTitle, options = {}) {
    const cont = metaCardsContainer();
    if (!cont) return null;

    const forceNew = Boolean(options && options.forceNew);

    if (!forceNew) {
      const existing = cont.querySelector(`[data-meta-id="${metaId}"]`);
      if (existing) {
        tryAddVeiculosOptions(existing.querySelector("select.card-veiculos"));
        if (shouldAutoScroll()) {
          existing.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
        }
        return existing;
      }
    }

    const card = document.createElement("div");
    card.className = "card shadow-sm servidor-cardbox";
    card.dataset.metaId = metaId;
    card.style.minWidth = "340px";
    card.style.maxWidth = "370px";

    card.innerHTML = `
      <div class="card-header bg-light border-bottom py-2">
        <div class="d-flex align-items-center justify-content-between">
          <b class="meta-title-text">${metaTitle}</b>
          <div class="d-flex align-items-center gap-2 meta-actions">
            <span class="badge bg-primary count-meta">0</span>
            <a class="btn btn-outline-success btn-sm py-0 px-1 meta-concluir d-none"
               href="#"
               data-url-base="{% url 'programar:concluir-item-form' 0 %}"
               title="Concluir item em Minhas Metas"
               aria-label="Concluir item em Minhas Metas">
              <i class="bi bi-check2-square"></i>
            </a>
            <button type="button" class="btn-close meta-close" aria-label="Remover" title="Remover card"></button>

          </div>
        </div>
      </div>
      <div class="card-body meta-body">
        <!-- area de alocacao dos servidores -->
        <div class="servidores-grid meta-dropzone dropzone mb-3"></div>
        <div class="mb-2 meta-vehicles-block">
          <label class="form-label mb-1">Veiculo</label>
          <select class="form-select form-select-sm card-veiculos" name="card_veiculos" data-placeholder="Nenhum veiculo" data-meta-id="${metaId}">
            <option value="" data-placeholder="1">Nenhum veiculo</option>
          </select>
        </div>
      </div>
    `;
    card.dataset.concluido = "false";

    cont.appendChild(card);
    tryAddVeiculosOptions(card.querySelector("select.card-veiculos"));

    card.querySelectorAll(".alert").forEach((n) => n.remove());

    card.querySelector(".btn-close, .meta-close")?.addEventListener("click", (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();

      const chipXs = Array.from(card.querySelectorAll(".servidor-chip .chip-remove"));
      chipXs.forEach((b) => { try { b.click(); } catch (_) {} });

      if (card.querySelector(".servidor-chip")) {
        try { window.ProgramarCards?.returnAllFromCard?.(card); } catch (_) {}
      }

      try { card.remove(); } catch (_) {}
      try { (window.PROGRAMAR?.updateCounts || window.ProgramarCards?.updateCounts)?.(); } catch (_) {}
    }, { capture: true });

    if (shouldAutoScroll()) {
      card.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
    }
    syncConclusionLink(card);
    updateCounts();
    return card;
  };
})();
</script>
