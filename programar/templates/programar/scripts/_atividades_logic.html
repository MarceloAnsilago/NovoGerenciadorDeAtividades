<script>
(function () {
  const NS = (window.PROGRAMAR = window.PROGRAMAR || {});
  if (NS._atividadesLogicLoaded) return;
  NS._atividadesLogicLoaded = true;

  const allocations = (NS._allocations = NS._allocations || Object.create(null));
  const el = (id) => document.getElementById(id);
  const metaCardsContainer = () => el("metaCardsContainer");
  function shouldAutoScroll(){
    try { return Boolean(window.PROGRAMAR?.autoScrollModal); } catch(_) { return false; }
  }
  function escapeHtml(value) {
    return String(value ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function updateCounts() { NS.updateCounts?.(); }

  function isCardConcluded(card) {
    if (!card) return false;
    const raw = String(card.dataset.concluido || "").toLowerCase();
    return raw === "true" || raw === "1";
  }

  function applyConclusionStyles(link, concluded) {
    if (!link) return;
    if (concluded) {
      link.classList.add("btn-success");
      link.classList.remove("btn-outline-success");
    } else {
      link.classList.remove("btn-success");
      link.classList.add("btn-outline-success");
    }
    const icon = link.querySelector("i");
    if (icon) {
      icon.classList.toggle("bi-check2-square", !concluded);
      icon.classList.toggle("bi-check-circle", concluded);
    }
    const label = concluded ? "Atividade concluÃ­da em Minhas Metas" : "Concluir item em Minhas Metas";
    link.title = label;
    link.setAttribute("aria-label", label);
  }

  function syncConclusionLink(card) {
    if (!card) return;
    const link = card.querySelector(".meta-concluir");
    if (!link) return;
    const base = link.dataset.urlBase || window.PROGRAMAR?.urls?.concluirItemBase || "";
    const itemId = card.dataset.itemId;
    if (itemId && base) {
      let href = base;
      if (href.includes("/0/")) {
        href = href.replace(/\/0(\/concluir\/?)/, `/${itemId}$1`);
      } else if (href.includes("__ID__")) {
        href = href.replace(/__ID__/g, String(itemId));
      } else if (!/\d+/.test(href.slice(-1))) {
        href = href.replace(/$/, `/${itemId}`);
      }
      const next = encodeURIComponent("/minhas-metas/");
      const query = `?source=minhas-metas&next=${next}`;
      link.href = href + query;
      link.classList.remove("d-none");
      link.setAttribute("aria-disabled", "false");
    } else {
      link.href = "#";
      link.classList.add("d-none");
      link.setAttribute("aria-disabled", "true");
    }
    applyConclusionStyles(link, isCardConcluded(card));
  }
  NS.syncMetaConclusionLink = syncConclusionLink;
  function tryAddVeiculosOptions(select) {
    if (!select || select.dataset.veiculosPopulado === "1") return;
    const data = Array.isArray(window.PROGRAMAR?.veiculosAtivos) ? window.PROGRAMAR.veiculosAtivos : [];
    if (!data.length) return;
    data.forEach((v) => {
      if (!v || v.id == null) return;
      const value = String(v.id);
      if (select.querySelector(`option[value="${value}"]`)) return;
      const opt = document.createElement("option");
      opt.value = value;
      const nome = (v.nome || "").trim();
      const placa = (v.placa || "").trim();
      opt.textContent = placa ? `${nome} - ${placa}` : (nome || placa || `Veiculo #${value}`);
      select.appendChild(opt);
    });
    select.dataset.veiculosPopulado = "1";
  }

  const OBS_IDS = {
    modal: "programar-modalObservacao",
    input: "programar-obs-text",
    save: "programar-obs-save",
    clear: "programar-obs-clear",
    cancel: "programar-obs-cancel",
    meta: "programar-obs-meta",
  };

  function getObsValue(card) {
    return (card?.querySelector('textarea[name="observacao"]')?.value || "").trim();
  }

  function syncObsIndicator(card) {
    if (!card) return;
    const btn = card.querySelector(".meta-obs-btn");
    const ta = card.querySelector('textarea[name="observacao"]');
    if (!btn || !ta) return;
    const hasObs = !!ta.value.trim();
    btn.classList.toggle("has-obs", hasObs);
    btn.title = hasObs ? "Editar observacao" : "Adicionar observacao";
    btn.setAttribute("aria-pressed", hasObs ? "true" : "false");
  }
  NS.syncObsIndicator = syncObsIndicator;

  function applyObsToCard(card, text) {
    if (!card) return;
    const ta = card.querySelector('textarea[name="observacao"]');
    if (ta) ta.value = text || "";
    NS._obsDirty = true;
    syncObsIndicator(card);
  }

  function openObsModal(card) {
    if (!card) return;
    const modalEl = document.getElementById(OBS_IDS.modal);
    if (!modalEl) return;
    NS._obsCard = card;
    const input = document.getElementById(OBS_IDS.input);
    if (input) input.value = getObsValue(card);
    const metaLabel = document.getElementById(OBS_IDS.meta);
    if (metaLabel) {
      metaLabel.textContent = (card.querySelector(".meta-title-text")?.textContent || "Atividade").trim();
    }
    if (window.bootstrap) bootstrap.Modal.getOrCreateInstance(modalEl).show();
    if (input) setTimeout(() => input.focus(), 50);
  }

  NS.ensureMetaCard = function (metaId, metaTitle, options = {}) {
    const cont = metaCardsContainer();
    if (!cont) return null;

    const forceNew = Boolean(options && options.forceNew);
    const metaDescription = String(options?.metaDescricao || "").trim();
    const safeMetaTitle = escapeHtml(metaTitle || "");
    const safeMetaDescription = escapeHtml(metaDescription);

    if (!forceNew) {
      const existing = cont.querySelector(`[data-meta-id="${metaId}"]`);
      if (existing) {
        const descEl = existing.querySelector(".meta-description");
        if (descEl && metaDescription) {
          descEl.textContent = metaDescription;
          descEl.classList.remove("d-none");
        }
        tryAddVeiculosOptions(existing.querySelector("select.card-veiculos"));
        syncObsIndicator(existing);
        if (shouldAutoScroll()) {
          existing.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
        }
        return existing;
      }
    }

    const card = document.createElement("div");
    card.className = "card shadow-sm servidor-cardbox";
    card.dataset.metaId = metaId;
    card.style.minWidth = "340px";
    card.style.maxWidth = "370px";

    card.innerHTML = `
      <div class="card-header bg-light border-bottom py-2">
        <div class="d-flex align-items-center justify-content-between">
          <b class="meta-title-text">${safeMetaTitle}</b>
          <div class="d-flex align-items-center gap-2 meta-actions">
            <span class="badge bg-primary count-meta">0</span>
            <a class="btn btn-outline-success btn-sm py-0 px-1 meta-concluir d-none"
               href="#"
               data-url-base="{% url 'programar:concluir-item-form' 0 %}"
               title="Concluir item em Minhas Metas"
               aria-label="Concluir item em Minhas Metas">
              <i class="bi bi-check2-square"></i>
            </a>
            <button type="button" class="btn-close meta-close" aria-label="Remover" title="Remover card"></button>

          </div>
        </div>
      </div>
      <div class="card-body meta-body">
        <p class="meta-description small text-muted mb-2${metaDescription ? "" : " d-none"}">${safeMetaDescription}</p>
        <!-- area de alocacao dos servidores -->
        <div class="servidores-grid meta-dropzone dropzone mb-3"></div>
        <div class="mb-2 meta-vehicles-block">
          <label class="form-label mb-1">Veiculo</label>
          <select class="form-select form-select-sm card-veiculos" name="card_veiculos" data-placeholder="Nenhum veiculo" data-meta-id="${metaId}">
            <option value="" data-placeholder="1">Nenhum veiculo</option>
          </select>
        </div>
        <div class="meta-obs-actions">
          <button type="button" class="btn btn-outline-secondary btn-sm meta-obs-btn" title="Adicionar observacao" aria-label="Observacao">
            <i class="bi bi-chat-left-text"></i>
            <span class="meta-obs-dot" aria-hidden="true"></span>
          </button>
        </div>
        <textarea class="meta-obs-input d-none" name="observacao" rows="2"></textarea>
      </div>
    `;
    card.dataset.concluido = "false";

    cont.appendChild(card);
    tryAddVeiculosOptions(card.querySelector("select.card-veiculos"));
    syncObsIndicator(card);

    card.querySelectorAll(".alert").forEach((n) => n.remove());

    card.querySelector(".btn-close, .meta-close")?.addEventListener("click", (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();

      const chipXs = Array.from(card.querySelectorAll(".servidor-chip .chip-remove"));
      chipXs.forEach((b) => { try { b.click(); } catch (_) {} });

      if (card.querySelector(".servidor-chip")) {
        try { window.ProgramarCards?.returnAllFromCard?.(card); } catch (_) {}
      }

      try { card.remove(); } catch (_) {}
      try { (window.PROGRAMAR?.updateCounts || window.ProgramarCards?.updateCounts)?.(); } catch (_) {}
    }, { capture: true });

    if (shouldAutoScroll()) {
      card.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
    }
    syncConclusionLink(card);
    updateCounts();
    return card;
  };

  // --------- Observacao: delegacao ----------
  document.addEventListener("click", (ev) => {
    const btn = ev.target.closest?.(".meta-obs-btn");
    if (!btn) return;
    ev.preventDefault();
    const card = btn.closest("[data-meta-id]");
    openObsModal(card);
  });

  document.addEventListener("click", (ev) => {
    const saveBtn = ev.target.closest?.("#" + OBS_IDS.save);
    if (!saveBtn) return;
    ev.preventDefault();
    const card = NS._obsCard;
    const input = document.getElementById(OBS_IDS.input);
    const text = (input?.value || "").trim();
    applyObsToCard(card, text);
    const modalEl = document.getElementById(OBS_IDS.modal);
    if (modalEl && window.bootstrap) bootstrap.Modal.getOrCreateInstance(modalEl).hide();
  });

  document.addEventListener("click", (ev) => {
    const clearBtn = ev.target.closest?.("#" + OBS_IDS.clear);
    if (!clearBtn) return;
    ev.preventDefault();
    const card = NS._obsCard;
    applyObsToCard(card, "");
    const input = document.getElementById(OBS_IDS.input);
    if (input) input.value = "";
    const modalEl = document.getElementById(OBS_IDS.modal);
    if (modalEl && window.bootstrap) bootstrap.Modal.getOrCreateInstance(modalEl).hide();
  });

  document.addEventListener("click", (ev) => {
    const cancelBtn = ev.target.closest?.("#" + OBS_IDS.cancel);
    if (!cancelBtn) return;
    NS._obsCancel = true;
  });

  document.addEventListener("show.bs.modal", (ev) => {
    if (ev.target?.id === OBS_IDS.modal) {
      NS._obsCancel = false;
    }
  });

  document.addEventListener("hide.bs.modal", (ev) => {
    if (ev.target?.id !== OBS_IDS.modal) return;
    if (NS._obsCancel) {
      NS._obsCancel = false;
      return;
    }
    const card = NS._obsCard;
    const input = document.getElementById(OBS_IDS.input);
    const text = (input?.value || "").trim();
    applyObsToCard(card, text);
  });
})();
</script>
