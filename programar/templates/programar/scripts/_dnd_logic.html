<script>
(function () {
  const TAG = 'CARD-ATIVIDADES-CONSOLIDADO';
  const SEL = {
    metaContainer: '#metaCardsContainer',
    metaCard:      '[data-meta-id]',
    closeBtn:      '.meta-close, .btn-close',
    chip:          '.servidor-chip',
    chipX:         '.servidor-chip .chip-remove',
    chipId:        'data-id',
    chipName:      '.chip-name',
    exp:           '#expedienteAdmin',
    livres:        '#servidoresLivres',
    srvCard:       '.servidor-card',
    srvName:       '.srv-name'
  };

  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  // ----- helpers -----
  function resolveName(sid){
    const el = document.querySelector(`${SEL.srvCard}[data-id="${sid}"]`);
    return (el?.querySelector(SEL.srvName)?.textContent || el?.textContent || String(sid)).trim();
  }
  function appendToExpedienteNoDup(sid, name){
    const exp = $(SEL.exp);
    if (!exp) { console.warn(TAG, 'Expediente não encontrado'); return; }
    let el = exp.querySelector(`${SEL.srvCard}[data-id="${sid}"]`);
    if (!el){
      el = document.createElement('div');
      el.className = 'servidor-card';
      el.dataset.id = sid;
      el.setAttribute('draggable','true');
      el.innerHTML = `
        <span class="srv-icon"><i class="bi bi-person-fill"></i></span>
        <span class="srv-name">${name || sid}</span>`;
      exp.appendChild(el);
    }
    // garantir remoção de "livres"
    $(SEL.livres)?.querySelector(`${SEL.srvCard}[data-id="${sid}"]`)?.remove();
  }
  function collectChips(card){
    return $$(SEL.chip, card).map(ch => {
      const sid = String(ch.getAttribute(SEL.chipId) || '').trim();
      const nm  = ch.querySelector(SEL.chipName)?.textContent?.trim() || resolveName(sid);
      return sid ? { sid, name: nm || sid } : null;
    }).filter(Boolean);
  }
  function updateCountsSafe(){
    try { window.ProgramarCards?.updateCounts?.(); } catch {}
    try { window.PROGRAMAR?.updateCounts?.(); } catch {}
  }

  // ---- caminho 1: exatamente como o X do servidor ----
  function removeLikeUserClicks(card){
    const btns = Array.from(card.querySelectorAll(SEL.chipX));
    for (const b of btns) { try { b.click(); } catch {} }
  }

  // ---- caminho 2: fallback oficial/visual ----
  function returnAllOfficialOrVisual(card, backup){
    let usedOfficial = false;
    if (typeof window.ProgramarCards?.returnAllFromCard === 'function') {
      try { window.ProgramarCards.returnAllFromCard(card); usedOfficial = true; } catch {}
    } else if (typeof window.PROGRAMAR?.returnAllFromCard === 'function') {
      try { window.PROGRAMAR.returnAllFromCard(card); usedOfficial = true; } catch {}
    }
    if (!usedOfficial) {
      // visual
      (backup || collectChips(card)).forEach(({sid,name}) => appendToExpedienteNoDup(sid, name));
    }
  }

  function reinforce(backup){
    // reforça destino correto (vence scripts que repovoam "livres")
    const chips = backup || [];
    setTimeout(() => {
      chips.forEach(({sid,name}) => appendToExpedienteNoDup(sid, name));
      updateCountsSafe();
    }, 0);
    setTimeout(() => {
      chips.forEach(({sid,name}) => appendToExpedienteNoDup(sid, name));
      updateCountsSafe();
    }, 120);
  }

  // ---- fechamento determinístico do card ----
  function closeCard(card){
    if (!card || card.__closing__) return;
    card.__closing__ = true;

    const backup = card.__chipsBackup || collectChips(card);

    // 1) replica o X de cada chip
    removeLikeUserClicks(card);

    // 2) se sobrou algo, usa o caminho oficial (allocations) ou visual
    if (card.querySelector(SEL.chip)) {
      returnAllOfficialOrVisual(card, backup);
    }

    // 3) remove card
    try { card.remove(); } catch {}

    // 4) reforços
    reinforce(backup);

    setTimeout(() => { delete card.__chipsBackup; delete card.__closing__; }, 300);
  }

  // ----- interceptores -----
  // backup o mais cedo possível
  document.addEventListener('pointerdown', (ev) => {
    const btn = ev.target.closest(SEL.closeBtn);
    if (!btn) return;
    const card = btn.closest(SEL.metaCard);
    if (!card) return;
    card.__chipsBackup = collectChips(card);
  }, true);

  // click no X do card
  document.addEventListener('click', (ev) => {
    const btn = ev.target.closest(SEL.closeBtn);
    if (!btn) return;
    const card = btn.closest(SEL.metaCard);
    if (!card) return;

    ev.preventDefault();
    ev.stopPropagation();
    if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();

    closeCard(card);
  }, true);

  // ----- rede de segurança -----
  const mo = new MutationObserver(muts => {
    for (const m of muts) {
      m.removedNodes.forEach(n => {
        if (n.nodeType !== 1) return;
        if (n.matches?.(SEL.metaCard)) {
          const backup = n.__chipsBackup || collectChips(n);
          backup.forEach(({sid,name}) => appendToExpedienteNoDup(sid, name));
        } else {
          n.querySelectorAll?.(SEL.metaCard)?.forEach(c => {
            const backup = c.__chipsBackup || collectChips(c);
            backup.forEach(({sid,name}) => appendToExpedienteNoDup(sid, name));
          });
        }
      });
    }
    updateCountsSafe();
  });
  function bootObserver(){
    const cont = $(SEL.metaContainer);
    if (cont) mo.observe(cont, { childList:true, subtree:true });
    else      mo.observe(document.documentElement, { childList:true, subtree:true });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bootObserver, { once:true });
  } else {
    bootObserver();
  }

  // ----- utils -----
  window.PROGRAMAR = window.PROGRAMAR || {};
  window.PROGRAMAR.returnAllFromAllCards = function(){
    document.querySelectorAll(SEL.metaCard).forEach(c => {
      c.__chipsBackup = collectChips(c);
      closeCard(c);
    });
  };

  console.log('%c'+TAG+' ativo', 'background:#111;color:#0f0;padding:2px 6px;border-radius:4px');
})();
</script>
