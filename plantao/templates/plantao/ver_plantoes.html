{% extends "core/base.html" %}

{% block content %}
<div class="container py-3">
  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong><i class="bi bi-list-ul"></i> Plantões salvos</strong>
      <a href="{% url 'plantao:lista_plantao' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Voltar
      </a>
    </div>

    <div class="card-body p-0">

      {# ====== FILTRO POR ANO (INSERIR AQUI) ====== #}
      <div class="px-3 py-2 border-bottom">
        <form method="get" action="{% url 'plantao:ver_plantoes' %}" class="d-flex align-items-end g-2">
          <div class="me-2">
            <label for="ano" class="form-label small mb-0">Ano</label>
            <select id="ano" name="ano" class="form-select form-select-sm">
              <option value="">(Todos)</option>
              {% for y in years %}
                <option value="{{ y }}" {% if ano_selected and ano_selected == y %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="align-self-end">
            <button type="submit" class="btn btn-sm btn-secondary">Filtrar</button>
          </div>
        </form>
      </div>
      {# ====== /FILTRO POR ANO ====== #}

      <div class="table-responsive">
        <table class="table mb-0">
          <thead class="table-light">
            <tr>
              <th>Nome</th>
              <th>Início</th>
              <th>Fim</th>
              <th>Criado por</th>
              <th>Criado em</th>
              <th class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody id="plantoes-tbody">
            {% for p in plantoes %}
            <tr data-pk="{{ p.pk }}" id="plantao-row-{{ p.pk }}">
              <td>
                {% if p.nome %}
                  {{ p.nome }}
                {% else %}
                  {{ p.inicio|date:"d/m/Y" }} a {{ p.fim|date:"d/m/Y" }}
                {% endif %}
              </td>
              <td>{{ p.inicio|date:"d/m/Y" }}</td>
              <td>{{ p.fim|date:"d/m/Y" }}</td>
              <td>
                {% if p.criado_por %}
                  {{ p.criado_por.get_full_name|default:p.criado_por.username }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td>{{ p.criado_em|date:"d/m/Y H:i" }}</td>
              <td class="text-end">
                <div class="btn-group">
                  <button class="btn btn-sm btn-outline-primary btn-open" data-pk="{{ p.pk }}" type="button">
                    <i class="bi bi-folder2-open"></i> Abrir
                  </button>
                  <button class="btn btn-sm btn-outline-danger btn-delete" data-pk="{{ p.pk }}" type="button">
                    <i class="bi bi-trash"></i> Excluir
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="text-muted">Nenhum plantão salvo.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- container onde será injetada a tabela de escala do plantão aberto -->
  <div id="plantao-detalhe-container" class="mb-3"></div>

  <!-- Ações do detalhe: Imprimir -->
  <div class="mb-4">
    <button id="btn-imprimir-plantao" class="btn btn-outline-secondary no-print" style="display:none;">
      <i class="bi bi-printer-fill me-1"></i> Imprimir
    </button>
  </div>
</div>

{# URL base (usada pelo JS para gerar a URL do fragmento de forma reversível) #}
<span id="plantao-fragment-url-base" data-url="{% url 'plantao:plantao_detalhe_fragment' pk=0 %}" style="display:none;"></span>

<script>
/* -------- helpers -------- */
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i=0;i<cookies.length;i++){
      let c = cookies[i].trim();
      if (c.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(c.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

/* estado */
let currentPlantaoPk = null;

document.addEventListener('DOMContentLoaded', () => {
  const tbody = document.getElementById('plantoes-tbody');
  const detalheContainer = document.getElementById('plantao-detalhe-container');
  const btnPrint = document.getElementById('btn-imprimir-plantao');
  const baseUrlEl = document.getElementById('plantao-fragment-url-base');
  const baseFragmentUrl = baseUrlEl ? baseUrlEl.getAttribute('data-url') : null;

  // delegação de clicks (abre/excluir)
  document.body.addEventListener('click', async (ev) => {
    // ========== Abrir ==========
    const btnOpen = ev.target.closest('.btn-open');
    if (btnOpen) {
      ev.preventDefault();
      const pk = btnOpen.getAttribute('data-pk');
      if (!pk) {
        console.warn('Botão Abrir sem data-pk');
        return;
      }

      const url = baseFragmentUrl ? baseFragmentUrl.replace('/0/', `/${pk}/`) : `/plantao/${pk}/detalhe-fragment/`;

      // UI feedback
      const originalHtml = btnOpen.innerHTML;
      btnOpen.disabled = true;
      btnOpen.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Carregando...';

      try {
        const resp = await fetch(url, { credentials: 'same-origin' });
        if (!resp.ok) {
          const text = await resp.text().catch(()=>'(sem body)');
          console.error('Erro ao buscar fragmento', resp.status, text);
          if (detalheContainer) detalheContainer.innerHTML = `<div class="alert alert-danger">Erro ao carregar escala (HTTP ${resp.status}).</div>`;
          // esconder imprimir
          if (btnPrint) btnPrint.style.display = 'none';
          currentPlantaoPk = null;
          document.querySelectorAll('#plantoes-tbody tr').forEach(r=>r.classList.remove('table-active'));
        } else {
          const html = await resp.text();
          if (detalheContainer) detalheContainer.innerHTML = html || '<div class="alert alert-warning">Fragmento vazio.</div>';
          detalheContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

          // marcar estado
          currentPlantaoPk = pk;
          if (btnPrint) btnPrint.style.display = 'inline-block';

          // destacar linha ativa
          document.querySelectorAll('#plantoes-tbody tr').forEach(r=>r.classList.remove('table-active'));
          const row = document.getElementById(`plantao-row-${pk}`);
          if (row) row.classList.add('table-active');
        }
      } catch (err) {
        console.error('Erro fetch fragmento:', err);
        if (detalheContainer) detalheContainer.innerHTML = `<div class="alert alert-danger">Erro inesperado ao carregar escala.</div>`;
        if (btnPrint) btnPrint.style.display = 'none';
        currentPlantaoPk = null;
        document.querySelectorAll('#plantoes-tbody tr').forEach(r=>r.classList.remove('table-active'));
      } finally {
        btnOpen.disabled = false;
        btnOpen.innerHTML = originalHtml;
      }
      return;
    }

    // ========== Excluir ==========
    const btnDel = ev.target.closest('.btn-delete');
    if (btnDel) {
      ev.preventDefault();
      const pk = btnDel.getAttribute('data-pk');
      if (!pk) return;

      if (!confirm("Confirma exclusão deste plantão? Esta ação não poderá ser desfeita.")) return;

      // salva HTML original
      if (!btnDel.dataset.origHtml) btnDel.dataset.origHtml = btnDel.innerHTML;
      const origHtml = btnDel.dataset.origHtml;

      const url = `{% url 'plantao:plantao_excluir' pk=0 %}`.replace('/0/', `/${pk}/`);
      try {
        btnDel.disabled = true;
        btnDel.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Excluindo...';

        const resp = await fetch(url, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'X-CSRFToken': csrftoken,
            'Accept': 'application/json'
          }
        });

        const text = await resp.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch(e){ /* non-json */ }

        if (resp.ok && data && data.ok) {
          // remove linha
          const row = document.getElementById(`plantao-row-${pk}`);
          if (row) row.remove();
          // limpa detalhe caso seja o plantão aberto
          if (String(currentPlantaoPk) === String(pk)) {
            if (detalheContainer) detalheContainer.innerHTML = '';
            currentPlantaoPk = null;
            if (btnPrint) btnPrint.style.display = 'none';
          }

          // feedback (alert bootstrap)
          const alert = document.createElement('div');
          alert.className = 'alert alert-success';
          alert.role = 'alert';
          alert.textContent = 'Plantão excluído com sucesso.';
          const container = document.querySelector('.container') || document.body;
          container.insertBefore(alert, container.firstChild);
          setTimeout(()=> alert.remove(), 3500);
        } else {
          const serverMsg = (data && data.erro) ? data.erro : null;
          let message = serverMsg || `Erro ao excluir (HTTP ${resp.status}).`;
          if (resp.status === 403 && !serverMsg) message = 'Permissão negada para excluir este plantão.';
          if (!data) message += ' (resposta não foi JSON)';
          alert(message);
          console.error('Excluir plantão falhou', { status: resp.status, body: text, parsed: data });
        }
      } catch (err) {
        console.error('Erro comunicação ao excluir:', err);
        alert('Erro de comunicação ao tentar excluir. Veja console/Network.');
      } finally {
        btnDel.disabled = false;
        btnDel.innerHTML = origHtml;
      }
      return;
    }
  });

  // ========== Imprimir: mostra apenas o detalhe carregado ========== //
  btnPrint?.addEventListener('click', (ev) => {
    ev.preventDefault();
    if (!currentPlantaoPk) {
      alert('Nenhum plantão carregado para imprimir.');
      return;
    }

    // CSS temporário para impressão: esconde tudo exceto o detalhe
    const printCss = `
      @media print {
        body * { visibility: hidden !important; }
        #plantao-detalhe-container, #plantao-detalhe-container * { visibility: visible !important; }
        #plantao-detalhe-container { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; }
        .no-print { display: none !important; }
        @page { margin: 12mm; }
      }
    `;
    const styleEl = document.createElement('style');
    styleEl.id = 'print-only-style';
    styleEl.appendChild(document.createTextNode(printCss));
    document.head.appendChild(styleEl);

    // pequeno delay para garantir repaint
    setTimeout(() => {
      try { window.print(); } finally {
        setTimeout(()=> {
          const s = document.getElementById('print-only-style');
          if (s) s.remove();
        }, 300);
      }
    }, 150);
  });

});
</script>

{% endblock %}
