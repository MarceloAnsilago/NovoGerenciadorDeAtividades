{% extends "core/base.html" %}

{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0"><i class="bi bi-calendar3"></i> Plantões</h2>

    <!-- botão para ver plantões salvos -->
    <a href="{% url 'plantao:ver_plantoes' %}"
      class="btn btn-outline-primary"
      role="button"
      title="Ver plantões salvos">
      <i class="bi bi-folder2-open me-1"></i> Ver plantões salvos
    </a>
  </div>

  <!-- Filtro -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" action="{% url 'plantao:lista_plantao' %}" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="data_inicial" class="form-label">Data inicial</label>
          <input type="date" id="data_inicial" name="data_inicial" class="form-control" value="{{ data_inicial }}">
        </div>
        <div class="col-md-4">
          <label for="data_final" class="form-label">Data final</label>
          <input type="date" id="data_final" name="data_final" class="form-control" value="{{ data_final }}">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-secondary w-100"><i class="bi bi-search"></i> Filtrar</button>
        </div>
      </form>
    </div>
  </div>



  {# Se houve conflito e a view retornou conflito_abort=True, não renderizar nada além do aviso #}
  {% if conflito_abort %}
    <div class="card shadow-sm mb-4 border-danger">
      <div class="card-header bg-light">
        <strong class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Conflito de plantão</strong>
      </div>
      <div class="card-body">
        <p class="mb-2">
          Já existe(m) plantão(ões) que conflitam com o período selecionado
          (<strong>{{ data_inicial|date:"d/m/Y" }} a {{ data_final|date:"d/m/Y" }}</strong>).
        </p>

        {% if plantoes_conflitantes %}
          <div class="mb-2">
            <strong>Períodos conflitantes:</strong>
            <ul class="mb-0">
              {% for p in plantoes_conflitantes %}
                <li>{{ p.inicio|date:"d/m/Y" }} a {{ p.fim|date:"d/m/Y" }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <p class="text-muted mb-0">
          Altere o período ou visualize os plantões existentes antes de tentar salvar.
        </p>
      </div>
    </div>

    {# Não executar o restante da UI (descansos / montagem / scripts) #}
  {% else %}
    <!-- Descansos -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light"><strong><i class="bi bi-calendar-range"></i> Descansos no período</strong></div>
      <div class="card-body">
        {% if data_inicial and data_final %}
          {% if servidores_com_descanso %}
            {% include "partials/_descanso_por_servidor_table.html" with servidores_com_descanso=servidores_com_descanso only %}
          {% else %}
            <p class="text-muted mb-0">Nenhum servidor em descanso no período informado.</p>
          {% endif %}
        {% else %}
          <p class="text-muted mb-0">Selecione a data inicial e final e clique em <strong>Filtrar</strong>.</p>
        {% endif %}
      </div>
    </div>

    <!-- Montar escala: por grupos -->
    {% if data_inicial and data_final %}
    <div class="card shadow-sm">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <strong><i class="bi bi-people"></i> Montar escala do plantão (por grupos)</strong>
        <div class="small text-muted"><i class="bi bi-person-fill-slash"></i> Excluídos (descanso integral): {{ bloqueados|length }}</div>
      </div>
      <div class="card-body">
        <form id="form-escala" method="post" action="{% url 'plantao:lista_plantao' %}">
          {% csrf_token %}
          <input type="hidden" name="data_inicial" value="{{ data_inicial }}">
          <input type="hidden" name="data_final" value="{{ data_final }}">

          {% include "partials/escala_grupos.html" %}

          <!-- botão Salvar dentro do form -->
          <div class="mt-3">
            <button type="submit" id="btn-salvar" class="btn btn-primary">
              <i class="bi bi-save"></i> Salvar
            </button>
          </div>

        </form>
      </div>
    </div>

    {% include "partials/escala_tabela.html" with grupos=grupos only %}
    {% endif %}
  {% endif %}

</div>

{# só incluir os scripts de comportamento se não houver abort por conflito #}
{% if not conflito_abort %}
<script>
let currentGroupId = null; // grupo alvo do botão “Adicionar →” geral

/* --------- utils --------- */
function updateGroupCounters(){
  document.querySelectorAll('.grupo-select').forEach(sel=>{
    const count = sel.options.length;
    const idx   = sel.id.replace('grupo-','');
    const lbl   = document.getElementById('counter-grupo-'+idx);
    if (lbl) lbl.textContent = `${count}`;
    sel.classList.remove('is-valid', 'is-invalid');
  });
}
function setAvailLabel(opt){
  const base = opt.getAttribute('data-name') || opt.text;
  const c = parseInt(opt.getAttribute('data-count')||'0',10);
  opt.text = c>0 ? `${base} (${c})` : base;
}
function incAvailCount(id, delta){
  const sel = document.getElementById('sel-disponiveis');
  const opt = [...(sel?.options||[])].find(o=>o.value===String(id));
  if (!opt) return;
  let c = parseInt(opt.getAttribute('data-count')||'0',10);
  c = Math.max(0, c + delta);
  opt.setAttribute('data-count', String(c));
  setAvailLabel(opt);
}

/* --------- escala (tabela) --------- */
function escapeHtml(s){ return s ? s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;") : ""; }
function refreshEscalaRowByGroupId(groupId){
  const idx   = groupId.replace('grupo-','');
  const sel   = document.getElementById(groupId);
  const nomes = document.getElementById('escala-nome-'+idx);
  const fones = document.getElementById('escala-fone-'+idx);
  if (!nomes || !fones) return;

  const opts = sel ? [...sel.options] : [];
  if (opts.length === 0){
    nomes.innerHTML = '<span class="text-muted">—</span>';
    fones.innerHTML = '<span class="text-muted">—</span>';
    return;
  }

  const nomesLis = opts.map(o => `<li>${escapeHtml(o.text)}</li>`).join('');
  const fonesLis = opts.map(o => `<li>${escapeHtml(o.getAttribute('data-phone') || '—')}</li>`).join('');

  nomes.innerHTML = `<ul class="list-unstyled mb-0">${nomesLis}</ul>`;
  fones.innerHTML = `<ul class="list-unstyled mb-0">${fonesLis}</ul>`;
}

/* --------- ações --------- */
async function verificarDescanso(servidorId, inicio, fim) {
  const url = `/plantao/verificar-descanso/?servidor_id=${servidorId}&inicio=${inicio}&fim=${fim}`;
  const resp = await fetch(url, { credentials: 'same-origin' }); // garante cookies de sessão
  if (!resp.ok) {
    console.error('verificar-descanso HTTP error', resp.status);
    try { const t = await resp.text(); console.debug(t); } catch(e){}
    return false; // em caso de erro da API, permite (ou mude para true para bloquear por segurança)
  }
  const data = await resp.json();
  if (data.bloqueado) {
    const msg = data.impedimentos.map(i => {
      const tipo = i.tipo || '';
      const obs  = i.observacoes ? ` — ${i.observacoes}` : '';
      return `• ${tipo}${obs} (${i.data_inicio} a ${i.data_fim})`;
    }).join('\n');
    alert(`Servidor impedido nesta semana:\n${msg}`);
    return true;
  }
  return false;
}

async function addToGroup(groupId){
  const avail = document.getElementById('sel-disponiveis');
  const target= document.getElementById(groupId);
  const excl  = document.getElementById('sel-excluidos');
  if (!avail || !target) return;

  const selected = [...avail.options].filter(o=>o.selected);
  if (selected.length === 0) return;

  const idx = groupId.replace("grupo-", "");
  const elSemana = document.getElementById(`grupo-${idx}-periodo`);
  const [inicio, fim] = elSemana?.value?.split(" a ") || [];

  const duplicates = []; // names que já existiam no target

  for (const o of selected){
    // não adicionar se estiver nos excluídos
    if ([...excl.options].some(e=>e.value===o.value)) continue;

    // não adicionar se já existir no target (previne duplicata)
    if ([...(target.options||[])].some(e=>e.value===o.value)) {
      const name = o.getAttribute('data-name') || o.text;
      duplicates.push(name);
      continue;
    }

    // checa descanso por semana
    const impedido = await verificarDescanso(o.value, inicio, fim);
    if (impedido) continue;

    const phone = o.getAttribute('data-phone') || '';
    const name  = o.getAttribute('data-name') || o.text;
    const clone = new Option(name, o.value, false, true);
    clone.setAttribute('data-phone', phone);
    clone.setAttribute('data-name', name);
    target.add(clone);

    // só incrementar contagem quando realmente adicionou
    incAvailCount(o.value, +1);
  }

  if (duplicates.length > 0) {
    alert("Os seguintes servidores já estão neste grupo \n\n" + duplicates.join("\n"));
  }

  updateGroupCounters();
  refreshEscalaRowByGroupId(groupId);
}

function addToGroupSelected(){
  const groups = [...document.querySelectorAll('.grupo-select')];
  if (groups.length === 0) return;
  const target = currentGroupId ? document.getElementById(currentGroupId) : groups[0];
  if (!target) return;
  addToGroup(target.id);
}
function removeFromGroup(groupId){
  const sel = document.getElementById(groupId);
  const removing = [...sel.options].filter(o=>o.selected);
  for (const o of removing){
    sel.remove(o.index);
    incAvailCount(o.value, -1);
  }
  updateGroupCounters();
  refreshEscalaRowByGroupId(groupId);
}
function moveOption(id, dir){
  const sel = document.getElementById(id); if(!sel) return;
  if (dir<0){
    for (let i=0;i<sel.options.length;i++){
      const o=sel.options[i];
      if (o.selected && i>0 && !sel.options[i-1].selected){
        sel.insertBefore(o, sel.options[i-1]);
      }
    }
  } else {
    for (let i=sel.options.length-1;i>=0;i--){
      const o=sel.options[i];
      if (o.selected && i<sel.options.length-1 && !sel.options[i+1].selected){
        sel.insertBefore(sel.options[i+1], o);
      }
    }
  }
  refreshEscalaRowByGroupId(id);
}
function excludeSelected(){
  const avail=document.getElementById('sel-disponiveis');
  const exc  =document.getElementById('sel-excluidos');
  const sel  =[...avail.options].filter(o=>o.selected);
  for (const o of sel){
    const c = parseInt(o.getAttribute('data-count')||'0',10);
    if (c>0){ alert(`${o.getAttribute('data-name')||o.text} já está em grupos. Remova dos grupos antes de excluir.`); continue; }
    const opt = new Option(o.getAttribute('data-name')||o.text, o.value, false, false);
    exc.add(opt);
    avail.remove(o.index);
  }
}
function restoreExcluded(){
  const avail=document.getElementById('sel-disponiveis');
  const exc  =document.getElementById('sel-excluidos');
  const sel  =[...exc.options].filter(o=>o.selected);
  for (const o of sel){
    const opt = new Option(o.text, o.value, false, false);
    opt.setAttribute('data-name', o.text);
    opt.setAttribute('data-count', '0');
    setAvailLabel(opt);
    avail.add(opt);
    exc.remove(o.index);
  }
}

/* --------- util: desenha todas as linhas da tabela de escala --------- */
function refreshAllEscalaRows() {
  document.querySelectorAll('.grupo-select').forEach(s => {
    refreshEscalaRowByGroupId(s.id);
  });
}

/* --------- init e submit handler seguro --------- */
document.addEventListener('DOMContentLoaded', ()=> {
  [...document.getElementById('sel-disponiveis')?.options||[]].forEach(setAvailLabel);
  updateGroupCounters();
  if (typeof refreshAllEscalaRows === 'function') refreshAllEscalaRows();

  // registra foco/click para o “grupo alvo” do botão geral
  document.querySelectorAll('.grupo-select').forEach(sel=>{
    sel.addEventListener('focus', ()=>{ currentGroupId = sel.id; });
    sel.addEventListener('click', ()=>{ currentGroupId = sel.id; });
  });

  // reconta ao alterar limite de qualquer grupo (se houver qtd-grupo inputs)
  document.querySelectorAll('.qtd-grupo').forEach(inp=>{
    inp.addEventListener('input', updateGroupCounters);
  });

  // submit handler: marca options e previne double-submit
  const form = document.getElementById('form-escala');
  const btnSalvar = document.getElementById('btn-salvar');

  if (form) {
    form.addEventListener('submit', (ev) => {
      // marca todos os options para o backend receber a lista completa
      document.querySelectorAll('.grupo-select').forEach(sel => {
        [...sel.options].forEach(o => o.selected = true);
      });
      const exc = document.getElementById('sel-excluidos');
      if (exc) [...exc.options].forEach(o => o.selected = true);

      // desabilita botão para evitar double submit e mostra spinner
      if (btnSalvar) {
        btnSalvar.disabled = true;
        btnSalvar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...';
      }

      // deixamos o submit normal prosseguir (se preferir AJAX, posso mudar)
    });
  } else {
    console.warn('form-escala não encontrado — o submit pode não funcionar.');
  }
});
</script>
{% endif %}

{% endblock %}
