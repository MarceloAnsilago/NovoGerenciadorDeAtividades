{% extends "core/base.html" %}

{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0"><i class="bi bi-calendar3"></i> Plantões</h2>
  </div>

  <!-- Filtro -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" action="{% url 'plantao:lista_plantao' %}" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="data_inicial" class="form-label">Data inicial</label>
          <input type="date" id="data_inicial" name="data_inicial" class="form-control" value="{{ data_inicial }}">
        </div>
        <div class="col-md-4">
          <label for="data_final" class="form-label">Data final</label>
          <input type="date" id="data_final" name="data_final" class="form-control" value="{{ data_final }}">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-secondary w-100"><i class="bi bi-search"></i> Filtrar</button>
        </div>
      </form>
    </div>
  </div>

  {% include "partials/_messages.html" %}

  <!-- Descansos -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light"><strong><i class="bi bi-calendar-range"></i> Descansos no período</strong></div>
    <div class="card-body">
      {% if data_inicial and data_final %}
        {% if servidores_com_descanso %}
          {% include "partials/_descanso_por_servidor_table.html" with servidores_com_descanso=servidores_com_descanso only %}
        {% else %}
          <p class="text-muted mb-0">Nenhum servidor em descanso no período informado.</p>
        {% endif %}
      {% else %}
        <p class="text-muted mb-0">Selecione a data inicial e final e clique em <strong>Filtrar</strong>.</p>
      {% endif %}
    </div>
  </div>

  <!-- Montar escala: por grupos -->
  {% if data_inicial and data_final %}
  <div class="card shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <strong><i class="bi bi-people"></i> Montar escala do plantão (por grupos)</strong>
      <div class="small text-muted"><i class="bi bi-person-fill-slash"></i> Excluídos (descanso integral): {{ bloqueados|length }}</div>
    </div>
    <div class="card-body">
      <form method="post" action="{% url 'plantao:lista_plantao' %}">
        {% csrf_token %}
        <input type="hidden" name="data_inicial" value="{{ data_inicial }}">
        <input type="hidden" name="data_final" value="{{ data_final }}">

        {% include "partials/escala_grupos.html" %}


      </form>
    </div>
  </div>
  {% include "partials/escala_tabela.html" with grupos=grupos only %}

   <div class="mt-3">
          <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Salvar</button>
  </div>
  {% endif %}
</div>

<script>
let currentGroupId = null; // grupo alvo do botão “Adicionar →” geral

/* --------- utils --------- */
function getGroupLimit(groupId){
  const idx = groupId.replace('grupo-','');
  const el  = document.getElementById('qtd-'+idx);
  const n   = parseInt(el?.value || '0', 10);
  return isNaN(n) ? 0 : Math.max(0, n);
}
function updateGroupCounters(){
  document.querySelectorAll('.grupo-select').forEach(sel=>{
    const limit = getGroupLimit(sel.id);
    const count = sel.options.length;
    const idx   = sel.id.replace('grupo-','');
    const lbl   = document.getElementById('counter-grupo-'+idx);
    if (lbl) lbl.textContent = limit>0 ? `${count}/${limit}` : `${count}`;
    if (limit>0 && count>=limit) sel.classList.add('is-valid'); else sel.classList.remove('is-valid');
  });
}
function setAvailLabel(opt){
  const base = opt.getAttribute('data-name') || opt.text;
  const c = parseInt(opt.getAttribute('data-count')||'0',10);
  opt.text = c>0 ? `${base} (${c})` : base;
}
function incAvailCount(id, delta){
  const sel = document.getElementById('sel-disponiveis');
  const opt = [...(sel?.options||[])].find(o=>o.value===String(id));
  if (!opt) return;
  let c = parseInt(opt.getAttribute('data-count')||'0',10);
  c = Math.max(0, c + delta);
  opt.setAttribute('data-count', String(c));
  setAvailLabel(opt);
}

/* --------- escala (tabela) --------- */
function refreshEscalaRowByGroupId(groupId){
  const idx = groupId.replace('grupo-','');
  const sel = document.getElementById(groupId);
  const first = sel && sel.options[0];
  const nome = document.getElementById('escala-nome-'+idx);
  const fone = document.getElementById('escala-fone-'+idx);
  if (!nome || !fone) return;

  if (first){
    nome.textContent = first.text;
    fone.textContent = first.getAttribute('data-phone') || '—';
  } else {
    nome.innerHTML = '<span class="text-muted">—</span>';
    fone.innerHTML = '<span class="text-muted">—</span>';
  }
}
function refreshAllEscalaRows(){
  document.querySelectorAll('.grupo-select').forEach(sel=>{
    refreshEscalaRowByGroupId(sel.id);
  });
}

/* --------- ações --------- */
function addToGroup(groupId){
  const avail = document.getElementById('sel-disponiveis');
  const target= document.getElementById(groupId);
  const excl  = document.getElementById('sel-excluidos');
  if (!avail || !target) return;

  const limit = getGroupLimit(groupId);
  const selected = [...avail.options].filter(o=>o.selected);

  for (const o of selected){
    if ([...excl.options].some(e=>e.value===o.value)) continue; // não adiciona excluídos
    if (limit>0 && target.options.length>=limit) break;

    const phone = o.getAttribute('data-phone') || '';
    const name  = o.getAttribute('data-name') || o.text;
    const clone = new Option(name, o.value, false, true);
    clone.setAttribute('data-phone', phone); // <-- leva telefone junto
    target.add(clone);
    incAvailCount(o.value, +1);
  }
  updateGroupCounters();
  refreshEscalaRowByGroupId(groupId); // <-- atualiza tabela da semana
}
function addToGroupSelected(){
  const groups = [...document.querySelectorAll('.grupo-select')];
  if (groups.length === 0) return;
  const target = currentGroupId ? document.getElementById(currentGroupId) : groups[0];
  if (!target) return;
  addToGroup(target.id);
}
function removeFromGroup(groupId){
  const sel = document.getElementById(groupId);
  const removing = [...sel.options].filter(o=>o.selected);
  for (const o of removing){
    sel.remove(o.index);
    incAvailCount(o.value, -1);
  }
  updateGroupCounters();
  refreshEscalaRowByGroupId(groupId); // <-- atualiza tabela da semana
}
function moveOption(id, dir){
  const sel = document.getElementById(id); if(!sel) return;
  if (dir<0){
    for (let i=0;i<sel.options.length;i++){
      const o=sel.options[i];
      if (o.selected && i>0 && !sel.options[i-1].selected){
        sel.insertBefore(o, sel.options[i-1]);
      }
    }
  } else {
    for (let i=sel.options.length-1;i>=0;i--){
      const o=sel.options[i];
      if (o.selected && i<sel.options.length-1 && !sel.options[i+1].selected){
        sel.insertBefore(sel.options[i+1], o);
      }
    }
  }
  refreshEscalaRowByGroupId(id); // <-- se mudou ordem, muda quem está na tabela
}
function excludeSelected(){
  const avail=document.getElementById('sel-disponiveis');
  const exc  =document.getElementById('sel-excluidos');
  const sel  =[...avail.options].filter(o=>o.selected);
  for (const o of sel){
    const c = parseInt(o.getAttribute('data-count')||'0',10);
    if (c>0){ alert(`${o.getAttribute('data-name')||o.text} já está em grupos. Remova dos grupos antes de excluir.`); continue; }
    const opt = new Option(o.getAttribute('data-name')||o.text, o.value, false, false);
    exc.add(opt);
    avail.remove(o.index);
  }
}
function restoreExcluded(){
  const avail=document.getElementById('sel-disponiveis');
  const exc  =document.getElementById('sel-excluidos');
  const sel  =[...exc.options].filter(o=>o.selected);
  for (const o of sel){
    const opt = new Option(o.text, o.value, false, false);
    opt.setAttribute('data-name', o.text);
    opt.setAttribute('data-count', '0');
    setAvailLabel(opt);
    avail.add(opt);
    exc.remove(o.index);
  }
}

/* --------- init --------- */
document.addEventListener('DOMContentLoaded', ()=>{
  [...document.getElementById('sel-disponiveis')?.options||[]].forEach(setAvailLabel);
  updateGroupCounters();
  refreshAllEscalaRows(); // desenha a tabela com o 1º de cada grupo no load

  // registra foco/click para o “grupo alvo” do botão geral
  document.querySelectorAll('.grupo-select').forEach(sel=>{
    sel.addEventListener('focus', ()=>{ currentGroupId = sel.id; });
    sel.addEventListener('click', ()=>{ currentGroupId = sel.id; });
  });
  // reconta ao alterar limite de qualquer grupo
  document.querySelectorAll('.qtd-grupo').forEach(inp=>{
    inp.addEventListener('input', updateGroupCounters);
  });
});

// no submit, marca todos os itens para o backend receber a lista completa
document.getElementById('form-escala')?.addEventListener('submit', () => {
  document.querySelectorAll('.grupo-select').forEach(sel => {
    [...sel.options].forEach(o => o.selected = true);
  });
  const exc = document.getElementById('sel-excluidos');
  if (exc) [...exc.options].forEach(o => o.selected = true);
});
</script>

{% endblock %}