{% extends "core/base.html" %}

{% block content %}
<div class="container py-3">
  <div class="mb-3">
    <h2 class="m-0"><i class="bi bi-calendar3"></i> Plantoes</h2>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" action="{% url 'plantao:lista_plantao' %}" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="data_inicial" class="form-label">Data inicial</label>
          <input type="date" id="data_inicial" name="data_inicial" class="form-control" value="{{ data_inicial }}">
        </div>
        <div class="col-md-4">
          <label for="data_final" class="form-label">Data final</label>
          <input type="date" id="data_final" name="data_final" class="form-control" value="{{ data_final }}">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-secondary w-100"><i class="bi bi-search"></i> Filtrar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong><i class="bi bi-list-ul"></i> Plantoes salvos</strong>
      <a href="{% url 'plantao:lista_plantao' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-clockwise me-1"></i> Atualizar
      </a>
    </div>

    <div class="card-body p-0">
      <div class="px-3 py-2 border-bottom">
        <form method="get" action="{% url 'plantao:lista_plantao' %}" class="d-flex align-items-end gap-2 flex-wrap">
          {% if data_inicial %}<input type="hidden" name="data_inicial" value="{{ data_inicial }}">{% endif %}
          {% if data_final %}<input type="hidden" name="data_final" value="{{ data_final }}">{% endif %}

          <div>
            <label for="ano" class="form-label small mb-0">Ano</label>
            <select id="ano" name="ano" class="form-select form-select-sm">
              <option value="">(Todos)</option>
              {% for y in years %}
                <option value="{{ y }}" {% if ano_selected and ano_selected == y %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <button type="submit" class="btn btn-sm btn-secondary">Filtrar</button>
          </div>
        </form>
      </div>

      <div id="plantoes-tabs-container" class="px-3 pt-3">
        {% if months_data %}
          <ul class="nav nav-tabs flex-wrap gap-1" id="plantoes-month-tabs" role="tablist">
            {% for month in months_data %}
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link {% if month_active %}{% if month_active == month.num %}active{% endif %}{% else %}{% if forloop.first %}active{% endif %}{% endif %}"
                  id="tab-{{ month.num }}"
                  data-bs-toggle="tab"
                  data-bs-target="#pane-{{ month.num }}"
                  type="button"
                  role="tab"
                  aria-controls="pane-{{ month.num }}"
                  aria-selected="{% if month_active %}{% if month_active == month.num %}true{% else %}false{% endif %}{% else %}{% if forloop.first %}true{% else %}false{% endif %}{% endif %}">
                  {{ month.label }}
                  <span class="badge {% if month.count %}bg-primary{% else %}bg-secondary{% endif %} ms-1">{{ month.count }}</span>
                </button>
              </li>
            {% endfor %}
          </ul>

          <div class="tab-content border-start border-end border-bottom p-3" id="plantoes-month-content">
            {% for month in months_data %}
              <div class="tab-pane fade {% if month_active %}{% if month_active == month.num %}show active{% endif %}{% else %}{% if forloop.first %}show active{% endif %}{% endif %}" id="pane-{{ month.num }}" role="tabpanel" aria-labelledby="tab-{{ month.num }}">
                <div class="table-responsive">
                  <table class="table mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Nome</th>
                        <th>Inicio</th>
                        <th>Fim</th>
                        <th>Criado por</th>
                        <th>Criado em</th>
                        <th class="text-end">Acoes</th>
                      </tr>
                    </thead>
                    <tbody class="plantoes-tbody">
                      {% for p in month.plantoes %}
                        <tr data-plantao-row="1" data-pk="{{ p.pk }}" data-month="{{ month.num }}">
                          <td>
                            {% if p.nome %}
                              {{ p.nome }}
                            {% else %}
                              {{ p.inicio|date:"d/m/Y" }} a {{ p.fim|date:"d/m/Y" }}
                            {% endif %}
                          </td>
                          <td>{{ p.inicio|date:"d/m/Y" }}</td>
                          <td>{{ p.fim|date:"d/m/Y" }}</td>
                          <td>
                            {% if p.criado_por %}
                              {{ p.criado_por.get_full_name|default:p.criado_por.username }}
                            {% else %}
                              -
                            {% endif %}
                          </td>
                          <td>{{ p.criado_em|date:"d/m/Y H:i" }}</td>
                          <td class="text-end">
                            <div class="btn-group">
                              <button class="btn btn-sm btn-outline-primary btn-open" data-pk="{{ p.pk }}" type="button">
                                <i class="bi bi-folder2-open"></i> Abrir
                              </button>
                              <button class="btn btn-sm btn-outline-danger btn-delete" data-pk="{{ p.pk }}" type="button">
                                <i class="bi bi-trash"></i> Excluir
                              </button>
                            </div>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted px-3 pb-3 pt-1 mb-0">Nenhum plantao salvo para o filtro atual.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div id="plantao-detalhe-container" class="mb-3"></div>

  <div class="mb-4">
    <button id="btn-imprimir-plantao" class="btn btn-outline-secondary no-print" style="display:none;">
      <i class="bi bi-printer-fill me-1"></i> Imprimir
    </button>
  </div>

  {% if conflito_abort %}
    <div class="card shadow-sm mb-4 border-danger">
      <div class="card-header bg-light">
        <strong class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Conflito de plantao</strong>
      </div>
      <div class="card-body">
        <p class="mb-2">
          Ja existe(m) plantao(oes) que conflitam com o periodo selecionado
          (<strong>{{ data_inicial|date:"d/m/Y" }} a {{ data_final|date:"d/m/Y" }}</strong>).
        </p>

        {% if plantoes_conflitantes %}
          <div class="mb-2">
            <strong>Periodos conflitantes:</strong>
            <ul class="mb-0">
              {% for p in plantoes_conflitantes %}
                <li>{{ p.inicio|date:"d/m/Y" }} a {{ p.fim|date:"d/m/Y" }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <p class="text-muted mb-0">
          Altere o periodo antes de tentar salvar ou use a secao de plantoes salvos acima.
        </p>
      </div>
    </div>
  {% else %}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light"><strong><i class="bi bi-calendar-range"></i> Descansos no periodo</strong></div>
      <div class="card-body">
        {% if data_inicial and data_final %}
          {% if servidores_com_descanso %}
            {% include "partials/_descanso_por_servidor_table.html" with servidores_com_descanso=servidores_com_descanso only %}
          {% else %}
            <p class="text-muted mb-0">Nenhum servidor em descanso no periodo informado.</p>
          {% endif %}
        {% else %}
          <p class="text-muted mb-0">Selecione a data inicial e final e clique em <strong>Filtrar</strong>.</p>
        {% endif %}
      </div>
    </div>

    {% if data_inicial and data_final %}
      <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <strong><i class="bi bi-people"></i> Montar escala do plantao (por grupos)</strong>
          <div class="small text-muted"><i class="bi bi-person-fill-slash"></i> Excluidos (descanso integral): {{ bloqueados|length }}</div>
        </div>
        <div class="card-body">
          <form id="form-escala" method="post" action="{% url 'plantao:lista_plantao' %}">
            {% csrf_token %}
            <input type="hidden" name="data_inicial" value="{{ data_inicial }}">
            <input type="hidden" name="data_final" value="{{ data_final }}">

            <div class="alert alert-info py-2 small">
              <strong>Dica:</strong> para adicionar um servidor ao grupo da semana, selecione-o na coluna <em>Disponiveis</em> e depois clique em <strong>Adicionar -&gt;</strong> no cartao do grupo correspondente.
            </div>

            {% include "partials/escala_grupos.html" %}

            <div class="mt-3">
              <button type="submit" id="btn-salvar" class="btn btn-primary">
                <i class="bi bi-save"></i> Salvar
              </button>
            </div>
          </form>
        </div>
      </div>

      {% include "partials/escala_tabela.html" with grupos=grupos only %}
    {% endif %}
  {% endif %}
</div>

<span id="plantao-fragment-url-base" data-url="{% url 'plantao:plantao_detalhe_fragment' pk=0 %}" style="display:none;"></span>

<script>
(function () {
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const c = cookies[i].trim();
        if (c.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(c.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');
  let currentPlantaoPk = null;

  document.addEventListener('click', async (ev) => {
    const detalheContainer = document.getElementById('plantao-detalhe-container');
    const btnPrint = document.getElementById('btn-imprimir-plantao');
    const baseUrlEl = document.getElementById('plantao-fragment-url-base');
    const baseFragmentUrl = baseUrlEl ? baseUrlEl.getAttribute('data-url') : null;

    const getPlantaoRows = (pk = null) => {
      const selector = pk ? `[data-plantao-row="1"][data-pk="${pk}"]` : '[data-plantao-row="1"]';
      return Array.from(document.querySelectorAll(selector));
    };
    const clearRowHighlights = () => getPlantaoRows().forEach((r) => r.classList.remove('table-active'));
    const highlightRows = (pk) => getPlantaoRows(pk).forEach((r) => r.classList.add('table-active'));
    const removeRows = (pk) => getPlantaoRows(pk).forEach((r) => r.remove());

    const btnOpen = ev.target.closest('.btn-open');
    if (btnOpen) {
      ev.preventDefault();
      const pk = btnOpen.getAttribute('data-pk');
      if (!pk) return;

      const url = baseFragmentUrl ? baseFragmentUrl.replace('/0/', `/${pk}/`) : `/plantao/${pk}/detalhe-fragment/`;
      const originalHtml = btnOpen.innerHTML;
      btnOpen.disabled = true;
      btnOpen.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Carregando...';

      try {
        const resp = await fetch(url, { credentials: 'same-origin' });
        if (!resp.ok) {
          if (detalheContainer) detalheContainer.innerHTML = `<div class="alert alert-danger">Erro ao carregar escala (HTTP ${resp.status}).</div>`;
          if (btnPrint) btnPrint.style.display = 'none';
          currentPlantaoPk = null;
          clearRowHighlights();
        } else {
          const html = await resp.text();
          if (detalheContainer) detalheContainer.innerHTML = html || '<div class="alert alert-warning">Fragmento vazio.</div>';
          detalheContainer?.scrollIntoView({ behavior: 'smooth', block: 'start' });
          currentPlantaoPk = pk;
          if (btnPrint) btnPrint.style.display = 'inline-block';
          clearRowHighlights();
          highlightRows(pk);
        }
      } catch (err) {
        if (detalheContainer) detalheContainer.innerHTML = '<div class="alert alert-danger">Erro inesperado ao carregar escala.</div>';
        if (btnPrint) btnPrint.style.display = 'none';
        currentPlantaoPk = null;
        clearRowHighlights();
      } finally {
        btnOpen.disabled = false;
        btnOpen.innerHTML = originalHtml;
      }
      return;
    }

    const btnDel = ev.target.closest('.btn-delete');
    if (btnDel) {
      ev.preventDefault();
      const pk = btnDel.getAttribute('data-pk');
      if (!pk) return;
      if (!confirm('Confirma exclusao deste plantao? Esta acao nao podera ser desfeita.')) return;

      if (!btnDel.dataset.origHtml) btnDel.dataset.origHtml = btnDel.innerHTML;
      const origHtml = btnDel.dataset.origHtml;
      const url = `{% url 'plantao:plantao_excluir' pk=0 %}`.replace('/0/', `/${pk}/`);

      try {
        btnDel.disabled = true;
        btnDel.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Excluindo...';

        const resp = await fetch(url, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'X-CSRFToken': csrftoken,
            'Accept': 'application/json',
          },
        });

        const text = await resp.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch (e) { data = null; }

        if (resp.ok && data && data.ok) {
          removeRows(pk);
          if (String(currentPlantaoPk) === String(pk)) {
            if (detalheContainer) detalheContainer.innerHTML = '';
            currentPlantaoPk = null;
            if (btnPrint) btnPrint.style.display = 'none';
          }
        } else {
          const serverMsg = data && data.erro ? data.erro : null;
          const message = serverMsg || `Erro ao excluir (HTTP ${resp.status}).`;
          alert(message);
        }
      } catch (err) {
        alert('Erro de comunicacao ao tentar excluir.');
      } finally {
        btnDel.disabled = false;
        btnDel.innerHTML = origHtml;
      }
      return;
    }
  });

  const btnPrint = document.getElementById('btn-imprimir-plantao');
  btnPrint?.addEventListener('click', (ev) => {
    ev.preventDefault();
    if (!currentPlantaoPk) {
      alert('Nenhum plantao carregado para imprimir.');
      return;
    }

    const printCss = `
      @media print {
        body * { visibility: hidden !important; }
        #plantao-detalhe-container, #plantao-detalhe-container * { visibility: visible !important; }
        #plantao-detalhe-container { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; }
        .no-print { display: none !important; }
        @page { margin: 12mm; }
      }
    `;
    const styleEl = document.createElement('style');
    styleEl.id = 'print-only-style';
    styleEl.appendChild(document.createTextNode(printCss));
    document.head.appendChild(styleEl);

    setTimeout(() => {
      try {
        window.print();
      } finally {
        setTimeout(() => {
          document.getElementById('print-only-style')?.remove();
        }, 300);
      }
    }, 150);
  });
})();
</script>

{% if not conflito_abort %}
<script>
let currentGroupId = null;

function updateGroupCounters(){
  document.querySelectorAll('.grupo-select').forEach(sel=>{
    const count = sel.options.length;
    const idx = sel.id.replace('grupo-','');
    const lbl = document.getElementById('counter-grupo-'+idx);
    if (lbl) lbl.textContent = `${count}`;
    sel.classList.remove('is-valid', 'is-invalid');
  });
}
function setAvailLabel(opt){
  const base = opt.getAttribute('data-name') || opt.text;
  const c = parseInt(opt.getAttribute('data-count')||'0',10);
  opt.text = c>0 ? `${base} (${c})` : base;
}
function incAvailCount(id, delta){
  const sel = document.getElementById('sel-disponiveis');
  const opt = [...(sel?.options||[])].find(o=>o.value===String(id));
  if (!opt) return;
  let c = parseInt(opt.getAttribute('data-count')||'0',10);
  c = Math.max(0, c + delta);
  opt.setAttribute('data-count', String(c));
  setAvailLabel(opt);
}

function escapeHtml(s){ return s ? s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;") : ""; }
function refreshEscalaRowByGroupId(groupId){
  const idx = groupId.replace('grupo-','');
  const sel = document.getElementById(groupId);
  const nomes = document.getElementById('escala-nome-'+idx);
  const fones = document.getElementById('escala-fone-'+idx);
  if (!nomes || !fones) return;

  const opts = sel ? [...sel.options] : [];
  if (opts.length === 0){
    nomes.innerHTML = '<span class="text-muted">-</span>';
    fones.innerHTML = '<span class="text-muted">-</span>';
    return;
  }

  const nomesLis = opts.map(o => `<li>${escapeHtml(o.text)}</li>`).join('');
  const fonesLis = opts.map(o => `<li>${escapeHtml(o.getAttribute('data-phone') || '-')}</li>`).join('');

  nomes.innerHTML = `<ul class="list-unstyled mb-0">${nomesLis}</ul>`;
  fones.innerHTML = `<ul class="list-unstyled mb-0">${fonesLis}</ul>`;
}

async function verificarDescanso(servidorId, inicio, fim) {
  const url = `/plantao/verificar-descanso/?servidor_id=${servidorId}&inicio=${inicio}&fim=${fim}`;
  const resp = await fetch(url, { credentials: 'same-origin' });
  if (!resp.ok) return false;
  const data = await resp.json();
  if (data.bloqueado) {
    const msg = data.impedimentos.map(i => {
      const tipo = i.tipo || '';
      const obs  = i.observacoes ? ` - ${i.observacoes}` : '';
      return `* ${tipo}${obs} (${i.data_inicio} a ${i.data_fim})`;
    }).join('\n');
    alert(`Servidor impedido nesta semana:\n${msg}`);
    return true;
  }
  return false;
}

async function addToGroup(groupId){
  const avail = document.getElementById('sel-disponiveis');
  const target = document.getElementById(groupId);
  const excl = document.getElementById('sel-excluidos');
  if (!avail || !target) return;

  const selected = [...avail.options].filter(o=>o.selected);
  if (selected.length === 0) return;

  const idx = groupId.replace('grupo-', '');
  const elSemana = document.getElementById(`grupo-${idx}-periodo`);
  const [inicio, fim] = elSemana?.value?.split(' a ') || [];

  const duplicates = [];

  for (const o of selected){
    if ([...excl.options].some(e=>e.value===o.value)) continue;
    if ([...(target.options||[])].some(e=>e.value===o.value)) {
      duplicates.push(o.getAttribute('data-name') || o.text);
      continue;
    }

    const impedido = await verificarDescanso(o.value, inicio, fim);
    if (impedido) continue;

    const phone = o.getAttribute('data-phone') || '';
    const name = o.getAttribute('data-name') || o.text;
    const clone = new Option(name, o.value, false, true);
    clone.setAttribute('data-phone', phone);
    clone.setAttribute('data-name', name);
    target.add(clone);

    incAvailCount(o.value, +1);
  }

  if (duplicates.length > 0) {
    alert('Os seguintes servidores ja estao neste grupo:\n\n' + duplicates.join('\n'));
  }

  updateGroupCounters();
  refreshEscalaRowByGroupId(groupId);
}

function addToGroupSelected(){
  const groups = [...document.querySelectorAll('.grupo-select')];
  if (groups.length === 0) return;
  const target = currentGroupId ? document.getElementById(currentGroupId) : groups[0];
  if (!target) return;
  addToGroup(target.id);
}

function removeFromGroup(groupId){
  const sel = document.getElementById(groupId);
  const removing = [...sel.options].filter(o=>o.selected);
  for (const o of removing){
    sel.remove(o.index);
    incAvailCount(o.value, -1);
  }
  updateGroupCounters();
  refreshEscalaRowByGroupId(groupId);
}

function moveOption(id, dir){
  const sel = document.getElementById(id); if(!sel) return;
  if (dir<0){
    for (let i=0;i<sel.options.length;i++){
      const o=sel.options[i];
      if (o.selected && i>0 && !sel.options[i-1].selected){
        sel.insertBefore(o, sel.options[i-1]);
      }
    }
  } else {
    for (let i=sel.options.length-1;i>=0;i--){
      const o=sel.options[i];
      if (o.selected && i<sel.options.length-1 && !sel.options[i+1].selected){
        sel.insertBefore(sel.options[i+1], o);
      }
    }
  }
  refreshEscalaRowByGroupId(id);
}

function excludeSelected(){
  const avail = document.getElementById('sel-disponiveis');
  const exc = document.getElementById('sel-excluidos');
  const sel = [...avail.options].filter(o=>o.selected);
  for (const o of sel){
    const c = parseInt(o.getAttribute('data-count')||'0',10);
    if (c>0){
      alert(`${o.getAttribute('data-name')||o.text} ja esta em grupos. Remova dos grupos antes de excluir.`);
      continue;
    }
    const opt = new Option(o.getAttribute('data-name')||o.text, o.value, false, false);
    exc.add(opt);
    avail.remove(o.index);
  }
}

function restoreExcluded(){
  const avail = document.getElementById('sel-disponiveis');
  const exc = document.getElementById('sel-excluidos');
  const sel = [...exc.options].filter(o=>o.selected);
  for (const o of sel){
    const opt = new Option(o.text, o.value, false, false);
    opt.setAttribute('data-name', o.text);
    opt.setAttribute('data-count', '0');
    setAvailLabel(opt);
    avail.add(opt);
    exc.remove(o.index);
  }
}

function refreshAllEscalaRows() {
  document.querySelectorAll('.grupo-select').forEach(s => {
    refreshEscalaRowByGroupId(s.id);
  });
}

document.addEventListener('DOMContentLoaded', ()=> {
  [...document.getElementById('sel-disponiveis')?.options||[]].forEach(setAvailLabel);
  updateGroupCounters();
  refreshAllEscalaRows();

  document.querySelectorAll('.grupo-select').forEach(sel=>{
    sel.addEventListener('focus', ()=>{ currentGroupId = sel.id; });
    sel.addEventListener('click', ()=>{ currentGroupId = sel.id; });
  });

  document.querySelectorAll('.qtd-grupo').forEach(inp=>{
    inp.addEventListener('input', updateGroupCounters);
  });

  const form = document.getElementById('form-escala');
  const btnSalvar = document.getElementById('btn-salvar');

  if (form) {
    form.addEventListener('submit', () => {
      document.querySelectorAll('.grupo-select').forEach(sel => {
        [...sel.options].forEach(o => o.selected = true);
      });
      const exc = document.getElementById('sel-excluidos');
      if (exc) [...exc.options].forEach(o => o.selected = true);

      if (btnSalvar) {
        btnSalvar.disabled = true;
        btnSalvar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...';
      }
    });
  }
});
</script>
{% endif %}

{% endblock %}
