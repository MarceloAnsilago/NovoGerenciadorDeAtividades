{% load static %}
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Relatório semanal — {{ periodo.0|date:"d/m/Y" }} → {{ periodo.1|date:"d/m/Y" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <style>
    html,body{background:#fff;color:#111}
    body{margin:10mm;font:12px/1.35 -apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    h1{font-size:18px;margin:0}
    .muted{color:#666}
    .dia{margin-top:12px;page-break-inside:avoid}
    .dia h4{font-size:14px;margin:0 0 6px}
    table{width:100%;border-collapse:collapse}
    thead th{background:#f5f7fa;border:1px solid #e9eef8;padding:6px;font-weight:700}
    tbody td{border:1px solid #eef2f7;padding:6px;vertical-align:top}
    .col-veic{width:220px}
    .col-real{width:120px;text-align:center}
    .check{display:inline-block;width:14px;height:14px;border:1px solid #111;margin:0 4px;vertical-align:middle}
    .telefone{color:#444;white-space:nowrap}
    footer{margin-top:14px;color:#666;font-size:11px;display:flex;justify-content:space-between}
    @media print { body{margin:6mm} .no-print{display:none!important} }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Relatório semanal</h1>
      <div class="muted">
        Período: {{ periodo.0|date:"d/m/Y" }} → {{ periodo.1|date:"d/m/Y" }}
        · Unidade: {{ request.user|default_if_none:"" }}
      </div>
    </div>
    <div class="text-end">
      <div class="muted">Gerado por</div>
      <div><strong>{{ request.user.get_full_name|default:request.user.username }}</strong></div>
    </div>
  </header>

  {% for d in semana %}
    {% if d.atividades or not d.is_weekend %}
      <section class="dia">
        <h4>{{ d.nome_semana }} ({{ d.data|date:"d/m/Y" }})</h4>
        {% if d.atividades %}
          <table role="table">
            <thead>
              <tr>
                <th>Atividade</th>
                <th>Servidores</th>
                <th class="col-veic">Veículo</th>
                <th class="col-real">Realizada</th>
              </tr>
            </thead>
            <tbody>
            {% for a in d.atividades %}
              <tr>
                <td>{{ a.titulo }}</td>
                <td>
                  {% if a.servidores and a.servidores|length > 0 %}
                    <ul class="mb-0 ps-3">
                      {% for s in a.servidores %}
                        <li>
                          <span>{{ s.nome }}</span>
                          {% if s.telefone %}<span class="telefone"> — ({{ s.telefone }})</span>{% endif %}
                          <span class="ms-2 muted">[<span class="check"></span> Sim <span class="check"></span> Não]</span>
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <div class="muted">—</div>
                  {% endif %}
                </td>
                <td>{{ a.veiculo|default:"Nenhum - veiculo" }}</td>
                <td class="col-real"><span class="check"></span> Sim &nbsp; <span class="check"></span> Não</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="muted">Nenhuma atividade registrada neste dia.</div>
        {% endif %}
      </section>
    {% endif %}
  {% endfor %}

  {% if plantonistas_semana and plantonistas_semana|length %}
    <hr class="my-3">
    <section aria-label="Plantonistas da semana">
      <h6>Plantonista(s) da semana</h6>
      <ul class="mb-0">
        {% for p in plantonistas_semana %}
          <li>{{ p.nome }}{% if p.telefone %} — ({{ p.telefone }}){% endif %}</li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}

  <footer>
    <div>Gerado por: <strong>{{ request.user.get_full_name|default:request.user.username }}</strong></div>
    <div>Data: {{ now|date:"d/m/Y H:i" }}</div>
  </footer>

  <script>
    // imprime automaticamente e tenta fechar a janela apos concluir
    (function () {
      let closed = false;

      function tryClose() {
        if (closed) return;
        closed = true;
        try { window.close(); } catch (_) { /* noop */ }
      }

      function bindAutoClose() {
        window.addEventListener('afterprint', tryClose, { once: true });
        const mq = window.matchMedia?.('print');
        if (mq?.addEventListener) {
          const handler = (ev) => {
            if (!ev.matches) {
              mq.removeEventListener('change', handler);
              tryClose();
            }
          };
          mq.addEventListener('change', handler);
        }
      }

      window.addEventListener('load', () => {
        bindAutoClose();
        setTimeout(() => {
          try { window.print(); } catch (_) { /* noop */ }
        }, 200);
      });
    })();
  </script>
</body>
</html>

