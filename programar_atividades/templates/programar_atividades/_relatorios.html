{# templates/programar_atividades/_relatorios.html — corrigido #}
{% load static %}

<style>
/* estilos locais */
.square-radio { -webkit-appearance:none; appearance:none; width:16px; height:16px; border:1px solid #6c757d; border-radius:3px; display:inline-block; vertical-align:middle; margin-right:6px; cursor:pointer; background:white; }
.square-radio:checked{ background:#0d6efd; border-color:#0d6efd; }
.small-label{ font-size:.9rem; vertical-align:middle; margin-left:6px; }
.serv-list{ display:flex; flex-direction:column; gap:6px; align-items:stretch; }
.serv-list-item{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:4px 0; }
.serv-name{ flex:1; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; margin-right:12px; font-weight:600; font-size:.95rem; }

@media (max-width:767.98px){ .serv-list-item{ flex-direction:column; align-items:flex-start; } .serv-name{ width:100%; } }
@media print{ .table{ font-size:11px } .small-label{font-size:11px} h5{font-size:14px} .square-radio{width:12px;height:12px} }
.plantonistas-box { margin-top:1.25rem; margin-bottom:1rem; }
.plantonistas-box h6 { display:flex; align-items:center; gap:.5rem; }
.print-buttons, #relatorio-actions { margin-top:0.75rem; display:flex; gap:0.5rem; }
</style>

<div class="mb-3">
  <h4 class="fw-bold mb-1">Relatório semanal</h4>
  <div class="text-muted small">{{ start|date:"d/m/Y" }} &rarr; {{ end|date:"d/m/Y" }}</div>
</div>

{# --- Corpo: dias da semana --- #}
{% for dia in semana %}
  {% if dia.atividades or not dia.is_weekend %}
    <h5 class="mt-4 mb-2">
      <i class="bi bi-calendar-event me-1 text-primary" aria-hidden="true"></i>
      {{ dia.nome_semana }} ({{ dia.data|date:"d/m/Y" }})
      {% if dia.plantonista %}
        <span class="badge bg-info text-dark ms-3">
          Plantonista:
          {% for p in dia.plantonista %}{{ p.nome }}{% if not forloop.last %}, {% endif %}{% endfor %}
        </span>
      {% endif %}
    </h5>

    {% if dia.atividades %}
      <div class="table-responsive mb-3">
        <table class="table table-bordered table-sm align-middle">
          <thead class="table-light text-center">
            <tr>
              <th style="min-width:220px">Atividade</th>
              <th style="min-width:300px">Servidores</th>
              <th style="min-width:160px">Veículo</th>
              <th style="width:140px">Realizada</th>
            </tr>
          </thead>
          <tbody>
            {% for atividade in dia.atividades %}
              <tr>
                <td class="align-middle">{{ atividade.titulo }}</td>

                <td class="align-middle">
                  <div class="serv-list">
                    {% for servidor in atividade.servidores %}
                      <div class="serv-list-item">
                        <div class="serv-name" title="{{ servidor.nome }}">{{ servidor.nome }}</div>

                        <div class="d-flex align-items-center">
                          <label class="d-flex align-items-center me-2" title="Participou - Sim">
                            <input type="radio" class="square-radio"
                                   name="srv-d{{ forloop.parentloop.parentloop.counter0 }}-a{{ forloop.parentloop.counter0 }}-s{{ forloop.counter0 }}"
                                   value="sim" aria-label="Sim">
                            <span class="small-label">Sim</span>
                          </label>

                          <label class="d-flex align-items-center" title="Participou - Não">
                            <input type="radio" class="square-radio"
                                   name="srv-d{{ forloop.parentloop.parentloop.counter0 }}-a{{ forloop.parentloop.counter0 }}-s{{ forloop.counter0 }}"
                                   value="nao" aria-label="Não">
                            <span class="small-label">Não</span>
                          </label>
                        </div>
                      </div>
                    {% empty %}
                      <div class="text-muted">— nenhum servidor listado —</div>
                    {% endfor %}
                  </div>
                </td>

                <td class="align-middle text-center">{{ atividade.veiculo|default:"—" }}</td>

                <td class="align-middle text-center">
                  <div class="d-flex align-items-center justify-content-center gap-3">
                    <label class="d-flex align-items-center" title="Atividade realizada - Sim">
                      <input type="radio" class="square-radio"
                             name="act-d{{ forloop.parentloop.counter0 }}-a{{ forloop.counter0 }}-status"
                             value="sim" aria-label="Atividade realizada - Sim">
                      <span class="small-label">Sim</span>
                    </label>

                    <label class="d-flex align-items-center" title="Atividade realizada - Não">
                      <input type="radio" class="square-radio"
                             name="act-d{{ forloop.parentloop.counter0 }}-a{{ forloop.counter0 }}-status"
                             value="nao" aria-label="Atividade realizada - Não">
                      <span class="small-label">Não</span>
                    </label>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted mb-3">Nenhuma atividade registrada neste dia.</div>
    {% endif %}
  {% endif %}
{% endfor %}

<div class="text-muted small mt-3">
  Observação: marque "Sim" para a atividade / servidor caso tenham participado ou a atividade
  tenha sido realizada. Esses controles são visuais — implemente o envio ao servidor no backend para persistência quando estiver pronto.
</div>

{# --- BOTÕES: sempre visíveis (fora do bloco de plantonistas) --- #}
<div id="relatorio-actions" class="mt-2 d-flex gap-2">
  <button id="btnImprimirProgramacao"
          class="btn btn-sm btn-outline-primary"
          data-start="{{ start|date:'Y-m-d' }}"
          data-end="{{ end|date:'Y-m-d' }}">
    <i class="bi bi-printer"></i>&nbsp;Imprimir programação
  </button>

  <button id="btnImprimirVista"
          class="btn btn-sm btn-outline-secondary"
          data-start="{{ start|date:'Y-m-d' }}"
          data-end="{{ end|date:'Y-m-d' }}">
    <i class="bi bi-file-earmark-pdf"></i>&nbsp;Visualizar para impressão
  </button>
</div>

{# --- PLANTONISTAS da semana: apenas aqui no final, quando existir --- #}
{% if plantonistas_semana and plantonistas_semana|length %}
  <div id="plantonistas-semana-final" class="plantonistas-box">
    <h6 class="fw-semibold mb-2">
      <span class="badge bg-light border me-2"><i class="bi bi-person-badge text-primary"></i></span>
      Plantonista(s) da semana
    </h6>
    <ul class="mb-0">
      {% for p in plantonistas_semana %}
        <li>{{ p.nome }}{% if p.telefone %} — ({{ p.telefone }}){% endif %}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}
