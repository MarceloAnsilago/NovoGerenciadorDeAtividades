{% extends "core/base.html" %}
{% load static %}

{% block extra_head %}
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    #calendar{max-width:1100px;margin:24px auto;min-height:520px;background:#fff;padding:8px}

    /* -------- Metas (topo) -------- */
    .metas-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
    .meta-card{
      border:1px solid #e3e6ef;border-radius:.8rem;padding:14px;background:#fff;
      display:flex;flex-direction:column;gap:8px;transition:.15s;cursor:pointer;
    }
    .meta-card:hover{box-shadow:0 4px 18px rgba(2,6,23,.08);border-color:#cfd6e4;background:#fbfdff}
    .meta-card.selected{border-color:#0d6efd;box-shadow:0 0 0 3px rgba(13,110,253,.15)}
    .meta-head{display:flex;align-items:center;gap:.5rem}
    .meta-head .icon{width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;border-radius:.5rem;background:#eef5ff;color:#0d6efd}
    .meta-title{font-weight:700;margin:0}
    .meta-sep{height:1px;background:#eef1f5}
    .meta-small{font-size:.875rem;color:#6c757d}
    .meta-progress .progress{height:6px}
    .meta-progress .summary{font-size:.8rem;color:#6c757d}

    /* -------- Linha principal -------- */
    .cards-row{display:grid;grid-template-columns:340px 340px 1fr;gap:16px;overflow-x:auto;padding-bottom:4px}
    @media (max-width:991.98px){.cards-row{grid-template-columns:1fr}}
    .servidor-cardbox{min-width:340px;max-width:340px}
    #metaCardsContainer{display:flex;gap:16px;min-width:340px}
    #metaCardsContainer .servidor-cardbox{min-width:340px;max-width:340px}

    .servidor-cardbox .card-header{background:#f8fafc;border-bottom-color:#e9edf3}
    .servidor-cardbox .card-body{padding:12px}
    .servidores-grid{display:grid;grid-template-columns:1fr;gap:10px}

    /* -------- Itens de servidor -------- */
    .servidor-card{
      border:1px solid #e3e6ef;border-radius:.6rem;padding:8px 10px;background:#fff;
      display:flex;align-items:center;justify-content:center;min-height:38px;font-weight:600;color:#1f2937;
      position:relative;transition:.15s;cursor:grab;user-select:none;
    }
    .servidor-card:active{cursor:grabbing}
    .servidor-card:hover{box-shadow:0 4px 18px rgba(2,6,23,.08);border-color:#cfd6e4;background:#f9fbff}

    .srv-count-badge{
      position:absolute;top:-8px;right:-8px;background:#0d6efd;color:#fff;border-radius:999px;
      font-size:.7rem;padding:2px 6px;line-height:1;display:none;pointer-events:none;
    }
    .servidor-card.has-count .srv-count-badge{display:inline-block}

    /* Chips dentro das metas */
    .servidor-chip{border:1px solid #e3e6ef;border-radius:.6rem;padding:6px 10px;background:#fff;display:flex;align-items:center;gap:10px;min-height:36px;font-weight:600;color:#1f2937}
    .servidor-chip .chip-name{flex:1;text-align:center}
    .servidor-chip .chip-remove{border:0;background:#f1f3f5;color:#333;border-radius:.35rem;padding:2px 8px;font-weight:700;cursor:pointer}
    .servidor-chip .chip-remove:hover{background:#e9ecef}

    /* Dropzones */
    .dropzone{min-height:42px;border:2px dashed transparent;border-radius:.5rem;transition:border-color .15s,background-color .15s}

    /* Destaque o CARD INTEIRO da meta quando estiver como alvo de drop */
    .servidor-cardbox[data-meta-id].dz-hover{
      outline:2px dashed #0d6efd; outline-offset:-4px; background:#eef5ff;
    }

    .servidor-card.dragging{opacity:.7;transform:scale(.98)}

    /* Header bonito do card de meta (direita) */
    .meta-header-title{display:flex;align-items:center;gap:.5rem}
    .meta-header-sep{height:1px;background:#e9edf3;margin-top:6px}
  </style>
{% endblock %}


{% block content %}
  <div class="container my-4">
    <h1>Programar Atividades</h1>
    <div id="calendar" class="mt-4"></div>
  </div>

  <div class="modal fade" id="modalAtividade" tabindex="-1" aria-labelledby="modalAtividadeLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-center w-100" id="modalAtividadeLabel">Programar atividades</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body">
          <form id="formAtividade">
            <input type="hidden" id="dataAtividade" name="data">
            <input type="hidden" id="metaId" name="meta_id">

            <!-- METAS -->
            <div class="mb-2">
              <label class="form-label">Escolha a meta</label>
              <div id="metasGrid" class="metas-grid"></div>
            </div>

            <hr class="my-4">

            <div class="cards-row mb-3">
              <!-- expediente -->
              <div class="card shadow-sm servidor-cardbox">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span class="fw-semibold">Expediente administrativo</span>
                  <span class="badge bg-secondary" id="countExpedienteAdmin">0</span>
                </div>
                <div class="card-body">
                  <div id="expedienteAdmin" class="servidores-grid"></div>
                </div>
              </div>

              <!-- disponíveis -->
              <div class="card shadow-sm servidor-cardbox">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span class="fw-semibold">Servidores disponíveis</span>
                  <span class="badge bg-secondary" id="countServidoresLivres">0</span>
                </div>
                <div class="card-body">
                  <div id="servidoresLivres" class="servidores-grid"></div>
                </div>
              </div>

              <!-- coluna de metas -->
              <div id="metaCardsContainer"></div>
            </div>

            <!-- impedidos -->
            <div class="mt-3">
              <div class="card shadow-sm" style="max-width:100%;min-width:unset;">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span class="fw-semibold">Servidores impedidos</span>
                  <span class="badge bg-secondary" id="countServidoresImpedidos">0</span>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle mb-0" id="tabelaImpedidos">
                      <thead class="table-light"><tr><th>Nome</th><th>Motivo</th></tr></thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

          </form>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" form="formAtividade" id="btnSalvar" class="btn btn-primary" disabled>Salvar</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>

  <script>
    window.calendarFeedURL = "{% url 'programar_atividades:events_feed' %}";
    window.metasURL        = "{% url 'programar_atividades:metas_disponiveis' %}";
    window.servidoresURL   = "{% url 'programar_atividades:servidores_para_data' %}";
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const calendarEl   = document.getElementById('calendar');
    const modalEl      = document.getElementById('modalAtividade');
    const tituloModal  = document.getElementById('modalAtividadeLabel');
    const inputData    = document.getElementById('dataAtividade');
    const metasGrid    = document.getElementById('metasGrid');
    const hiddenMetaId = document.getElementById('metaId');
    const btnSalvar    = document.getElementById('btnSalvar');
    const metaCardsContainer = document.getElementById('metaCardsContainer');

    const setSalvarEnabled = (on) => btnSalvar.disabled = !on;

    const allocations = {};    // sid -> total em todas as metas
    const servidoresData = []; // cache de servidores (id, nome, ...)
    const findSrv = sid => servidoresData.find(s => String(s.id) === String(sid));
    const DRAG = { id:null };  // fallback universal

    const getMetaCard = (el) => el.closest('[data-meta-id]');

    /* ---------- UI helpers ---------- */
    function updateCounts() {
      const countLivres = document.getElementById('countServidoresLivres');
      const countExp    = document.getElementById('countExpedienteAdmin');
      const countImp    = document.getElementById('countServidoresImpedidos');

      if (countLivres) countLivres.textContent = String(document.querySelectorAll('#servidoresLivres .servidor-card').length);
      if (countExp)    countExp.textContent    = String(document.querySelectorAll('#expedienteAdmin .servidor-card').length);
      if (countImp)    countImp.textContent    = String(document.querySelectorAll('#tabelaImpedidos tbody tr').length || 0);

      metaCardsContainer.querySelectorAll('[data-meta-id]').forEach(card => {
        card.querySelector('.count-meta').textContent =
          String(card.querySelectorAll('.servidor-chip').length);
      });

      document.querySelectorAll('#servidoresLivres .servidor-card').forEach(el => {
        const n = allocations[el.dataset.id] || 0;
        const b = el.querySelector('.srv-count-badge');
        if (n > 0) { el.classList.add('has-count'); b.textContent = n; }
        else       { el.classList.remove('has-count'); b.textContent = ''; }
      });
    }

    function makeDisponivelCard(s) {
      const el = document.createElement('div');
      el.className = 'servidor-card';
      el.id = `srv-${s.id}`;       // ID visual (não usado no DnD)
      el.dataset.id = s.id;        // ID lógico do servidor (usado no DnD)
      el.textContent = s.nome;
      el.setAttribute('draggable','true');
      const badge = document.createElement('span');
      badge.className='srv-count-badge';
      el.appendChild(badge);
      return el;
    }

    function makeMetaChip(srv) {
      const chip = document.createElement('div');
      chip.className = 'servidor-chip';
      chip.dataset.id = srv.id;
      chip.innerHTML = `
        <span class="chip-name">${srv.nome}</span>
        <button type="button" class="chip-remove" title="Remover">&times;</button>`;

      chip.querySelector('.chip-remove').addEventListener('click', () => {
        chip.remove();
        const sid = String(srv.id);
        allocations[sid] = Math.max(0, (allocations[sid] || 0) - 1);

        // 👉 Se zerou alocações, volta para o expediente
        if ((allocations[sid] || 0) === 0) appendToExpediente(srv);

        updateCounts();
      });

      return chip;
    }
    function appendToExpediente(srv) {
      const exp = document.getElementById('expedienteAdmin');
      if (!exp.querySelector(`.servidor-card[data-id="${srv.id}"]`)) {
        const el = document.createElement('div');
        el.className = 'servidor-card';
        el.dataset.id = srv.id;
        el.textContent = srv.nome;
        exp.appendChild(el);
      }
    }

    function removeOneFromExpediente(sid) {
      const el = document.querySelector(`#expedienteAdmin .servidor-card[data-id="${sid}"]`);
      if (el) el.remove();
    }
   
    function ensureMetaCard(metaId, metaTitle) {
      let card = metaCardsContainer.querySelector(`[data-meta-id="${metaId}"]`);
      if (card) { card.querySelector('.meta-title-text').textContent = metaTitle; return card; }

      const wrapper = document.createElement('div');
      wrapper.className = 'card shadow-sm servidor-cardbox';
      wrapper.dataset.metaId = metaId;
      wrapper.innerHTML = `
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <div class="meta-header-title">
              <span class="icon"><i class="bi bi-clipboard2-check"></i></span>
              <span class="fw-semibold meta-title-text">${metaTitle}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-primary count-meta">0</span>
              <button type="button" class="btn btn-sm btn-outline-secondary meta-close" title="Fechar">&times;</button>
            </div>
          </div>
          <div class="meta-header-sep"></div>
        </div>
        <div class="card-body">
          <div class="servidores-grid meta-dropzone dropzone"></div>
        </div>`;

      // 🔧 Fechar meta: remover chips, atualizar allocations e devolver ao Expediente quando zerar
      wrapper.querySelector('.meta-close').addEventListener('click', () => {
        const removedCounts = {};

        // Remover visualmente todos os chips desse card e contar por servidor
        wrapper.querySelectorAll('.servidor-chip').forEach(ch => {
          const sid = String(ch.dataset.id);
          removedCounts[sid] = (removedCounts[sid] || 0) + 1;
          ch.remove();
        });

        // Abater dos allocations e devolver ao expediente se zerar no total
        Object.entries(removedCounts).forEach(([sid, qty]) => {
          allocations[sid] = Math.max(0, (allocations[sid] || 0) - qty);
          if ((allocations[sid] || 0) === 0) {
            const srv = findSrv(sid);
            if (srv) appendToExpediente(srv);
          }
        });

        wrapper.remove();
        updateCounts();
      });

      metaCardsContainer.appendChild(wrapper);
      updateCounts();
      return wrapper;
    }
    const cardTitle = (metaId) =>
      metasGrid.querySelector(`.meta-card[data-id="${metaId}"] .meta-title`)?.textContent?.trim() || 'Atividade';

    function addToMeta(serverId, metaId) {
      const sid = String(serverId);
      const srv = findSrv(sid);
      if (!srv) return;

      const card = ensureMetaCard(metaId, cardTitle(metaId));
      card.querySelector('.meta-dropzone').appendChild(makeMetaChip(srv));

      const prev = allocations[sid] || 0;
      allocations[sid] = prev + 1;

      // 👉 Se era 0 e virou 1, retira do expediente
      if (prev === 0) removeOneFromExpediente(sid);

      updateCounts();
    }

    /* ====== Drag & Drop ====== */

    // Evita que arquivos soltos naveguem fora das zonas
    window.addEventListener('dragover', e => e.preventDefault());
    window.addEventListener('drop',     e => e.preventDefault());

    // Drag em "Servidores disponíveis" -> gravamos o SID
    document.addEventListener('dragstart', (e) => {
      const card = e.target.closest('#servidoresLivres .servidor-card');
      if (!card) return;

      const sid = card.dataset.id;
      DRAG.id = sid;

      if (e.dataTransfer) {
        e.dataTransfer.setData('application/x-sid', sid);
        e.dataTransfer.setData('text/plain', `sid:${sid}`); // fallback texto
        e.dataTransfer.effectAllowed = 'copy';
      }

      card.classList.add('dragging');
    }, true);

    document.addEventListener('dragend', (e) => {
      const card = e.target.closest('#servidoresLivres .servidor-card');
      if (card) card.classList.remove('dragging');
      DRAG.id = null;
    }, true);

    // ACEITA DROP NO CARD INTEIRO DA META
    metaCardsContainer.addEventListener('dragover', (e) => {
      const card = getMetaCard(e.target);
      if (!card) return;
      e.preventDefault(); // essencial para permitir o drop
      if (e.dataTransfer) e.dataTransfer.dropEffect = 'copy';
      card.classList.add('dz-hover');
    }, true);

    metaCardsContainer.addEventListener('dragleave', (e) => {
      const card = getMetaCard(e.target);
      if (!card) return;
      card.classList.remove('dz-hover');
    }, true);

    metaCardsContainer.addEventListener('drop', (e) => {
      const card = getMetaCard(e.target);
      if (!card) return;
      e.preventDefault();
      card.classList.remove('dz-hover');

      // lê SID do dataTransfer
      let sid = e.dataTransfer?.getData('application/x-sid');
      if (!sid) {
        const txt = e.dataTransfer?.getData('text/plain') || '';
        if (txt.startsWith('sid:')) sid = txt.slice(4);
      }
      if (!sid) sid = DRAG.id;

      if (!sid) return;
      addToMeta(sid, card.dataset.metaId);
    }, true);

    /* ---------- Metas ---------- */
    function renderMetas(metas) {
      if (!metas || metas.length === 0) {
        metasGrid.innerHTML = `<div class="alert alert-light border">Nenhuma meta disponível.</div>`;
        setSalvarEnabled(false); hiddenMetaId.value = ""; return;
      }
      metasGrid.innerHTML = metas.map(m => {
        const exec = Number(m.executado_unidade ?? 0);
        const aloc = Number(m.alocado_unidade ?? 0);
        const perc = aloc > 0 ? Math.min(100, Math.round((exec / aloc) * 100)) : 0;
        return `
          <button type="button" class="meta-card" data-id="${m.id}">
            <div class="meta-head">
              <span class="icon"><i class="bi bi-flag"></i></span>
              <h6 class="meta-title">${m.nome}</h6>
            </div>
            <div class="meta-sep"></div>
            <div class="meta-small">Alocado nesta unidade: <b>${aloc}</b></div>
            <div class="meta-progress mt-1">
              <div class="d-flex justify-content-between summary mb-1">
                <span>Executado (unidade)</span><span><b>${exec}</b> / ${aloc}</span>
              </div>
              <div class="progress"><div class="progress-bar bg-primary" style="width:${perc}%"></div></div>
            </div>
          </button>`;
      }).join('');

      metasGrid.querySelectorAll('.meta-card').forEach(card => {
        card.addEventListener('click', () => {
          metasGrid.querySelectorAll('.meta-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          hiddenMetaId.value = card.dataset.id;
          setSalvarEnabled(true);
          ensureMetaCard(card.dataset.id, card.querySelector('.meta-title').textContent.trim());
        });
      });

      hiddenMetaId.value = ""; setSalvarEnabled(false);
    }

    function loadMetas() {
      metasGrid.innerHTML = `<div class="placeholder-glow"><span class="placeholder col-12 mb-2"></span></div>`;
      fetch(window.metasURL, { headers:{'X-Requested-With':'XMLHttpRequest'} })
        .then(r=>r.json()).then(({metas})=>renderMetas(metas))
        .catch(()=>{ metasGrid.innerHTML=`<div class="alert alert-danger">Erro ao carregar metas.</div>`; });
    }

    /* ---------- Servidores ---------- */
    function loadServidores(dateStr) {
      const expDiv     = document.getElementById('expedienteAdmin');
      const tbodyImp   = document.querySelector('#tabelaImpedidos tbody');
      const livresDiv  = document.getElementById('servidoresLivres');

      Object.keys(allocations).forEach(k => delete allocations[k]);
      servidoresData.length = 0;
      metaCardsContainer.innerHTML = '';
      livresDiv.innerHTML = '<span class="text-muted">Carregando...</span>';
      expDiv.innerHTML = ''; tbodyImp.innerHTML = '';

      fetch(`${window.servidoresURL}?data=${dateStr}`, { headers:{'X-Requested-With':'XMLHttpRequest'} })
        .then(r=>r.json())
        .then(({livres, impedidos})=>{
          livresDiv.innerHTML = '';
          (livres||[]).forEach(s=>{ servidoresData.push(s); allocations[String(s.id)]=0; });

          if (!livres || livres.length===0) {
            livresDiv.innerHTML = '<div class="alert alert-light border mb-0">Nenhum servidor livre.</div>';
            expDiv.innerHTML    = '<div class="alert alert-light border mb-0">Sem servidores.</div>';
          } else {
            livres.forEach(s => livresDiv.appendChild(makeDisponivelCard(s)));
            // opcional: listar "espelho" no expediente
            livres.forEach(s => {
              const el = document.createElement('div');
              el.className='servidor-card'; el.dataset.id=s.id; el.textContent=s.nome;
              expDiv.appendChild(el);
            });
          }

          if (!impedidos || impedidos.length===0) {
            tbodyImp.innerHTML = '<tr><td colspan="2" class="text-muted">Nenhum impedido.</td></tr>';
          } else {
            tbodyImp.innerHTML = impedidos.map(s=>`<tr><td>${s.nome}</td><td>${s.motivo||'Descanso'}</td></tr>`).join('');
          }

          updateCounts();
        })
        .catch(()=>{
          livresDiv.innerHTML = '<span class="text-danger">Erro ao carregar.</span>';
          updateCounts();
        });
    }

    /* ---------- Calendar ---------- */
    const calendar = new FullCalendar.Calendar(calendarEl, {
      locale:'pt-br', timeZone:'local', firstDay:1, initialView:'dayGridMonth',
      headerToolbar:{ left:'prev,next today', center:'title', right:'' },
      buttonText:{ today:'Hoje', month:'Mês', week:'Semana', day:'Dia' },
      height:'auto',
      events: window.calendarFeedURL,
      dateClick(info){
        inputData.value = info.dateStr;
        const dataBR = info.date.toLocaleDateString('pt-BR',{timeZone:'UTC'});
        tituloModal.textContent = `Programar atividades para o dia ${dataBR}`;
        loadMetas();
        loadServidores(info.dateStr);
        bootstrap.Modal.getOrCreateInstance(modalEl).show();
      }
    });
    calendar.render();

    /* ---------- Submit placeholder ---------- */
    document.getElementById('formAtividade').addEventListener('submit', (e) => {
      e.preventDefault();
      const metasPayload = {};
      metaCardsContainer.querySelectorAll('[data-meta-id]').forEach(card=>{
        metasPayload[card.dataset.metaId] =
          Array.from(card.querySelectorAll('.servidor-chip')).map(ch=>ch.dataset.id);
      });
      const payload = { data: inputData.value, metas: metasPayload };
      console.log('➡️ Enviar para backend:', payload);
      bootstrap.Modal.getInstance(modalEl).hide();
    });
  });
  </script>
{% endblock %}
