{% extends "core/base.html" %}
{% load static %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  #calendar{max-width:1100px;margin:24px auto;min-height:520px;background:#fff;padding:8px}

  /* ---- metas (topo) ---- */
  .metas-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
  .meta-card{border:1px solid #e3e6ef;border-radius:.6rem;padding:14px;background:#fff;display:flex;flex-direction:column;gap:8px;transition:.15s ease;cursor:pointer}
  .meta-card:hover{box-shadow:0 4px 18px rgba(2,6,23,.08);border-color:#cfd6e4;background:#fbfdff}
  .meta-card.selected{border-color:#0d6efd;box-shadow:0 0 0 3px rgba(13,110,253,.15)}
  .meta-head{display:flex;align-items:center;gap:.5rem}
  .meta-head .icon{width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;border-radius:.5rem;background:#eef5ff;color:#0d6efd}
  .meta-title{font-weight:700;margin:0}
  .meta-sep{height:1px;background:#eef1f5}
  .meta-small{font-size:.875rem;color:#6c757d}
  .meta-progress .progress{height:6px}
  .meta-progress .summary{font-size:.8rem;color:#6c757d}

  /* ---- linha principal ---- */
  .cards-row{display:grid;grid-template-columns:340px 340px 1fr;gap:16px;overflow-x:auto;padding-bottom:4px}
  @media (max-width:991.98px){.cards-row{grid-template-columns:1fr}}
  .servidor-cardbox{min-width:340px;max-width:340px}
  #metaCardsContainer{display:flex;gap:16px;min-width:340px}
  #metaCardsContainer .servidor-cardbox{min-width:340px;max-width:340px}
  .servidor-cardbox .card-header{background:#f8fafc;border-bottom-color:#e9edf3}
  .servidor-cardbox .card-body{padding:12px}
  .servidores-grid{display:grid;grid-template-columns:1fr;gap:10px}

  /* ---- servidores arrastáveis ---- */
  .servidor-card{display:flex;align-items:center;gap:.625rem;padding:12px 16px;border:1px solid #dee2e6;background:linear-gradient(145deg,#f9f9f9,#fff);border-radius:.75rem;font-size:.875rem;color:#1f2937;font-weight:600;min-height:48px;cursor:grab;user-select:none;box-shadow:0 2px 6px rgba(0,0,0,.04);transition:box-shadow .2s,transform .1s,background-color .2s,border-color .2s}
  .servidor-card:hover{background-color:#eef5ff;border-color:#cbd6ee;box-shadow:0 3px 8px rgba(13,110,253,.10)}
  .servidor-card:active{transform:scale(.98)}
  .servidor-card.dragging{opacity:.9;box-shadow:0 6px 20px rgba(0,0,0,.15)}
  .servidor-card .srv-icon{width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#e8f1ff;color:#0d6efd;font-size:14px;flex-shrink:0;box-shadow:inset 0 0 0 2px #cfe2ff}
  .servidor-card .srv-name{flex:1;text-align:center;letter-spacing:.3px;text-transform:uppercase}
  .srv-count-badge{margin-left:auto;background:#0d6efd;color:#fff;border-radius:999px;font-size:.7rem;padding:3px 7px;line-height:1;display:none;box-shadow:0 0 0 2px #fff}
  .servidor-card.has-count .srv-count-badge{display:inline-block}

  /* ---- chips nas metas ---- */
  .servidor-chip{display:flex;align-items:center;gap:.625rem;padding:10px 14px;background:#eef2f9;border:1px solid #cfd7e6;border-radius:.75rem;font-size:.85rem;color:#1f2937;font-weight:600;min-height:44px;box-shadow:0 2px 4px rgba(13,110,253,.05)}
  .servidor-chip .chip-icon{width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#e8f1ff;color:#0d6efd;font-size:13px;flex-shrink:0;box-shadow:inset 0 0 0 2px #cfe2ff}
  .servidor-chip .chip-name{flex:1;text-align:center;letter-spacing:.3px;text-transform:uppercase}
  .servidor-chip .chip-remove{border:0;background:#dee6f5;color:#374151;border-radius:.5rem;padding:3px 10px;font-weight:700;font-size:.8rem;cursor:pointer}

  /* ---- select do veículo ---- */
  select.veiculo-select{font-size:.9rem;border-radius:.5rem;padding:.5rem .75rem;border:1px solid #ccd6e0;background:#f8f9fa;box-shadow:inset 0 1px 2px rgba(0,0,0,.05);transition:border-color .2s,box-shadow .2s,background-color .2s}
  select.veiculo-select:focus{border-color:#0d6efd;outline:none;box-shadow:0 0 0 2px rgba(13,110,253,.25);background:#fff}

  /* ---- dropzones ---- */
  .dropzone{min-height:42px;border:2px dashed transparent;border-radius:.5rem;transition:border-color .15s,background-color .15s}
  .servidor-cardbox[data-meta-id].dz-hover{outline:2px dashed #0d6efd;outline-offset:-4px;background:#eef5ff}
  .meta-header-title{display:flex;align-items:center;gap:.5rem}
  .meta-header-sep{height:1px;background:#e9edf3;margin-top:6px}
  .meta-date{display:flex;align-items:center;gap:.5rem;font-size:.9rem;color:#495057;margin-top:.35rem}
  .meta-date i{color:#0d6efd}
  .meta-date strong{color:#111827}

  /* ---- modo compacto ---- */
  :root{--col-w:300px;--gap:12px}
  .cards-row{grid-template-columns:var(--col-w) var(--col-w) 1fr;gap:var(--gap);padding-bottom:2px}
  .servidor-cardbox{min-width:var(--col-w);max-width:var(--col-w)}
  .servidor-cardbox .card-header{padding:.35rem .6rem}
  .servidor-cardbox .card-body{padding:8px}
  .meta-card{padding:10px}
  .meta-head .icon{width:22px;height:22px;border-radius:.4rem;font-size:12px}
  .meta-small,.meta-date{font-size:.8rem}
  .meta-progress .progress{height:4px}
  .meta-header-sep{margin-top:4px}
  .servidores-grid{gap:6px}
  .servidor-card{padding:8px 10px;min-height:36px;font-size:.82rem;border-radius:.55rem;box-shadow:0 1px 4px rgba(0,0,0,.03)}
  .servidor-card .srv-icon{width:20px;height:20px;font-size:11px;box-shadow:inset 0 0 0 1px #cfe2ff}
  .srv-count-badge{font-size:.65rem;padding:2px 6px;line-height:1}
  .meta-dropzone{gap:6px}
  .servidor-chip{min-height:34px;padding:6px 10px;border-radius:.55rem;font-size:.82rem;background:#eef2f9;border:1px solid #cfd7e6;box-shadow:0 1px 3px rgba(13,110,253,.05)}
  .servidor-chip .chip-icon{width:18px;height:18px;font-size:10px;box-shadow:inset 0 0 0 1px #cfe2ff}
  .servidor-chip .chip-remove{padding:2px 8px;font-size:.72rem}
  .veiculo-select{font-size:.82rem;padding:.25rem .5rem;height:calc(1.5em + .5rem + 2px);border-radius:.45rem;background:#f8fafc}
  .table-sm>tbody>tr>td,.table-sm>thead>tr>th{padding:.3rem .5rem}

  /* corpo do card de meta com rolagem + select fixo embaixo */
  .meta-body{display:flex;flex-direction:column;max-height:420px;overflow-y:auto;padding:8px}
  .meta-body .meta-dropzone{flex:1 1 auto;min-height:32px;gap:6px}
  .meta-body .veiculo-select{position:sticky;bottom:0;background:#fff;margin-top:8px;border-radius:.45rem;font-size:.82rem;padding:.25rem .5rem;height:calc(1.5em + .5rem + 2px)}

  @keyframes pulseRed{0%{box-shadow:0 0 0 0 rgba(220,53,69,0)}50%{box-shadow:0 0 0 4px rgba(220,53,69,.35)}100%{box-shadow:0 0 0 0 rgba(220,53,69,0)}}
  .servidor-chip.dup-anim{animation:pulseRed .45s ease}

  /* body do card do Expediente como zona de drop grande */
  .drop-target{min-height:320px}
  .drop-target.dz-hover{outline:2px dashed #0d6efd;outline-offset:-4px;background:#eef5ff}

  /* Tarja (evento) centralizada e fininha */
  .fc-daygrid-event .fc-event-main{display:flex;justify-content:center;align-items:center}
  .fc-daygrid-day-frame{display:flex;flex-direction:column}
  .fc-daygrid-day-events{flex:1;display:flex;align-items:center;justify-content:center}
  .fc-daygrid-event{min-height:14px;font-size:.75rem;padding:1px 4px;border-radius:4px;line-height:1.2}
  .fc-daygrid-event-harness,.fc-daygrid-event{width:100%!important;display:block}

  /* separador da semana/plantão */
  .plantao-week-sep { display:flex; align-items:center; gap:0.5rem; }
  .plantao-week-sep .plantao-week-line { height:1px; background:#e9ecef; min-width:40px; }
  .plantao-week-sep .plantao-week-text { white-space:nowrap; color: #495057; }

</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h1>Programar Atividades</h1>
  <div id="calendar" class="mt-4"></div>
  <div id="relatoriosContainer" class="container mt-3"></div>
</div>

<div class="modal fade" id="modalAtividade" tabindex="-1" aria-labelledby="modalAtividadeLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-center w-100" id="modalAtividadeLabel">Programar atividades</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <form id="formAtividade">
          <input type="hidden" id="dataAtividade" name="data">
          <input type="hidden" id="metaId" name="meta_id">

          <div class="mb-2">
            <label class="form-label">Escolha a meta</label>
            <div id="metasGrid" class="metas-grid"></div>
          </div>

          <hr class="my-4">

          <div class="cards-row mb-3">
            <!-- Expediente administrativo -->
            <div class="card shadow-sm servidor-cardbox">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-semibold">Expediente administrativo</span>
                <span class="badge bg-secondary" id="countExpedienteAdmin">0</span>
              </div>
              <div id="expedienteBody" class="card-body drop-target">
                <div id="expedienteAdmin" class="servidores-grid"></div>
              </div>
            </div>

            <!-- Servidores disponíveis -->
            <div class="card shadow-sm servidor-cardbox">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-semibold">Servidores disponíveis</span>
                <span class="badge bg-secondary" id="countServidoresLivres">0</span>
              </div>
              <div class="card-body">
                <div id="servidoresLivres" class="servidores-grid"></div>
              </div>
            </div>

            <!-- Metas selecionadas -->
            <div id="metaCardsContainer"></div>
          </div>

          <!-- Impedidos -->
          <div class="mt-3">
            <div class="card shadow-sm" style="max-width:100%;min-width:unset;">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-semibold">Servidores impedidos</span>
                <span class="badge bg-secondary" id="countServidoresImpedidos">0</span>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm table-striped align-middle mb-0" id="tabelaImpedidos">
                    <thead class="table-light"><tr><th>Nome</th><th>Motivo</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </form>
      </div>

      <!-- ÚNICO footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-danger me-auto" id="btnExcluir" disabled>
          Excluir programação
        </button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" form="formAtividade" id="btnSalvar" class="btn btn-primary" disabled>Salvar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>

<script>
  window.calendarFeedURL = "{% url 'programar_atividades:events_feed' %}";
  window.metasURL        = "{% url 'programar_atividades:metas_disponiveis' %}";
  window.servidoresURL   = "{% url 'programar_atividades:servidores_para_data' %}";
  window.salvarURL       = "{% url 'programar_atividades:salvar_programacao' %}";
  window.programacaoURL  = "{% url 'programar_atividades:programacao_do_dia' %}";
  window.excluirURL      = "{% url 'programar_atividades:excluir_programacao' %}";
  window.plantaoSemanaURL = "{% url 'plantao:servidores_por_intervalo' %}";
  window.printProgramacaoURL = "{% url 'programar_atividades:print_relatorio_semana' %}";
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const calendarEl   = document.getElementById('calendar');
  const modalEl      = document.getElementById('modalAtividade');
  const tituloModal  = document.getElementById('modalAtividadeLabel');
  const inputData    = document.getElementById('dataAtividade');
  const metasGrid    = document.getElementById('metasGrid');
  const hiddenMetaId = document.getElementById('metaId');
  const btnSalvar    = document.getElementById('btnSalvar');
  const btnExcluir   = document.getElementById('btnExcluir');
  const metaCardsContainer = document.getElementById('metaCardsContainer');

  // Expediente: body = dropzone, list = onde renderiza
  const expBody = document.getElementById('expedienteBody');
  const expList = document.getElementById('expedienteAdmin');

  const setSalvarEnabled = (on) => { btnSalvar.disabled = !on; };

  const allocations = {};          // sid -> total alocado em metas
  const servidoresData = [];       // cache
  const findSrv = sid => servidoresData.find(s => String(s.id) === String(sid));
  const DRAG = { id:null };

  const getMetaCard = (el) => el.closest('[data-meta-id]');

  function setDeleteEnabled(on){ if(btnExcluir) btnExcluir.disabled = !on; }
  let currentProgId = null; // id da programação carregada

  /* ---------- helpers ---------- */
  function updateCounts() {
    const countLivres = document.getElementById('countServidoresLivres');
    const countExp    = document.getElementById('countExpedienteAdmin');
    const countImp    = document.getElementById('countServidoresImpedidos');

    if (countLivres) countLivres.textContent = String(document.querySelectorAll('#servidoresLivres .servidor-card').length);
    if (countExp)    countExp.textContent    = String(document.querySelectorAll('#expedienteAdmin .servidor-card').length);

    if (countImp) {
      const rows = Array.from(document.querySelectorAll('#tabelaImpedidos tbody tr'));
      const none = rows.length === 1 && rows[0].querySelector('td[colspan]');
      countImp.textContent = String(none ? 0 : rows.length);
    }

    document.querySelectorAll('#servidoresLivres .servidor-card[data-id]').forEach(el => {
      const sid = el.dataset.id;
      const n = allocations[sid] || 0;
      const b = el.querySelector('.srv-count-badge');
      if (!b) return;
      if (n > 0) { el.classList.add('has-count'); b.textContent = n; }
      else       { el.classList.remove('has-count'); b.textContent = ''; }
    });

    if (metaCardsContainer) {
      metaCardsContainer.querySelectorAll('[data-meta-id]').forEach(card => {
        const n = card.querySelectorAll('.servidor-chip').length;
        const badge = card.querySelector('.count-meta');
        if (badge) badge.textContent = String(n);
      });
    }

    // habilita Salvar se houver ao menos um card aberto
    setSalvarEnabled(metaCardsContainer.querySelectorAll('[data-meta-id]').length > 0);
  }

  function makeDisponivelCard(s) {
    const el = document.createElement('div');
    el.className = 'servidor-card';
    el.id = `srv-${s.id}`;
    el.dataset.id = s.id;
    el.setAttribute('draggable','true');
    el.innerHTML = `
      <span class="srv-icon"><i class="bi bi-person-fill"></i></span>
      <span class="srv-name">${s.nome}</span>
      <span class="srv-count-badge"></span>`;
    return el;
  }

  function makeMetaChip(srv) {
    const chip = document.createElement('div');
    chip.className = 'servidor-chip';
    chip.dataset.id = srv.id;
    chip.innerHTML = `
      <span class="chip-icon"><i class="bi bi-person-fill"></i></span>
      <span class="chip-name">${srv.nome}</span>
      <button type="button" class="chip-remove" title="Remover">&times;</button>`;
    chip.querySelector('.chip-remove').addEventListener('click', () => {
      chip.remove();
      const sid = String(srv.id);
      allocations[sid] = Math.max(0, (allocations[sid] || 0) - 1);
      if ((allocations[sid] || 0) === 0) appendToExpediente(srv);
      updateCounts();
    });
    return chip;
  }

  function appendToExpediente(srv) {
    if (!expList.querySelector(`.servidor-card[data-id="${srv.id}"]`)) {
      const el = document.createElement('div');
      el.className = 'servidor-card';
      el.dataset.id = srv.id;
      el.innerHTML = `
        <span class="srv-icon"><i class="bi bi-person-fill"></i></span>
        <span class="srv-name">${srv.nome}</span>`;
      expList.appendChild(el);
    }
  }
  function removeOneFromExpediente(sid) {
    const el = expList.querySelector(`.servidor-card[data-id="${sid}"]`);
    if (el) el.remove();
  }

  // numeração dos cards (#1, #2, ...)
  function updateCopyIndexes(metaId){
    if (!metaCardsContainer) return;
    const cards = Array.from(
      metaCardsContainer.querySelectorAll(`.servidor-cardbox[data-meta-id="${metaId}"]`)
    );
    cards.forEach((c, i) => {
      const b = c.querySelector('.index-badge');
      if (b) b.textContent = String(i + 1);
    });
  }

  /* --------- cards de meta --------- */
  function ensureMetaCard(metaId, metaTitle, options = {}) {
    const { forceNew = false } = options;

    if (!forceNew) {
      let card = metaCardsContainer.querySelector(`[data-meta-id="${metaId}"]`);
      if (card) {
        card.querySelector('.meta-title-text').textContent = metaTitle;
        return card;
      }
    }

    const wrapper = document.createElement('div');
    wrapper.className = 'card shadow-sm servidor-cardbox';
    wrapper.dataset.metaId = metaId;

    wrapper.innerHTML = `
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div class="meta-header-title">
            <span class="icon"><i class="bi bi-clipboard2-check"></i></span>
            <span class="fw-semibold meta-title-text">${metaTitle}</span>
            <span class="badge text-bg-light index-badge ms-2">1</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-primary count-meta">0</span>
            <button type="button" class="btn btn-sm btn-outline-secondary meta-close" title="Fechar">&times;</button>
          </div>
        </div>
        <div class="meta-header-sep"></div>
      </div>
      <div class="card-body meta-body">
        <div class="servidores-grid meta-dropzone dropzone mb-3"></div>
        <div class="mt-2">
          <label class="form-label mb-1">Veículo da unidade</label>
          <select class="form-select form-select-sm veiculo-select" name="veiculo_id" data-meta-id="${metaId}">
            <option value="" selected disabled>Escolha um veículo</option>
            {% for v in veiculos_ativos %}
              <option value="{{ v.id }}">{{ v.nome }} - {{ v.placa }}</option>
            {% endfor %}
          </select>
        </div>
      </div>`;

    // fechar card: devolver alocações se necessário
    wrapper.querySelector('.meta-close').addEventListener('click', () => {
      const removedCounts = {};
      wrapper.querySelectorAll('.servidor-chip').forEach(ch => {
        const sid = String(ch.dataset.id);
        removedCounts[sid] = (removedCounts[sid] || 0) + 1;
        ch.remove();
      });
      Object.entries(removedCounts).forEach(([sid, qty]) => {
        allocations[sid] = Math.max(0, (allocations[sid] || 0) - qty);
        if ((allocations[sid] || 0) === 0) {
          const srv = findSrv(sid);
          if (srv) appendToExpediente(srv);
        }
      });
      wrapper.remove();
      updateCopyIndexes(metaId);
      updateCounts();
    });

    metaCardsContainer.prepend(wrapper);
    updateCopyIndexes(metaId);
    updateCounts();
    return wrapper;
  }

  const cardTitle = (metaId) =>
    metasGrid.querySelector(`.meta-card[data-id="${metaId}"] .meta-title`)?.textContent?.trim() || 'Atividade';

  function addToMeta(serverId, metaId) {
    const sid = String(serverId);
    const srv = findSrv(sid);
    if (!srv) return;

    const card = ensureMetaCard(metaId, cardTitle(metaId));
    const dropzone = card.querySelector('.meta-dropzone');

    // evita duplicar no MESMO card
    const already = dropzone.querySelector(`.servidor-chip[data-id="${sid}"]`);
    if (already) {
      already.classList.add('dup-anim');
      setTimeout(() => already.classList.remove('dup-anim'), 500);
      return;
    }

    dropzone.appendChild(makeMetaChip(srv));

    // contabiliza e retira do expediente na 1ª alocação
    const prev = allocations[sid] || 0;
    allocations[sid] = prev + 1;
    if (prev === 0) removeOneFromExpediente(sid);

    updateCounts();
  }

  /* ====== Drag & Drop ====== */
  window.addEventListener('dragover', e => e.preventDefault());
  window.addEventListener('drop',     e => e.preventDefault());

  document.addEventListener('dragstart', (e) => {
    const card = e.target.closest('#servidoresLivres .servidor-card');
    if (!card) return;
    const sid = card.dataset.id;
    DRAG.id = sid;
    if (e.dataTransfer) {
      e.dataTransfer.setData('application/x-sid', sid);
      e.dataTransfer.setData('text/plain', `sid:${sid}`);
      e.dataTransfer.effectAllowed = 'copy';
    }
    card.classList.add('dragging');
  }, true);

  document.addEventListener('dragend', (e) => {
    const card = e.target.closest('#servidoresLivres .servidor-card');
    if (card) card.classList.remove('dragging');
    DRAG.id = null;
  }, true);

  // Drop no card de meta (qualquer área do card)
  metaCardsContainer.addEventListener('dragover', (e) => {
    const card = getMetaCard(e.target);
    if (!card) return;
    e.preventDefault();
    if (e.dataTransfer) e.dataTransfer.dropEffect = 'copy';
    card.classList.add('dz-hover');
  }, true);

  metaCardsContainer.addEventListener('dragleave', (e) => {
    const card = getMetaCard(e.target);
    if (!card) return;
    card.classList.remove('dz-hover');
  }, true);

  metaCardsContainer.addEventListener('drop', (e) => {
    const card = getMetaCard(e.target);
    if (!card) return;
    e.preventDefault();
    card.classList.remove('dz-hover');

    let sid = e.dataTransfer?.getData('application/x-sid');
    if (!sid) {
      const txt = e.dataTransfer?.getData('text/plain') || '';
      if (txt.startsWith('sid:')) sid = txt.slice(4);
    }
    if (!sid) sid = DRAG.id;
    if (!sid) return;

    addToMeta(sid, card.dataset.metaId);
  }, true);

  // Drop no Expediente (card inteiro)
  expBody.addEventListener('dragover', (e) => {
    e.preventDefault();
    if (e.dataTransfer) e.dataTransfer.dropEffect = 'copy';
    expBody.classList.add('dz-hover');
  });
  expBody.addEventListener('dragleave', () => expBody.classList.remove('dz-hover'));
  expBody.addEventListener('drop', (e) => {
    e.preventDefault();
    expBody.classList.remove('dz-hover');

    let sid = e.dataTransfer?.getData('application/x-sid');
    if (!sid) {
      const txt = e.dataTransfer?.getData('text/plain') || '';
      if (txt.startsWith('sid:')) sid = txt.slice(4);
    }
    if (!sid) sid = DRAG.id;
    if (!sid) return;

    const srv = findSrv(sid);
    if (!srv) return;

    appendToExpediente(srv);
    updateCounts();
  });

  /* ---------- Metas ---------- */
  function renderMetas(metas) {
    if (!metas || metas.length === 0) {
      metasGrid.innerHTML = `<div class="alert alert-light border">Nenhuma meta disponível.</div>`;
      setSalvarEnabled(false); hiddenMetaId.value = ""; return;
    }

    const formatDateBR = (ds) => {
      try{
        const d = (ds instanceof Date) ? ds : new Date(ds);
        if (isNaN(d.getTime())) return '';
        return d.toLocaleDateString('pt-BR',{timeZone:'UTC'});
      } catch { return ''; }
    };

    metasGrid.innerHTML = metas.map(m => {
      const exec = Number(m.executado_unidade ?? 0);
      const aloc = Number(m.alocado_unidade ?? 0);
      const perc = aloc > 0 ? Math.min(100, Math.round((exec / aloc) * 100)) : 0;

      const deadlineISO = m.data_limite || m.deadline || m.dataLimite || m.data_limite_iso || null;
      const deadlineHtml = deadlineISO ? `
        <div class="meta-date">
          <i class="bi bi-calendar-event" aria-hidden="true"></i>
          <span>Data limite:</span>
          <strong>${formatDateBR(deadlineISO)}</strong>
        </div>` : '';

      return `
        <button type="button" class="meta-card" data-id="${m.id}">
          <div class="meta-head">
            <span class="icon"><i class="bi bi-flag"></i></span>
            <h6 class="meta-title">${m.nome}</h6>
          </div>
          <div class="meta-sep"></div>
          ${deadlineHtml}
          <div class="meta-small mt-2">Alocado nesta unidade: <b>${aloc}</b></div>
          <div class="meta-progress mt-1">
            <div class="d-flex justify-content-between summary mb-1">
              <span>Executado (unidade)</span><span><b>${exec}</b> / ${aloc}</span>
            </div>
            <div class="progress"><div class="progress-bar bg-primary" style="width:${perc}%"></div></div>
          </div>
        </button>`;
    }).join('');

    metasGrid.querySelectorAll('.meta-card').forEach(card => {
      card.addEventListener('click', () => {
        metasGrid.querySelectorAll('.meta-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');

        const mid   = card.dataset.id;
        const title = card.querySelector('.meta-title').textContent.trim();

        hiddenMetaId.value = mid;
        setSalvarEnabled(true);

        const existing = metaCardsContainer.querySelectorAll(`[data-meta-id="${mid}"]`);
        let targetCard;

        if (existing.length >= 1) {
          const displayCount = existing.length;
          const ok = window.confirm(
            displayCount === 1
              ? 'Já existe uma atividade nessa programação.\nDeseja abrir mais um card para esta atividade?'
              : `Já existem ${displayCount} atividades nessa programação.\nDeseja abrir mais um card para esta atividade?`
          );
          targetCard = ok
            ? ensureMetaCard(mid, title, { forceNew: true })
            : existing[0];
        } else {
          targetCard = ensureMetaCard(mid, title);
        }

        targetCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
      });
    });

    hiddenMetaId.value = ""; setSalvarEnabled(false);
  }

  function loadMetas() {
    metasGrid.innerHTML = `<div class="placeholder-glow"><span class="placeholder col-12 mb-2"></span></div>`;
    return fetch(window.metasURL, { headers:{'X-Requested-With':'XMLHttpRequest'} })
      .then(r=>r.json())
      .then(({metas})=>renderMetas(metas))
      .catch(()=>{ metasGrid.innerHTML=`<div class="alert alert-danger">Erro ao carregar metas.</div>`; });
  }

  /* ---------- Servidores ---------- */
  function loadServidores(dateStr) {
    const tbodyImp   = document.querySelector('#tabelaImpedidos tbody');
    const livresDiv  = document.getElementById('servidoresLivres');

    Object.keys(allocations).forEach(k => delete allocations[k]);
    servidoresData.length = 0;
    metaCardsContainer.innerHTML = '';
    livresDiv.innerHTML = '<span class="text-muted">Carregando...</span>';
    expList.innerHTML = ''; tbodyImp.innerHTML = '';

    return fetch(`${window.servidoresURL}?data=${dateStr}`, { headers:{'X-Requested-With':'XMLHttpRequest'} })
      .then(r=>r.json())
      .then(({livres, impedidos})=>{
        livresDiv.innerHTML = '';
        (livres||[]).forEach(s=>{ servidoresData.push(s); allocations[String(s.id)]=0; });

        if (!livres || livres.length===0) {
          livresDiv.innerHTML = '<div class="alert alert-light border mb-0">Nenhum servidor livre.</div>';
          expList.innerHTML   = '<div class="alert alert-light border mb-0">Sem servidores.</div>';
        } else {
          livres.forEach(s => livresDiv.appendChild(makeDisponivelCard(s)));
          livres.forEach(s => appendToExpediente(s));
        }

        if (!impedidos || impedidos.length===0) {
          tbodyImp.innerHTML = '<tr><td colspan="2" class="text-muted">Nenhum impedido.</td></tr>';
        } else {
          tbodyImp.innerHTML = impedidos.map(s=>`<tr><td>${s.nome}</td><td>${s.motivo||'Descanso'}</td></tr>`).join('');
        }

        updateCounts();
      })
      .catch(()=>{
        livresDiv.innerHTML = '<span class="text-danger">Erro ao carregar.</span>';
        updateCounts();
      });
  }

  /* ---------- Aplicar programação existente ---------- */
  function applyProgramacao(prog) {
    if (!prog || !prog.itens || prog.itens.length === 0) return;

    const titleForMeta = (mid, fallback) =>
      metasGrid.querySelector(`.meta-card[data-id="${mid}"] .meta-title`)?.textContent?.trim()
      || fallback || 'Atividade';

    for (const it of prog.itens) {
      const metaId    = String(it.meta_id);
      const metaTitle = titleForMeta(metaId, it.meta_nome);

      // cria 1 card por item
      const card     = ensureMetaCard(metaId, metaTitle, { forceNew: true });
      const dropzone = card.querySelector('.meta-dropzone');

      // chips de servidores
      for (const s of (it.servidores || [])) {
        const srv = findSrv(String(s.id));
        if (!srv) continue; // impedidos ficam na tabela
        if (!dropzone.querySelector(`.servidor-chip[data-id="${srv.id}"]`)) {
          dropzone.appendChild(makeMetaChip(srv));
          const prev = allocations[String(srv.id)] || 0;
          allocations[String(srv.id)] = prev + 1;
          if (prev === 0) removeOneFromExpediente(String(srv.id));
        }
      }

      // veículo (seleciona — criando option caso não exista)
      const sel = card.querySelector('.veiculo-select');
      if (sel) {
        const vid = (it.veiculo_id != null && it.veiculo_id !== '') ? String(it.veiculo_id) : '';

        if (vid) {
          let opt = Array.from(sel.options).find(o => String(o.value) === vid);
          if (!opt) { // veículo inativo/desconhecido
            const label = it.veiculo_label || `Veículo #${vid} (indisponível)`;
            opt = new Option(label, vid, true, true);
            sel.add(opt);
          } else {
            opt.selected = true;
          }
          sel.value = vid;
        } else {
          const placeholder = sel.querySelector('option[disabled]') || sel.options[0];
          if (placeholder) {
            Array.from(sel.options).forEach(o => { o.selected = false; });
            placeholder.selected = true;
          }
          sel.value = '';
        }
        sel.dispatchEvent(new Event('change', { bubbles: true }));
      }
    }

    updateCounts();
  }



    /* ---------- loadRelatoriosForRange (UNICA VERSÃO, global) ---------- */
    window.relatoriosURL = "{% url 'programar_atividades:relatorios_parcial' %}";

    // SUBSTITUI sua loadRelatoriosForRange por esta, se preferir:
    async function loadRelatoriosForRange(startISO, endISO) {
      const container = document.getElementById('relatoriosContainer');
      if (!container) return;

      container.innerHTML = `
        <div class="text-center my-4">
          <div class="spinner-border" role="status"></div>
          <div class="small text-muted mt-2">Carregando relatório…</div>
        </div>`;

      const resp = await fetch(`${window.relatoriosURL}?start=${encodeURIComponent(startISO)}&end=${encodeURIComponent(endISO)}`, {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      });

      const ct = (resp.headers.get('content-type') || '').toLowerCase();
      if (ct.includes('application/json')) {
        const data = await resp.json();
        if (!data.ok) {
          container.innerHTML = `<div class="alert alert-danger">${data.error || 'Erro ao carregar relatórios.'}</div>`;
          return;
        }
        container.innerHTML = data.html || '';
      } else {
        // fallback caso o servidor responda HTML (login/debug)
        container.innerHTML = await resp.text();
      }
    }

  /* ---------- Calendar ---------- */
  const calendar = new FullCalendar.Calendar(calendarEl, {
    locale:'pt-br', timeZone:'local', firstDay:1, initialView:'dayGridMonth',
    headerToolbar:{ left:'prev,next today', center:'title', right:'' },
    buttonText:{ today:'Hoje', month:'Mês', week:'Semana', day:'Dia' },
    height:'auto',
    events: window.calendarFeedURL,

    // 👇 carrega o relatório sempre que o range do calendário mudar
    datesSet(arg) {
      window._lastCalendarArg = arg;
      // arg.end é exclusivo: recua 1 dia
      const endAdj = new Date(arg.end.getTime() - 24*60*60*1000);
      const startISO = arg.start.toISOString().slice(0,10);
      const endISO   = endAdj.toISOString().slice(0,10);
      loadRelatoriosForRange(startISO, endISO);
      // chama populate que cuidará de criar/atualizar o select
      if (typeof populateWeeksSelect === 'function') populateWeeksSelect(arg);
    },

    async dateClick(info){
      inputData.value = info.dateStr;
      const dataBR = info.date.toLocaleDateString('pt-BR',{timeZone:'UTC'});
      tituloModal.innerHTML = `
        <i class="bi bi-calendar-event text-primary me-2"></i>
        Programar atividades para o dia ${dataBR}
      `;

      // 👇 MOSTRA O MODAL ANTES DE CARREGAR
      bootstrap.Modal.getOrCreateInstance(modalEl).show();

      try {
        await Promise.all([
          loadMetas(),
          loadServidores(info.dateStr)
        ]);

        const r = await fetch(`${window.programacaoURL}?data=${info.dateStr}`, {
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        });
        const data = await r.json();

        currentProgId = null;
        setDeleteEnabled(false);

        if (data && data.ok && data.programacao) {
          currentProgId = data.programacao.id || null;
          setDeleteEnabled(!!currentProgId);
          applyProgramacao(data.programacao);
        }

      } catch (err) {
        console.error('Erro ao carregar programação:', err);
      }
    }

  });
  calendar.render();
  /* Liga impressão em fragmento para botões injetados via AJAX */
  (function () {
    if (window.__fragmentPrintInstalled) return;
    window.__fragmentPrintInstalled = true;

    function doFragmentPrint(btn){
      const prevTitle = document.title;
      const s = btn?.dataset.start || '';
      const e = btn?.dataset.end   || '';
      if (s && e) document.title = `Relatório semanal ${s} a ${e}`;

      document.body.classList.add('fragment-print');

      // cleanup confiável (Chrome/Firefox/Safari)
      const mm = window.matchMedia('print');
      const cleanup = () => {
        document.body.classList.remove('fragment-print');
        document.title = prevTitle;
        window.onafterprint = null;
        mm.removeEventListener?.('change', onChange);
      };
      const onChange = (e) => { if (!e.matches) cleanup(); };

      window.onafterprint = cleanup;
      mm.addEventListener?.('change', onChange);

      window.print();
    }

    // Delegação em CAPTURA: funciona para conteúdo dinâmico
    document.addEventListener('click', function (ev) {
      const target = ev.target.closest('#btnImprimirProgramacao, #btnImprimirVista');
      if (!target) return;
      ev.preventDefault();
      ev.stopPropagation();
      ev.stopImmediatePropagation?.();
      if (target.tagName === 'BUTTON' && !target.hasAttribute('type')) {
        target.setAttribute('type','button'); // evita submit
      }
      doFragmentPrint(target);
    }, true);
  })();

  // ---------- helper para formatar data BR ----------
  function formatBRFromISO(iso){
    // iso esperado: 'YYYY-MM-DD'
    if (!iso) return '';
    const parts = iso.split('-');
    if (parts.length !== 3) return iso;
    return `${parts[2].padStart(2,'0')}/${parts[1].padStart(2,'0')}/${parts[0]}`;
  }

  // helper pra escrever/atualizar o cabeçalho "Semana ..." no DOM
  function writeSelectedWeekLabel(...args) {
    // aceita:
    // - writeSelectedWeekLabel("Texto já formatado")
    // - writeSelectedWeekLabel(startISO, endISO)
    // - writeSelectedWeekLabel(labelString, startISO, endISO) (compatível)
    if (!args || args.length === 0) return;

    // monta o texto do label
    let label = '';
    if (args.length === 1) {
      label = String(args[0] || '').trim();
    } else if (args.length >= 2) {
      const a = String(args[0] || '').trim();
      const b = String(args[1] || '').trim();
      // se o primeiro já contém uma seta, assume que é label pronto
      if (a.includes('→') || a.includes('->')) {
        label = a;
      } else {
        // formata ISO para BR
        const format = s => formatBRFromISO(s);
        label = `${format(a)} → ${format(b)}`;
      }
    }
    if (!label) return;

    // remove separador antigo (se houver) para evitar duplicatas
    const old = document.querySelector('.plantao-week-sep');
    if (old) old.remove();

    // elemento container onde vamos inserir (antes de #relatoriosContainer)
    const relCont = document.getElementById('relatoriosContainer');
    if (!relCont) return;

    // cria separador: linha + texto centralizado + linha
    const sep = document.createElement('div');
    sep.className = 'plantao-week-sep d-flex align-items-center my-3';
    sep.innerHTML = `
      <div class="plantao-week-line flex-grow-1" aria-hidden="true"></div>
      <div class="plantao-week-text mx-3 text-muted fw-semibold small">${label}</div>
      <div class="plantao-week-line flex-grow-1" aria-hidden="true"></div>
    `;

    // insere antes do container de relatórios
    if (relCont.parentNode) relCont.parentNode.insertBefore(sep, relCont);
    else document.body.insertBefore(sep, document.body.firstChild);
  }

  // ---------- popula select com semanas alinhadas ao view do calendário (Sáb->Sex) ----------
  (function(){
    // helpers de data (plantão Sáb->Sex)
    const isoDate = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const formatBR = iso => { if(!iso) return ''; const [y,m,d] = iso.split('-'); return `${d}/${m}/${y}`; };

    function prevOrSameSaturday(d){
      const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const shift = (dt.getDay() - 6 + 7) % 7; // 6 === Saturday
      dt.setDate(dt.getDate() - shift);
      return dt;
    }
    function nextOrSameMonday(d){
      const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const shift = (1 - dt.getDay() + 7) % 7; // 1 === Monday
      dt.setDate(dt.getDate() + shift);
      return dt;
    }

    // debounce util
    function debounce(fn, wait=120){
      let t;
      return function(...args){
        clearTimeout(t);
        t = setTimeout(()=>fn.apply(this, args), wait);
      };
    }

    // flag para evitar concorrência de fetchs ao selecionar semana
    window.__loadingWeek = false;

    // handler centralizado (debounced)
    async function onSelectSemanaChange(opt){
      if (!opt || !opt.dataset.inicio) return;
      const s = opt.dataset.inicio, e = opt.dataset.fim;
      const labelText = `${formatBRFromISO(s)} → ${formatBRFromISO(e)}`;
      writeSelectedWeekLabel(labelText);

      // evita concorrência
      if (window.__loadingWeek) {
        console.debug('[weeks] seleção ignorada: carregamento em andamento');
        return;
      }
      window.__loadingWeek = true;

      try {
        const tasks = [];
        if (typeof loadRelatoriosForRange === 'function') tasks.push(loadRelatoriosForRange(s, e));
        if (typeof fetchServidoresPlantao === 'function') tasks.push(fetchServidoresPlantao(s, e));
        await Promise.allSettled(tasks);
      } catch (err) {
        console.error('[weeks] erro ao carregar semana', err);
      } finally {
        window.__loadingWeek = false;
      }
    }
    const debouncedOnChange = debounce(opt => onSelectSemanaChange(opt), 100);

    // função principal que popula o select (exportada)
    window.populateWeeksSelect = function(arg) {
      const relCont = document.getElementById('relatoriosContainer');

      // Limpa apenas o <select> antigo dentro do wrapper, sem remover o container completo
      const wrapper = document.getElementById('select-semana-wrapper');
      if (wrapper) {
        const oldSelect = wrapper.querySelector('#select-semana');
        if (oldSelect) oldSelect.remove();
      }

      // Cria <select> novo
      const select = document.createElement('select');
      select.id = 'select-semana';
      select.className = 'form-select form-select-sm w-auto';
      select.innerHTML = `<option value="">Selecione a semana</option>`;

      // Se wrapper já existe, insere o select nele
      let wrapperFinal = wrapper;
      if (!wrapperFinal) {
        wrapperFinal = document.createElement('div');
        wrapperFinal.id = 'select-semana-wrapper';
        wrapperFinal.className = 'mt-3 d-flex align-items-center gap-2';

        const label = document.createElement('label');
        label.setAttribute('for', 'select-semana');
        label.className = 'mb-0 small text-muted';
        label.textContent = 'Semana:';

        wrapperFinal.appendChild(label);
      }
      wrapperFinal.appendChild(select);

      // Insere o wrapper após o título "Relatórios"
      const titulo = Array.from(document.querySelectorAll('h1,h2,h3,h4')).find(h => /relat[oó]rios/i.test(h.textContent));
      if (titulo && wrapperFinal && !wrapperFinal.parentNode) {
        if (titulo.nextSibling) titulo.parentNode.insertBefore(wrapperFinal, titulo.nextSibling);
        else titulo.parentNode.appendChild(wrapperFinal);
      } else if (relCont && !wrapperFinal.parentNode) {
        relCont.parentNode.insertBefore(wrapperFinal, relCont);
      } else if (!wrapperFinal.parentNode) {
        document.body.appendChild(wrapperFinal);
      }

      // -- Gera as semanas baseadas em sáb→sex
      const startView = new Date(arg.start.getFullYear(), arg.start.getMonth(), arg.start.getDate());
      const endViewEx = new Date(arg.end.getFullYear(), arg.end.getMonth(), arg.end.getDate());

      const plantaoWeeks = [];
      let curSat = prevOrSameSaturday(startView);
      while (curSat < endViewEx) {
        const ws = new Date(curSat);
        const we = new Date(curSat);
        we.setDate(ws.getDate() + 6);
        plantaoWeeks.push({
          inicioObj: new Date(ws),
          inicio: isoDate(ws),
          fim: isoDate(we)
        });
        curSat.setDate(curSat.getDate() + 7);
      }

      // Calcula offset a partir da primeira segunda-feira visível
      const firstMondayInView = nextOrSameMonday(startView);
      let offsetIndex = 0;
      for (let i = 0; i < plantaoWeeks.length; i++) {
        const mondayOfWeek = nextOrSameMonday(plantaoWeeks[i].inicioObj);
        if (mondayOfWeek.getTime() >= firstMondayInView.getTime()) {
          offsetIndex = i;
          break;
        }
      }

      // Cria options do select
      const sliceWeeks = plantaoWeeks.slice(offsetIndex);
      const opts = sliceWeeks.map((wk, idx) => {
        const globalIndex = offsetIndex + idx + 1;
        const label = `${formatBR(wk.inicio)} → ${formatBR(wk.fim)}`;
        return `<option value="${globalIndex}" data-inicio="${wk.inicio}" data-fim="${wk.fim}" data-global-index="${globalIndex}">${label}</option>`;
      }).join('');

      select.innerHTML = `<option value="">Selecione a semana</option>` + opts;

      // Handler de mudança (único)
      if (select.__weekHandler) {
        select.removeEventListener('change', select.__weekHandler, true);
        delete select.__weekHandler;
      }
      const handler = function(ev) {
        const opt = select.options[select.selectedIndex];
        debouncedOnChange(opt);
      };
      select.addEventListener('change', handler, true);
      select.__weekHandler = handler;

      // Se já tiver uma opção selecionada do servidor, dispara a mudança
      if (select.selectedIndex > 0) {
        setTimeout(() => {
          const opt = select.options[select.selectedIndex];
          debouncedOnChange(opt);
        }, 50);
      }
    };

    // Observador para reaplicar o handler quando o relatoriosContainer for re-renderizado
    const relContRoot = document.getElementById('relatoriosContainer');
    if (relContRoot && window.MutationObserver) {
      const mo = new MutationObserver(debounce(() => {
        // reaplica handler se select existir (populateWeeksSelect cuida de criar)
        const sel = document.getElementById('select-semana');
        if (sel && !sel.__weekHandler) {
          if (window._lastCalendarArg) {
            try { window.populateWeeksSelect(window._lastCalendarArg); } catch(e){ /*silent*/ }
          }
        }
      }, 80));
      mo.observe(relContRoot, { childList: true, subtree: true });
    }
  })(); // end IIFE for populateWeeksSelect helpers

  // Depois de injetar o relatório via AJAX, se houver um select e uma option selecionada,
  // escreve o label (caso o servidor já tenha injetado um "Semana X ...").
  (function ensureSelectedWeekLabelAfterLoad(){
    // observe mutações no contêiner de relatórios para reagir quando o HTML for substituído via AJAX
    const relCont = document.getElementById('relatoriosContainer');
    if (!relCont || !window.MutationObserver) return;
    const obs = new MutationObserver((mutations) => {
      const sel = document.getElementById('select-semana');
      if (sel && sel.selectedIndex > 0) {
        const opt = sel.options[sel.selectedIndex];
        writeSelectedWeekLabel(opt.textContent.trim(), opt.dataset.inicio, opt.dataset.fim);
      }
    });
    obs.observe(relCont, { childList: true, subtree: true });
  })();

  /* ---------- Excluir programação ---------- */
  btnExcluir?.addEventListener('click', async () => {
    if (!currentProgId && !inputData.value) return;

    const ok = confirm('Deseja realmente EXCLUIR toda a programação deste dia? Esta ação não pode ser desfeita.');
    if (!ok) return;

    btnExcluir.disabled = true;
    btnSalvar.disabled  = true;

    try {
      const resp = await fetch(window.excluirURL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': (document.cookie.match(/(^|;\s*)csrftoken=([^;]*)/)||[])[2] || '',
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({ programacao_id: currentProgId || undefined, data: currentProgId ? undefined : inputData.value }),
      });
      const data = await resp.json();
      if (!resp.ok || data.ok === false) throw new Error(data.error || 'Falha ao excluir.');

      alert('Programação excluída.');
      // limpa UI do modal
      metaCardsContainer.innerHTML = '';
      document.getElementById('servidoresLivres').innerHTML = '';
      document.querySelector('#tabelaImpedidos tbody').innerHTML = '';
      document.getElementById('expedienteAdmin').innerHTML = '';
      setDeleteEnabled(false);
      currentProgId = null;

      calendar.refetchEvents();
      bootstrap.Modal.getInstance(modalEl)?.hide();

    } catch (err) {
      console.error(err);
      alert(err.message || 'Erro ao excluir programação.');
    } finally {
      btnExcluir.disabled = false;
      btnSalvar.disabled  = false;
    }
  });

  /* ---------- Submit ---------- */
  function getCookie(name){
    const m = document.cookie.match(new RegExp('(^|;\\s*)' + name + '=([^;]*)'));
    return m ? decodeURIComponent(m[2]) : null;
  }

  document.getElementById('formAtividade').addEventListener('submit', async (e) => {
    e.preventDefault();

    // pegue APENAS os cards de atividade da coluna direita
    const allCards = Array.from(
      document.querySelectorAll('#metaCardsContainer .servidor-cardbox[data-meta-id]')
    );
    const nonEmptyCards = allCards.filter(c => c.querySelectorAll('.servidor-chip').length > 0);

    // remove visualmente cards vazios antes de montar payload
    const removedCount = allCards.length - nonEmptyCards.length;
    if (removedCount > 0) {
      allCards.filter(c => !nonEmptyCards.includes(c)).forEach(c => c.remove());
      updateCounts();
    }

    // ===== Validação de veículo =====
    const REQUIRE_VEICULO = false; // mude para true se quiser OBRIGAR veículo

    // limpar destaques antigos
    allCards.forEach(c => c.classList.remove('border','border-danger'));

    const invalid = [];
    for (const card of nonEmptyCards) {
      const sel = card.querySelector('.veiculo-select');
      const val = (sel && typeof sel.value === 'string') ? sel.value.trim() : '';

      const isPlaceholder =
        !sel || !val ||
        val.toLowerCase() === 'null' ||
        val.toLowerCase() === 'undefined' ||
        (sel && sel.selectedIndex === 0 && sel.options[0] && sel.options[0].disabled);

      if (isPlaceholder) invalid.push(card);
    }

    if (invalid.length) {
      const first = invalid[0];
      first.classList.add('border','border-danger');
      first.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });

      if (REQUIRE_VEICULO) {
        const title = (first.querySelector('.meta-title-text')?.textContent || 'Atividade').trim();
        alert(`Selecione o veículo no card: "${title}".`);
        first.querySelector('.veiculo-select')?.focus();
        return;
      } else {
        const ok = confirm(
          `${invalid.length} atividade(s) com servidores estão sem veículo.\nDeseja salvar assim mesmo?`
        );
        if (!ok) {
          first.querySelector('.veiculo-select')?.focus();
          return;
        }
      }
    }

    // ===== Montar payload (veiculo_id string ou null) =====
    const itens = nonEmptyCards.map(card => {
      const metaId = card.dataset.metaId;
      const servidores = Array.from(card.querySelectorAll('.servidor-chip')).map(ch => ch.dataset.id);

      const sel = card.querySelector('.veiculo-select');
      let veiculoId = null;
      if (sel) {
        const v = String(sel.value || '').trim();
        if (v !== '' && v.toLowerCase() !== 'null' && v.toLowerCase() !== 'undefined') {
          veiculoId = v; // envia como string (serve para int e UUID)
        }
      }
      return { meta_id: metaId, servidores, veiculo_id: veiculoId };
    });

    // confirmar limpeza total (sem itens)
    if (itens.length === 0) {
      const ok = window.confirm(
        'Nenhuma atividade com servidores.\nIsso vai APAGAR toda a programação deste dia.\nDeseja continuar?'
      );
      if (!ok) return;
    }

    const payload = { data: inputData.value, itens };
    btnSalvar.disabled = true;

    try {
      const resp = await fetch(window.salvarURL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify(payload),
      });

      const rawText = await resp.text();
      let data;
      try { data = JSON.parse(rawText); }
      catch { data = { ok: resp.ok, error: rawText || 'Resposta inválida do servidor.' }; }

      if (!resp.ok || data.ok === false) {
        throw new Error(data.error || 'Falha ao salvar a programação.');
      }

      alert(`Programação salva!\nAtividades: ${data.itens}\nServidores vinculados: ${data.servidores_vinculados}`);
      calendar.refetchEvents();
      bootstrap.Modal.getInstance(modalEl)?.hide();

    } catch (err) {
      console.error(err);
      alert(err.message || 'Erro ao salvar a programação.');
    } finally {
      btnSalvar.disabled = false;
    }

  });
});
</script>

{% endblock %}
