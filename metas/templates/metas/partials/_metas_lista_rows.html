{% for aloc in alocacoes %}
{% with meta=aloc.meta %}
<tr data-meta-status="{% if meta.encerrada %}encerrada{% elif meta.atrasada %}atrasada{% elif meta.concluida %}concluida{% else %}andamento{% endif %}"
    data-meta-data="{{ meta.data_limite|date:'Y-m-d' }}"
    data-meta-month="{{ meta.month_key|default:'nodate' }}"
    data-meta-area="{% if meta.atividade and meta.atividade.area %}{{ meta.atividade.area.code }}{% endif %}">
  <td>
    <i class="bi bi-card-text text-primary me-2" aria-hidden="true"></i>
    {% if meta.atividade %}
      {{ meta.atividade.titulo }}
    {% else %}
      {{ meta.display_titulo }}
    {% endif %}
  </td>
  <td class="text-center">{{ meta.data_limite|date:"d/m/Y"|default:"--" }}</td>
  <td class="text-center">{{ meta.quantidade_alvo|default:"0" }}</td>
  <td class="text-center">{{ aloc.programadas_total|default:"0" }}</td>
  <td>{{ aloc.realizado|default:"0" }}</td>
  <td>{{ aloc.percentual_execucao|floatformat:1 }}%</td>
  <td>
    {% if meta.encerrada %}
      <span class="badge bg-dark">Encerrada</span>
    {% elif meta.atrasada %}
      <span class="badge bg-danger">Atrasada</span>
    {% elif meta.concluida %}
      <span class="badge bg-success">Concluida</span>
    {% else %}
      <span class="badge bg-warning text-dark">Em andamento</span>
    {% endif %}
  </td>
  <td class="text-end">
    {% if request.user.is_superuser or meta.unidade_criadora_id == unidade.id %}
      <div class="d-inline-flex flex-wrap justify-content-end gap-2">
        <a href="{% url 'metas:editar' meta.id %}?next={{ request.get_full_path|urlencode }}"
           class="btn btn-sm btn-outline-warning">
          <i class="bi bi-pencil"></i> Editar
        </a>
        {% if meta.encerrada %}
          <form method="post"
                action="{% url 'metas:toggle_encerrada' meta.id %}"
                class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-arrow-clockwise"></i> Reabrir
            </button>
          </form>
        {% else %}
          <a href="{% url 'metas:encerrar-meta' meta.id %}?next={{ request.get_full_path|urlencode }}"
             class="btn btn-sm btn-outline-danger">
            <i class="bi bi-flag"></i> Encerrar
          </a>
        {% endif %}
        <a href="{% url 'metas:atribuir-meta' meta.id %}"
           class="btn btn-sm btn-outline-primary">
          <i class="bi bi-arrow-left-right"></i> Atribuir / Redistribuir / Editar
        </a>
      </div>
    {% else %}
      <span class="text-muted small">--</span>
    {% endif %}
  </td>
</tr>
{% endwith %}
{% endfor %}
