{% extends "core/base.html" %}

{% block title %}Encerrar meta{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Encerrar meta</h1>
    <a href="{{ next|default:'/metas/' }}" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Voltar
    </a>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="fw-semibold mb-3">
            <i class="bi bi-bullseye me-1"></i>
            {{ meta.display_titulo|default:meta.titulo }}
          </h6>

          <dl class="row mb-0 small">
            <dt class="col-sm-4">Unidade criadora</dt>
            <dd class="col-sm-8">{{ meta.unidade_criadora.nome }}</dd>

            {% if meta.atividade %}
              <dt class="col-sm-4">Atividade</dt>
              <dd class="col-sm-8">{{ meta.atividade.titulo|default:meta.atividade }}</dd>
            {% endif %}

            <dt class="col-sm-4">Data limite</dt>
            <dd class="col-sm-8">{{ meta.data_limite|date:"d/m/Y"|default:"--" }}</dd>

            <dt class="col-sm-4">Alvo total</dt>
            <dd class="col-sm-8">{{ total_alocado }} / {{ meta.quantidade_alvo|default:"0" }}</dd>

            <dt class="col-sm-4">Executado total</dt>
            <dd class="col-sm-8">{{ total_realizado }} ({{ percentual_execucao|floatformat:1 }}%)</dd>

            {% if meta.descricao %}
              <dt class="col-sm-4">Descricao</dt>
              <dd class="col-sm-8">{{ meta.descricao }}</dd>
            {% endif %}
          </dl>
        </div>
      </div>

      <div class="card shadow-sm mt-3">
        <div class="card-header bg-light py-2">
          <strong class="small text-uppercase">Distribuicao por unidade</strong>
        </div>
        <div class="card-body p-0">
          {% if alocacoes %}
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Unidade</th>
                    <th>Alocado</th>
                    <th>Executado</th>
                  </tr>
                </thead>
                <tbody>
                  {% for aloc in alocacoes %}
                    <tr {% if alocacao_atual and aloc.id == alocacao_atual.id %}class="table-warning"{% endif %}>
                      <td>{{ aloc.unidade.nome }}</td>
                      <td>{{ aloc.quantidade_alocada|default:"0" }}</td>
                      <td>{{ aloc.realizado|default:"0" }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="p-3 text-muted small">Nenhuma alocacao registrada para esta meta.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <form method="post" class="vstack gap-3">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ next }}">

            <div class="alert alert-warning mb-0 small">
              Encerrar uma meta impede novas programacoes ou atribuicoes enquanto ela permanecer encerrada.
            </div>

            <div>
              <label class="form-label d-block mt-1">Confirmar encerramento</label>
              <div class="form-check form-switch">
                <input type="checkbox"
                       class="form-check-input"
                       id="id_encerrar"
                       name="encerrar"
                       value="1"
                       {% if meta.encerrada %}checked disabled{% endif %}>
                <label class="form-check-label" for="id_encerrar">
                  Marque para confirmar que a meta foi concluida.
                </label>
              </div>
            </div>

            <div class="d-flex justify-content-end gap-2">
              <a href="{{ next|default:'/metas/' }}" class="btn btn-light">Cancelar</a>
              <button class="btn btn-danger" type="submit" {% if meta.encerrada %}disabled{% endif %}>
                <i class="bi bi-check2-circle me-1"></i> Encerrar meta
              </button>
            </div>
          </form>
        </div>
      </div>

      {% if alocacao_atual %}
        <div class="small text-muted mt-2">
          Nesta unidade: <strong>{{ executado_unidade }}</strong> executado de {{ alocado_unidade }} alocado.
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
