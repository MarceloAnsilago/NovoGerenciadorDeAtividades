{% extends "core/base.html" %}
{% load static %}

{% block title %}Encerrar meta{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h1 class="h4 mb-1">Encerrar meta</h1>
      <div class="text-muted small">
        Unidade responsavel: {{ meta.unidade_criadora.nome|default:"--" }}
      </div>
    </div>
    <a href="{{ next_url }}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left"></i> Voltar
    </a>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-center">
        <div class="col-12 col-lg-5">
          <h2 class="h5 mb-1">{{ meta.display_titulo|default:meta.titulo }}</h2>
          {% if meta.atividade %}
            <div class="text-muted small mb-1">
              Atividade vinculada: {{ meta.atividade.titulo }}
            </div>
          {% endif %}
          {% if meta.descricao %}
            <p class="mb-0 small text-muted">{{ meta.descricao }}</p>
          {% endif %}
        </div>
        <div class="col-12 col-lg-7">
          <div class="row text-center g-3">
            <div class="col-6 col-md-3">
              <div class="small text-muted">Meta alvo</div>
              <div class="fs-5 fw-semibold">{{ meta_alvo }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="small text-muted">Alocado (nivel atual)</div>
              <div class="fs-5 fw-semibold">{{ aloc_top_total }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="small text-muted">Realizado</div>
              <div class="fs-5 fw-semibold">{{ meta_realizado_total }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="small text-muted">% execucao</div>
              <div class="fs-5 fw-semibold">{{ meta_percentual|floatformat:1 }}%</div>
            </div>
          </div>
          {% if meta.data_limite %}
            <div class="text-muted small text-end mt-2">
              Prazo: {{ meta.data_limite|date:"d/m/Y" }}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
      <strong><i class="bi bi-diagram-3 me-2"></i>Estratificacao da meta</strong>
    </div>
    <div class="card-body">
      {% if tem_alocacoes %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th scope="col">Unidade</th>
                <th scope="col">Alocado</th>
                <th scope="col">Realizado</th>
                <th scope="col">% Exec.</th>
                <th scope="col">Saldo</th>
                <th scope="col">Obs.</th>
              </tr>
            </thead>
            <tbody>
              {% include "metas/partials/_aloc_tree_rows.html" with nodes=aloc_tree %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-muted text-center py-3">
          Nenhuma alocacao registrada para esta meta.
        </div>
      {% endif %}
    </div>
  </div>

  <form method="post" class="vstack gap-4">
    {% csrf_token %}
    <input type="hidden" name="next" value="{{ next_url }}">

    {% if inconsistencias %}
    <div class="card shadow-sm border-warning">
      <div class="card-header bg-warning-subtle">
        <strong><i class="bi bi-exclamation-triangle me-2"></i>Inconsistencias identificadas</strong>
      </div>
      <div class="card-body vstack gap-3">
        <div>
          <ul class="mb-0">
            {% for item in inconsistencias %}
              <li>{{ item.message }}</li>
            {% endfor %}
          </ul>
        </div>

        {% if pendentes_total %}
          <div class="alert alert-warning mb-0">
            <strong>Atencao:</strong> existem {{ pendentes_total }} atividade{{ pendentes_total|pluralize }} desta meta pendente{{ pendentes_total|pluralize }}.
            {% if pendentes_preview %}
              <ul class="mt-2 mb-0 ps-3">
                {% for pend in pendentes_preview %}
                  <li>
                    {% if pend.data %}{{ pend.data|date:"d/m/Y" }}{% else %}Sem data{% endif %}
                    - Item #{{ pend.id }}
                    {% if pend.unidade %}(Unidade: {{ pend.unidade }}){% endif %}
                    {% if pend.veiculo %}(Veiculo: {{ pend.veiculo }}){% endif %}
                  </li>
                {% endfor %}
                {% if pendentes_tem_mais %}
                  <li>... e outros itens pendentes.</li>
                {% endif %}
              </ul>
            {% endif %}
          </div>
          <div class="form-check">
            <input class="form-check-input"
                   type="checkbox"
                   id="id_resolver_pendentes"
                   name="resolver_pendentes"
                   value="1"
                   {% if resolver_pendentes_checked %}checked{% endif %}>
            <label class="form-check-label" for="id_resolver_pendentes">
              Desejo encerrar automaticamente as atividades pendentes.
            </label>
          </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <strong><i class="bi bi-flag me-2"></i>Confirmacoes para encerrar</strong>
      </div>
      <div class="card-body vstack gap-3">
        <div class="form-check">
          <input class="form-check-input {% if form_errors.encerrar_agora %}is-invalid{% endif %}"
                 type="checkbox"
                 id="id_encerrar_agora"
                 name="encerrar_agora"
                 value="1"
                 {% if encerrar_agora_checked %}checked{% endif %}>
          <label class="form-check-label fw-semibold" for="id_encerrar_agora">
            Desejo encerrar esta meta agora.
          </label>
          <div class="form-text">
            O encerramento impede novos registros de progresso ou redistribuicoes atreladas a esta meta.
          </div>
          {% if form_errors.encerrar_agora %}
            <div class="invalid-feedback d-block">{{ form_errors.encerrar_agora }}</div>
          {% endif %}
        </div>

        {% if mostrar_confirmar_pendentes %}
          <div class="form-check">
            <input class="form-check-input {% if form_errors.confirmar_pendentes %}is-invalid{% endif %}"
                   type="checkbox"
                   id="id_confirmar_pendentes"
                   name="confirmar_pendentes"
                   value="1"
                   {% if confirmar_pendentes_checked %}checked{% endif %}>
            <label class="form-check-label" for="id_confirmar_pendentes">
              Confirmo que desejo encerrar a meta mesmo com atividades pendentes nao solucionadas automaticamente.
            </label>
            <div class="form-text">
              Utilize a opcao acima para encerrar automaticamente as pendencias, caso deseje.
            </div>
            {% if form_errors.confirmar_pendentes %}
              <div class="invalid-feedback d-block">{{ form_errors.confirmar_pendentes }}</div>
            {% endif %}
          </div>
        {% endif %}
      </div>
      <div class="card-footer d-flex justify-content-end gap-2">
        <a href="{{ next_url }}" class="btn btn-light">Cancelar</a>
        <button type="submit" class="btn btn-danger">
          <i class="bi bi-check2-circle me-1"></i> Encerrar meta
        </button>
      </div>
    </div>
  </form>
</div>
{% endblock %}
