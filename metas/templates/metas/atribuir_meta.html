{% extends "core/base.html" %}
{% load static %}
{% block title %}Atribuir Meta{% endblock %}

{% block content %}
<div class="container py-4">
  {% url 'metas:metas-unidade' as back_url %}
  {% include "partials/_page_header.html" with title="Atribuir Meta" subtitle=meta.titulo back_url=back_url icon="bi-list-check" %}

  <div class="card shadow-sm">
    <div class="card-body">

      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-3">
        <p class="mb-0">
          Crie a alocação desta meta para a unidade <strong>{{ unidade.nome }}</strong>:
        </p>
        {% if request.user.is_superuser or meta.unidade_criadora_id == unidade.id %}
          <form method="post"
                action="{% url 'metas:excluir-meta' meta.id %}"
                onsubmit="return confirm('Tem certeza que deseja excluir esta meta? Essa ação não pode ser desfeita.');">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn btn-outline-danger btn-sm">
              <i class="bi bi-trash"></i> Excluir meta
            </button>
          </form>
        {% endif %}
      </div>

      <!-- Resumo da meta -->
      <div class="mb-3">
        <div class="row gx-3 gy-2 align-items-center">
          <div class="col-auto">
            <div class="small text-muted">Alvo</div>
            <div class="fw-bold">{{ meta.quantidade_alvo|default_if_none:"0" }}</div>
          </div>

          <div class="col-auto">
            <div class="small text-muted">Já alocado</div>
            <div class="fw-bold">{{ meta.alocado_total|default_if_none:"0" }}</div>
          </div>

          <div class="col-auto">
            <div class="small text-muted">Ainda a alocar (atual)</div>
            {% if restante is not None %}
              <div id="remainingCurrent" class="fw-bold">{{ restante }}</div>
            {% else %}
              <div id="remainingCurrent" class="fw-bold">Sem limite</div>
            {% endif %}
          </div>

          <div class="col-auto">
            <div class="small text-muted">Após alterações (previsto)</div>
            <div id="remainingPredicted" class="fw-bold">—</div>
          </div>

          <div class="col text-end">
            <button id="expandAll" class="btn btn-sm btn-outline-secondary me-2">Expandir tudo</button>
            <button id="collapseAll" class="btn btn-sm btn-outline-secondary">Recolher tudo</button>
          </div>
        </div>

        <div class="mt-2">
          <small class="text-muted">Legenda: <strong>As alterações só surtirão efeito após salvar.</strong></small>
        </div>

        <hr>
      </div>
      <!-- /Resumo da meta -->

      {# injetamos meta_info de forma segura para o JS #}
      {{ meta_info|json_script:"meta-data" }}

      {# ===== CSS local para destacar hierarquia (pode mover para arquivo global) ===== #}
      <style>
      /* destaque do nodo (supervisor/gerente) */
      .nodo-row {
        background-color: #f5fbff;
        border-left: 4px solid #0d6efd;
      }
      .child-row .unidade-cell {
        padding-left: 1.6rem;
        color: #333;
      }
      .nodo-row .unidade-cell {
        padding-left: 0.6rem;
      }

      /* ícones */
      .unidade-cell i.bi { font-size: 1.05rem; vertical-align: middle; }

      /* badge pequeno para indicar 'Supervisor' e total do grupo */
      .unidade-badge { font-size: 0.7rem; padding: 0.25rem 0.4rem; vertical-align: middle; }
      .group-total-badge { font-size: 0.75rem; padding: 0.25rem 0.45rem; vertical-align: middle; }

      /* highlight quando algum filho tem valor */
      .nodo-row.highlighted {
        box-shadow: 0 0 0 .25rem rgba(13,110,253, 0.06);
      }

      /* limpeza visual */
      .table .align-middle { vertical-align: middle; }
      </style>

      <form method="post" novalidate id="atribuirForm">
        {% csrf_token %}

        <div class="accordion" id="accordionGrupos">
          {% for nodo, unidades_data in grupos_with_data %}
            {% with idx=forloop.counter %}
            <div class="accordion-item mb-3" data-idx="{{ idx }}">
              <h2 class="accordion-header" id="heading{{ idx }}">
                <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapse{{ idx }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                        aria-controls="collapse{{ idx }}">
                  {{ nodo.nome }}
                  <span class="ms-3 text-muted small">({{ unidades_data|length }} unidade(s))</span>
                  <!-- badge de total do grupo (atualizado por JS) -->
                  <span class="badge bg-light text-dark ms-3 group-total-badge" data-group-idx="{{ idx }}">0</span>
                </button>
              </h2>

              <div id="collapse{{ idx }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                   aria-labelledby="heading{{ idx }}" data-bs-parent="#accordionGrupos">
                <div class="accordion-body">
                  <div class="table-responsive">
                    <table class="table table-borderless align-middle mb-0">
                      <thead>
                        <tr>
                          <th style="width:45%">Unidade</th>
                          <th style="width:20%">Quantidade</th>
                          <th style="width:35%">Observação</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for item in unidades_data %}
                          {% with u=item.unidade aloc=item.alocacao %}
                          {# detecta se esta linha é o nodo (supervisor) #}
                          <tr class="{% if u.pk == nodo.pk %}nodo-row{% else %}child-row{% endif %}">
                            <td class="align-middle unidade-cell">
                              {% if u.pk == nodo.pk %}
                                {# ícone supervisor (Bootstrap Icons) #}
                                <i class="bi bi-folder-fill text-primary me-2" aria-hidden="true"></i>
                                <strong>{{ u.nome }}</strong>
                                <span class="badge bg-secondary unidade-badge ms-2">Supervisor</span>

                                {# botão Redistribuir aparece quando há alocação existente neste nodo #}
                                {% if aloc and aloc.quantidade_alocada %}
                                  {% if unidade_atual.id == u.id or request.user.is_superuser %}
                                    <a href="{% url 'metas:redistribuir-meta' meta.id aloc.id %}" class="btn btn-sm btn-outline-primary ms-3">
                                      Redistribuir para filhos
                                    </a>
                                  {% endif %}
                                {% endif %}
                            {% else %}
                                <i class="bi bi-file-earmark-text text-muted me-2" aria-hidden="true"></i>
                                {{ u.nome }}
                              {% endif %}
                            </td>

                            <td>
                              <input
                                type="number"
                                name="quantity_{{ u.id }}"
                                min="0"
                                class="form-control quantity-input"
                                data-unit-id="{{ u.id }}"
                                data-existing="{{ aloc.quantidade_alocada|default_if_none:0 }}"
                                data-group-idx="{{ idx }}"
                                value="{% if item.submitted_qty is not None %}{{ item.submitted_qty }}{% elif aloc %}{{ aloc.quantidade_alocada }}{% else %}0{% endif %}">
                            </td>

                            <td>
                              <input
                                type="text"
                                name="obs_{{ u.id }}"
                                class="form-control"
                                value="{% if item.submitted_obs is not None %}{{ item.submitted_obs }}{% elif aloc %}{{ aloc.observacao }}{% else %}{% endif %}"
                                placeholder="Observação (opcional)">
                            </td>
                          </tr>
                          {% endwith %}
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            {% endwith %}
          {% empty %}
            <div class="alert alert-warning">Nenhuma unidade subordinada encontrada para atribuir nesta unidade.</div>
          {% endfor %}
        </div>

        <div class="mt-3">
          <button type="submit" id="submitBtn" class="btn btn-primary">Atribuir</button>
          <a href="{{ back_url }}" class="btn btn-secondary ms-2">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>

{# ===== JS ===== #}
<script>
document.addEventListener("DOMContentLoaded", function(){
  const expandBtn = document.getElementById("expandAll");
  const collapseBtn = document.getElementById("collapseAll");
  const accordionItems = document.querySelectorAll('#accordionGrupos .accordion-collapse');
  const qtyInputs = Array.from(document.querySelectorAll('.quantity-input'));
  const remainingCurrent = document.getElementById('remainingCurrent');
  const remainingPredicted = document.getElementById('remainingPredicted');
  const submitBtn = document.getElementById('submitBtn');

  // lê meta_info de forma segura (json_script)
  const metaInfoEl = document.getElementById('meta-data');
  const metaInfo = metaInfoEl ? JSON.parse(metaInfoEl.textContent) : { meta_alvo: 0, meta_alocado_total: 0, existing_for_units: 0 };
  const metaAlvo = Number(metaInfo.meta_alvo || 0);
  const metaAlocadoTotal = Number(metaInfo.meta_alocado_total || 0);
  const existingForUnits = Number(metaInfo.existing_for_units || 0); // soma apenas das unidades da tela (server)

  // agrupa inputs por group index (data-group-idx)
  const groupsMap = {};
  qtyInputs.forEach(inp => {
    const g = inp.dataset.groupIdx || "0";
    if (!groupsMap[g]) groupsMap[g] = [];
    groupsMap[g].push(inp);
  });

  // helpers
  function sumInputs(list) {
    return list.reduce((acc, inp) => {
      let v = Number(inp.value);
      if (isNaN(v)) v = 0;
      return acc + v;
    }, 0);
  }

  function sumEntered() {
    return qtyInputs.reduce((acc, inp) => {
      let val = Number(inp.value);
      if (isNaN(val)) val = 0;
      return acc + val;
    }, 0);
  }

  // atualiza badges e destaque por grupo
  function refreshGroupsUI() {
    Object.keys(groupsMap).forEach(gidx => {
      const inputs = groupsMap[gidx];
      const total = sumInputs(inputs);
      // atualiza badge
      const badge = document.querySelector('.group-total-badge[data-group-idx="'+gidx+'"]');
      if (badge) badge.textContent = total;

      // encontra o accordion-item correspondente (data-idx no .accordion-item)
      const accordionItem = document.querySelector('.accordion-item[data-idx="'+gidx+'"]');
      if (accordionItem) {
        // a linha do nodo (supervisor) dentro do accordion item
        const nodoRow = accordionItem.querySelector('.nodo-row');
        if (nodoRow) {
          nodoRow.classList.toggle('highlighted', total > 0);
        }
      }
    });
  }

  function computeAndRenderRemaining() {
    // valor atual (servidor)
    const currentRemaining = (metaAlvo && metaAlvo > 0) ? (metaAlvo - metaAlocadoTotal) : null;
    if (currentRemaining === null) {
      remainingCurrent.textContent = "Sem limite";
    } else {
      remainingCurrent.textContent = currentRemaining;
    }

    // soma digitada pelo usuário
    const sum = sumEntered();

    // novo total se aplicarmos mudanças: substituímos existingForUnits por sum
    const newTotal = metaAlocadoTotal - existingForUnits + sum;

    if (!metaAlvo || metaAlvo === 0) {
      remainingPredicted.textContent = "Sem limite";
      remainingPredicted.classList.remove("text-danger", "text-success");
      submitBtn.disabled = false;
    } else {
      const predicted = metaAlvo - newTotal;
      remainingPredicted.textContent = predicted;
      if (predicted < 0) {
        remainingPredicted.classList.add("text-danger");
        remainingPredicted.classList.remove("text-success");
        submitBtn.disabled = true;
      } else {
        remainingPredicted.classList.remove("text-danger");
        remainingPredicted.classList.add("text-success");
        submitBtn.disabled = false;
      }
    }

    // atualização visual de grupos
    refreshGroupsUI();
  }

  // listeners para inputs
  qtyInputs.forEach(inp => inp.addEventListener('input', computeAndRenderRemaining));

  // expand / collapse all
  expandBtn.addEventListener("click", function(e){
    e.preventDefault();
    accordionItems.forEach(item => {
      const bs = bootstrap.Collapse.getOrCreateInstance(item);
      bs.show();
    });
  });

  collapseBtn.addEventListener("click", function(e){
    e.preventDefault();
    accordionItems.forEach(item => {
      const bs = bootstrap.Collapse.getOrCreateInstance(item);
      bs.hide();
    });
  });

  // cálculo inicial
  computeAndRenderRemaining();

  // também atualiza badges caso valores default (carregados do servidor) já existam
  refreshGroupsUI();
});
</script>
{% endblock %}
