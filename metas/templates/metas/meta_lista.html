{% extends "core/base.html" %}
{% load static %}

{% block title %}Metas da Unidade{% endblock %}

{% block content %}
<div class="container py-4">
  {% url 'metas:atividades-lista' as metas_inicio_url %}
  {% include "partials/_page_header.html" with title="Metas" subtitle="Unidade atual: "|add:unidade.nome back_url=metas_inicio_url icon="bi-bullseye" %}

  {% if not has_unidade %}
    <div class="alert alert-warning mb-3">
      Selecione ou assuma uma unidade antes de criar ou visualizar metas. Utilize o menu de contexto no topo da pagina.
    </div>
  {% endif %}

  {% if atividade_filtrada %}
    <div class="alert alert-info d-flex justify-content-between align-items-center">
      <div>
        Metas filtradas pela atividade:
        <strong>{{ atividade_filtrada.titulo|default:atividade_filtrada }}</strong>
        {% if atividade_filtrada.id %}
          <span class="text-muted">(ID {{ atividade_filtrada.id }})</span>
        {% endif %}
      </div>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'metas:metas-unidade' %}">Limpar filtro</a>
    </div>
  {% endif %}

  {% if area_selected or status_selected %}
    <div class="alert alert-info d-flex justify-content-between align-items-center">
      <div>
        {% if area_selected %}
          Filtro de área: <strong>{{ area_selected }}</strong>
        {% endif %}
        {% if status_selected %}
          {% if area_selected %} · {% endif %}
          Status: <strong>{{ status_selected }}</strong>
        {% endif %}
      </div>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'metas:metas-unidade' %}">Limpar filtro</a>
    </div>
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-header bg-light">
      <strong><i class="bi bi-bullseye me-1"></i> Metas Alocadas</strong>
    </div>
    <div class="card-body">
      {% if alocacoes %}
        <div class="table-responsive">
          <table class="table table-striped align-middle mb-0">
            <thead>
              <tr>
                <th>Titulo</th>
                <th>Atividade</th>
                <th>Prazo</th>
                <th>Alocacao</th>
                <th>Realizado</th>
                <th>% Execucao</th>
                <th>Status</th>
                <th class="text-end">Acoes</th>
              </tr>
            </thead>
            <tbody>
              {% for aloc in alocacoes %}
              <tr>
                <td>{{ aloc.meta.display_titulo }}</td>
                <td>
                  {% if aloc.meta.atividade %}
                    {{ aloc.meta.atividade.titulo }}
                  {% else %}
                    <span class="text-muted">--</span>
                  {% endif %}
                </td>
                <td>{{ aloc.meta.data_limite|date:"d/m/Y"|default:"--" }}</td>
                <td>{{ aloc.quantidade_alocada|default:"0" }}</td>
                <td>{{ aloc.realizado|default:"0" }}</td>
                <td>{{ aloc.percentual_execucao|floatformat:1 }}%</td>
                <td>
                  {% if aloc.meta.encerrada %}
                    <span class="badge bg-dark">Encerrada</span>
                  {% elif aloc.meta.atrasada %}
                    <span class="badge bg-danger">Atrasada</span>
                  {% elif aloc.meta.concluida %}
                    <span class="badge bg-success">Concluida</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">Em andamento</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  {% if request.user.is_superuser or aloc.meta.unidade_criadora_id == unidade.id %}
                    <div class="d-inline-flex flex-wrap justify-content-end gap-2">
                      {% if aloc.meta.encerrada %}
                        <form method="post" action="{% url 'metas:toggle_encerrada' aloc.meta.id %}" class="d-inline">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{{ request.get_full_path }}">
                          <button type="submit" class="btn btn-sm btn-outline-secondary" title="Reabrir meta">
                            <i class="bi bi-arrow-clockwise"></i> Reabrir
                          </button>
                        </form>
                      {% else %}
                        <a href="{% url 'metas:encerrar-meta' aloc.meta.id %}?next={{ request.get_full_path|urlencode }}"
                           class="btn btn-sm btn-outline-danger">
                          <i class="bi bi-flag"></i> Encerrar
                        </a>
                      {% endif %}
                      <a href="{% url 'metas:atribuir-meta' aloc.meta.id %}"
                         class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-left-right"></i> Atribuir / Redistribuir
                      </a>
                    </div>
                  {% else %}
                    <span class="text-muted small">Sem acoes disponiveis</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center py-4 text-muted">
          {% if has_unidade %}
            Nenhuma meta alocada.
          {% else %}
            Assuma uma unidade para visualizar as metas disponiveis.
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
