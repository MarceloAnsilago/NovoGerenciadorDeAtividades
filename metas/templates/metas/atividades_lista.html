{% extends "core/base.html" %}
{% load static %}

{% block title %}Atividades da Unidade{% endblock %}

{% block content %}
<div class="container py-4 d-flex flex-column">
  {% url 'core:dashboard' as dash_url %}
  {% include "partials/_page_header.html" with title="Atividades" subtitle="Unidade atual: "|add:unidade_nome back_url=dash_url icon="bi-list-task" %}

  {% if has_unidade %}
  <div class="card shadow-sm order-2">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <div>
        <strong><i class="bi bi-bullseye me-1"></i> Metas Alocadas</strong>
        <div class="small text-muted">Visualização geral das metas da unidade.</div>
      </div>
      <a href="{% url 'metas:metas-unidade' %}" class="btn btn-sm btn-outline-secondary">Abrir tela completa</a>
    </div>
    <div class="card-body">
      <div class="mb-3 d-flex flex-wrap align-items-center justify-content-between gap-3" id="metasMonthTabsWrapper">
        <div class="flex-grow-1">
          {% if meta_month_filters %}
            <ul class="nav nav-tabs" id="metasMonthTabs" role="tablist">
              {% for filter in meta_month_filters %}
                <li class="nav-item" role="presentation">
                  <button class="nav-link {% if filter.key == meta_month_default %}active{% elif forloop.first and not meta_month_default %}active{% endif %}" type="button" role="tab" data-month-filter="{{ filter.key }}">
                    {{ filter.label }}
                  </button>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0 small">Nenhuma meta com data limite para o filtro atual.</p>
          {% endif %}
        </div>
        <div class="d-flex align-items-center gap-2">
          <label for="metaYearSelect" class="form-label small mb-0">Ano</label>
          <select id="metaYearSelect" class="form-select form-select-sm" aria-label="Filtrar metas por ano">
            {% if years %}
              {% for y in years %}
                <option value="{{ y }}" {% if ano_selected == y %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            {% else %}
              <option value="" selected>Sem anos disponíveis</option>
            {% endif %}
          </select>
        </div>
      </div>

      <div class="row g-2 mb-3">
        <div class="col-lg-3 col-md-6">
          <label class="form-label mb-1">Periodo</label>
          <div class="d-flex gap-2">
            <input type="date" id="filtroMetasInicio" class="form-control form-control-sm">
            <input type="date" id="filtroMetasFim" class="form-control form-control-sm">
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <label class="form-label mb-1">Status</label>
          <select id="filtroMetasStatus" class="form-select form-select-sm">
            <option value="">Todos</option>
            <option value="andamento" selected>Em andamento</option>
            <option value="concluida">Concluidas</option>
            <option value="atrasada">Atrasadas</option>
            <option value="encerrada">Encerradas</option>
          </select>
        </div>
        <div class="col-lg-3 col-md-6">
          <label class="form-label mb-1">Area</label>
          <select id="filtroMetasArea" class="form-select form-select-sm">
            <option value="">Todas</option>
            {% for area_obj in areas %}
              <option value="{{ area_obj.code }}" {% if area_obj.code == area_selected %}selected{% endif %}>{{ area_obj.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-lg-3 col-md-6 d-flex align-items-end">
          <button type="button" class="btn btn-outline-primary w-100" id="btnAplicarFiltroMetas">
            <i class="bi bi-funnel"></i> Aplicar filtro
          </button>
        </div>
      </div>

      <div class="table-responsive" id="tabelaMetasWrap">
          <table class="table table-striped align-middle mb-0">
            <thead>
              <tr>
                <th>Atividade</th>
                <th class="text-center">Prazo</th>
                <th class="text-center">Meta (alvo)</th>
                <th class="text-center">Programadas</th>
                <th>Realizado</th>
                <th>% Execucao</th>
                <th>Status</th>
                <th class="text-end">Acoes</th>
              </tr>
            </thead>
            <tbody id="tabelaMetasBody">
              {% include "metas/partials/_metas_lista_rows.html" with alocacoes=alocacoes %}
              {% if alocacoes %}
            <tr class="metas-empty-row d-none">
              <td colspan="8" class="text-center text-muted py-4">Nenhuma meta encontrada para os filtros informados.</td>
            </tr>
              {% else %}
            <tr class="metas-empty-row">
              <td colspan="8" class="text-center text-muted py-4">Nenhuma meta encontrada para os filtros informados.</td>
            </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
  </div>
  {% endif %}

  <div class="card shadow-sm mb-4 order-1">
    <div class="card-header bg-light">
      <strong><i class="bi bi-list-task me-1"></i> Definir metas - Atividades Cadastradas</strong>
    </div>

    <div class="card-body">
      <!-- Filtros -->
      <form method="get" class="row g-2 mb-3">
        <div class="col-md-4">
          <label class="form-label mb-0">Área</label>
          <select name="area" class="form-select">
            <option value="">Todas</option>
            {% for area_obj in areas %}
              <option value="{{ area_obj.code }}" {% if area_obj.code == area_selected %}selected{% endif %}>{{ area_obj.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-5">
          <label class="form-label mb-0">Buscar</label>
          <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Titulo ou descricao">
        </div>

        <div class="col-md-3 d-flex align-items-end justify-content-end gap-2">
          <button type="submit" class="btn btn-outline-primary">
            <i class="bi bi-search"></i> Filtrar
          </button>
          <a href="{% url 'atividades:lista' %}?next={{ request.get_full_path|urlencode }}" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Cadastrar atividade
          </a>
        </div>
      </form>

      <!-- Tabela -->
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th><i class="bi bi-card-text me-1"></i> Titulo</th>
            <th>Descricao</th>
            <th>Area</th>
            <th class="text-end">Acoes</th>
          </tr>
        </thead>
        <tbody>
          {% for atividade in atividades %}
            <tr>
              <td>
                <i class="bi bi-card-text text-primary me-1" aria-hidden="true"></i>
                {{ atividade.titulo }}
              </td>
              <td>{{ atividade.descricao|default:"" }}</td>
              <td>
                {% if atividade.area %}
                  <span class="badge bg-secondary">{{ atividade.area.nome }}</span>
                {% endif %}
              </td>
              <td class="text-end">
                <a href="{% url 'metas:metas-unidade' %}?atividade={{ atividade.id }}" class="btn btn-sm btn-outline-secondary me-1">
                  <i class="bi bi-eye"></i> Ver metas definidas
                </a>
                <a href="{% url 'metas:definir-meta' atividade.id %}" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-bullseye"></i> Definir Metas
                </a>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="4" class="text-center">Nenhuma atividade encontrada.</td></tr>
          {% endfor %}
        </tbody>
      </table>

      {% if page_obj %}
      <nav class="mt-3">
        <ul class="pagination justify-content-end mb-0">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?{% if atividades_filters_qs %}{{ atividades_filters_qs }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link" tabindex="-1" aria-disabled="true">Anterior</span></li>
          {% endif %}
          <li class="page-item disabled">
            <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
          </li>
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?{% if atividades_filters_qs %}{{ atividades_filters_qs }}&{% endif %}page={{ page_obj.next_page_number }}">Próxima</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link" tabindex="-1" aria-disabled="true">Próxima</span></li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
(function() {
  var btnFiltro = document.getElementById("btnAplicarFiltroMetas");
  var tbody = document.getElementById("tabelaMetasBody");
  var monthTabs = Array.from(document.querySelectorAll("#metasMonthTabs .nav-link"));
  var startInput = document.getElementById("filtroMetasInicio");
  var endInput = document.getElementById("filtroMetasFim");
  var areaSelect = document.getElementById("filtroMetasArea");
  var yearSelect = document.getElementById("metaYearSelect");
  var selectedMonthKey = "{{ meta_month_default|default:'' }}";
  var AREA_ANIMAL = "ANIMAL";
  var AREA_VEGETAL = "VEGETAL";
  var AREA_ANIMAL_VEGETAL = "ANIMAL_VEGETAL";
  if (!btnFiltro || !tbody) return;

  if (yearSelect) {
    yearSelect.addEventListener("change", function () {
      var url = new URL(window.location.href);
      var ano = yearSelect.value;
      if (ano) url.searchParams.set("ano", ano);
      else url.searchParams.delete("ano");
      if (areaSelect && areaSelect.value) url.searchParams.set("area", areaSelect.value);
      else url.searchParams.delete("area");
      url.searchParams.delete("month");
      window.location.href = url.toString();
    });
  }

  function parseDate(value) {
    if (!value) return null;
    var parts = value.split("-");
    if (parts.length !== 3) return null;
    var year = Number(parts[0]);
    var month = Number(parts[1]) - 1;
    var day = Number(parts[2]);
    var dt = new Date(year, month, day);
    return Number.isNaN(dt.getTime()) ? null : dt;
  }

  function getRangeFromMonthKey(key) {
    if (!key || key === "nodate") return null;
    var parts = key.split("-");
    if (parts.length !== 2) return null;
    var year = Number(parts[0]);
    var month = Number(parts[1]);
    if (!Number.isFinite(year) || !Number.isFinite(month) || month < 1 || month > 12) return null;
    var start = new Date(year, month - 1, 1);
    var end = new Date(year, month, 0);
    var pad = function(n) { return String(n).padStart(2, "0"); };
    return {
      start: year + "-" + pad(month) + "-" + pad(start.getDate()),
      end: year + "-" + pad(month) + "-" + pad(end.getDate())
    };
  }

  function applyRangeInputs(range) {
    if (!startInput || !endInput) return;
    if (!range) {
      startInput.value = "";
      endInput.value = "";
      return;
    }
    startInput.value = range.start;
    endInput.value = range.end;
  }

  function aplicarFiltro() {
    var inicio = parseDate(document.getElementById("filtroMetasInicio")?.value || "");
    var fim = parseDate(document.getElementById("filtroMetasFim")?.value || "");
    var status = (document.getElementById("filtroMetasStatus")?.value || "").toLowerCase();
    var area = (areaSelect?.value || "").toUpperCase();
    var monthKey = (selectedMonthKey || "").toLowerCase();

    var rows = Array.from(tbody.querySelectorAll("tr"));
    var emptyRow = tbody.querySelector(".metas-empty-row");
    var visibleCount = 0;

    rows.forEach(function(row) {
      if (row.classList.contains("metas-empty-row")) return;

      var rowStatus = (row.getAttribute("data-meta-status") || "").toLowerCase();
      var rowDataRaw = row.getAttribute("data-meta-data") || "";
      var rowMonthKey = (row.getAttribute("data-meta-month") || "").toLowerCase();
      var rowArea = (row.getAttribute("data-meta-area") || "").toUpperCase();
      var rowDate = parseDate(rowDataRaw);

      var visible = true;
      if (status && rowStatus !== status) visible = false;
      if (visible && monthKey && rowMonthKey !== monthKey) visible = false;
      if (visible && inicio && rowDate && rowDate < inicio) visible = false;
      if (visible && fim && rowDate && rowDate > fim) visible = false;
      if (visible && area) {
        if (area === AREA_ANIMAL) {
          visible = rowArea === AREA_ANIMAL || rowArea === AREA_ANIMAL_VEGETAL;
        } else if (area === AREA_VEGETAL) {
          visible = rowArea === AREA_VEGETAL || rowArea === AREA_ANIMAL_VEGETAL;
        } else {
          visible = rowArea === area;
        }
      }

      row.classList.toggle("d-none", !visible);
      if (visible) visibleCount += 1;
    });

    if (emptyRow) {
      emptyRow.classList.toggle("d-none", visibleCount > 0);
    }
  }

  btnFiltro.addEventListener("click", aplicarFiltro);
  if (monthTabs.length) {
    var activeTab = monthTabs.find(function(t){ return t.classList.contains("active"); }) || monthTabs[0];
    selectedMonthKey = activeTab ? (activeTab.getAttribute("data-month-filter") || "") : "";
    var initialRange = getRangeFromMonthKey(selectedMonthKey);
    applyRangeInputs(initialRange);

    monthTabs.forEach(function(tab) {
      tab.addEventListener("click", function() {
        selectedMonthKey = tab.getAttribute("data-month-filter") || "";
        monthTabs.forEach(function(t) {
          var key = t.getAttribute("data-month-filter") || "";
          t.classList.toggle("active", key === selectedMonthKey);
        });
        var range = getRangeFromMonthKey(selectedMonthKey);
        applyRangeInputs(range);
        aplicarFiltro();
      });
    });
  }
  aplicarFiltro();
})();
</script>
{% endblock %}
