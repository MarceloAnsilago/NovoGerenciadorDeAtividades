{# templates/controle_acesso/gerenciar_permissoes.html #}
{% extends "core/base.html" %}
{% load perm_utils %}

{% block title %}Permissões de {{ usuario.username }}{% endblock %}

{% block content %}
<h1>Permissões de {{ usuario.username }}</h1>

<form method="post">
  {% csrf_token %}

  <div class="d-flex gap-2 mb-3">
    <button class="btn btn-outline-secondary btn-sm" type="button" id="check-all">
      Marcar tudo
    </button>
    <button class="btn btn-outline-secondary btn-sm" type="button" id="uncheck-all">
      Desmarcar tudo
    </button>
  </div>

  <div class="row">
    {# agrupa por app #}
    {% regroup form.fields.permissoes.queryset by content_type.app_label as app_list %}

    {% for app in app_list %}
      <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-light">
            <h5 class="mb-0">
              {{ app.grouper|lower|lookup:app_labels }}
            </h5>
          </div>
          <div class="card-body">
            {% for perm in app.list %}
              <div class="form-check mb-1">
                <input
                  class="form-check-input perm-checkbox"
                  type="checkbox"
                  name="permissoes"
                  value="{{ perm.id }}"
                  id="perm_{{ perm.id }}"
                  {% if perm.id in form.initial.permissoes %}checked{% endif %}
                >
                <label class="form-check-label" for="perm_{{ perm.id }}">
                  {{ perm.name|perm_label }}
                  <span class="text-muted small">
                    ({{ perm.content_type.model|lower|lookup:model_labels }})
                  </span>
                </label>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <button type="submit" class="btn btn-success mt-3">Salvar</button>
</form>

<script>
  (function () {
    const byClass = (c) => Array.from(document.getElementsByClassName(c));
    const all = byClass('perm-checkbox');

    document.getElementById('check-all')?.addEventListener('click', () => {
      all.forEach(cb => cb.checked = true);
    });
    document.getElementById('uncheck-all')?.addEventListener('click', () => {
      all.forEach(cb => cb.checked = false);
    });
  })();
</script>
{% endblock %}
