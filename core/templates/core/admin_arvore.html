{# core/templates/core/admin_arvore.html #}
{% extends "core/base.html" %}

{% block title %}Administrador - Estrutura{% endblock %}

{% block content %}
  <h3>Gerenciar Estrutura</h3>

  {% if not tem_unidades %}
    <div class="alert alert-info">
      Nenhuma unidade cadastrada ainda.
      <button class="btn btn-primary btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#modalCriarRaiz">
        ➕ Inserir Primeiro Nível
      </button>
    </div>
  {% endif %}

  <!-- Container da Árvore (jsTree vai preencher isso) -->
  <div id="jstree"></div>

  <!-- Modal para criação de primeiro nível -->
  <div class="modal fade" id="modalCriarRaiz" tabindex="-1" aria-labelledby="modalCriarRaizLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" action="{% url 'core:nos_criar' %}" id="formCriarRaiz">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="modalCriarRaizLabel">Criar Unidade Raiz</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="id_nome_raiz" class="form-label">Nome da Unidade</label>
              <input type="text" name="nome" class="form-control" id="id_nome_raiz" required>
            </div>
            <input type="hidden" name="parent" value="">  <!-- nenhum parent = raiz -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('formCriarRaiz').addEventListener('submit', async function(event) {
      event.preventDefault();
      const form = event.target;
      const data = new FormData(form);
      const response = await fetch(form.action, {
        method: "POST",
        body: data,
        headers: { 'X-CSRFToken': data.get('csrfmiddlewaretoken') }
      });

      if (response.ok) {
        location.reload(); // recarrega para exibir o novo nó
      } else {
        alert("Erro ao criar unidade raiz.");
      }
    });
  </script>
{% endblock %}

{% block extra_js %}
  <!-- jQuery (caso não esteja no base.html) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- jsTree -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" rel="stylesheet" />

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      $('#jstree').jstree({
        'core': {
          'data': {
            'url': '/nos/',  // ✅ CORRIGIDO
            'dataType': 'json'
          },
          'check_callback': true,
          'themes': {
            'variant': 'large'
          }
        },
        'plugins': ['contextmenu', 'dnd', 'types', 'wholerow'],
        'contextmenu': {
          'items': function (node) {
            let items = $.jstree.defaults.contextmenu.items();
            items.create.label = "Criar filho";
            items.rename.label = "Renomear";
            items.remove.label = "Deletar";
            return items;
          }
        }
      })
      .on('create_node.jstree', function (e, data) {
        $.post('/nos/criar/', {  // ✅ CORRIGIDO
          nome: data.node.text,
          parent: data.node.parent !== "#" ? data.node.parent : "",
          csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function (res) {
          $('#jstree').jstree(true).set_id(data.node, res.id);
        });
      })
      .on('rename_node.jstree', function (e, data) {
        $.post(`/nos/renomear/${data.node.id}/`, {  // ✅ CORRIGIDO
          nome: data.text,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        });
      })
      .on('move_node.jstree', function (e, data) {
        $.post(`/nos/mover/${data.node.id}/`, {  // ✅ CORRIGIDO
          parent: data.parent !== "#" ? data.parent : "",
          csrfmiddlewaretoken: '{{ csrf_token }}'
        });
      })
      .on('delete_node.jstree', function (e, data) {
        $.post(`/nos/deletar/${data.node.id}/`, {  // ✅ CORRIGIDO
          csrfmiddlewaretoken: '{{ csrf_token }}'
        });
      });
    });
  </script>
{% endblock %}
