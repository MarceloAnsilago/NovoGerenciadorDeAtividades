{% extends "core/base.html" %}
{% load static %}

{% block title %}Dashboard Operacional{% endblock %}

{% block content %}
<div class="container-fluid py-3" id="dashboard-root" data-start="{{ dashboard_month_start|default:'' }}" data-end="{{ dashboard_month_end|default:'' }}">
  <div class="d-flex flex-wrap justify-content-between align-items-end gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1">Dashboard Operacional</h1>
      <p class="text-muted mb-0">
        Monitoramento em tempo real das metas, atividades e recursos.
      </p>
    </div>
    <div class="d-flex align-items-center gap-2 flex-nowrap">
      <label class="form-label small mb-0" for="dashboardStartMonth">Inicio</label>
      <input
        id="dashboardStartMonth"
        type="month"
        class="form-control form-control-sm"
        value="{{ dashboard_month_start|default:'' }}"
        {% if dashboard_month_min %}min="{{ dashboard_month_min }}"{% endif %}
        {% if dashboard_month_max %}max="{{ dashboard_month_max }}"{% endif %}
        style="width: 10rem;"
      >
      <label class="form-label small mb-0" for="dashboardEndMonth">Fim</label>
      <input
        id="dashboardEndMonth"
        type="month"
        class="form-control form-control-sm"
        value="{{ dashboard_month_end|default:'' }}"
        {% if dashboard_month_min %}min="{{ dashboard_month_min }}"{% endif %}
        {% if dashboard_month_max %}max="{{ dashboard_month_max }}"{% endif %}
        style="width: 10rem;"
      >
    </div>
  </div>

  {% if hierarchy_summary %}
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white fw-semibold d-flex justify-content-between align-items-center">
      <span>Resumo hierárquico da unidade</span>
      <span class="text-muted small">Valores específicos da unidade atual e dos filhos</span>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Unidade</th>
              <th class="text-end">Metas ativas</th>
              <th class="text-end">% metas concluídas</th>
              <th class="text-end">Atividades concluídas hoje</th>
              <th class="text-end">Servidores ativos</th>
            </tr>
          </thead>
          <tbody>
            <tr class="table-primary">
              <td>
                <strong>{{ hierarchy_summary.current.nome }}</strong>
                <span class="badge bg-primary-subtle text-primary ms-2">Atual</span>
              </td>
              <td class="text-end">{{ hierarchy_summary.current.metrics.metas_ativas }}</td>
              <td class="text-end">{{ hierarchy_summary.current.metrics.percentual_metas_concluidas|floatformat:1 }}%</td>
              <td class="text-end">{{ hierarchy_summary.current.metrics.atividades_concluidas_hoje }}</td>
              <td class="text-end">{{ hierarchy_summary.current.metrics.servidores_ativos }}</td>
            </tr>
            {% if hierarchy_summary.children %}
              {% for child in hierarchy_summary.children %}
              <tr>
                <td>{{ child.nome }}</td>
                <td class="text-end">{{ child.metrics.metas_ativas }}</td>
                <td class="text-end">{{ child.metrics.percentual_metas_concluidas|floatformat:1 }}%</td>
                <td class="text-end">{{ child.metrics.atividades_concluidas_hoje }}</td>
                <td class="text-end">{{ child.metrics.servidores_ativos }}</td>
              </tr>
              {% endfor %}
              {% if hierarchy_summary.children_metrics %}
              <tr class="table-secondary">
                <td><strong>Total dos filhos</strong></td>
                <td class="text-end">{{ hierarchy_summary.children_metrics.metas_ativas }}</td>
                <td class="text-end">{{ hierarchy_summary.children_metrics.percentual_metas_concluidas|floatformat:1 }}%</td>
                <td class="text-end">{{ hierarchy_summary.children_metrics.atividades_concluidas_hoje }}</td>
                <td class="text-end">{{ hierarchy_summary.children_metrics.servidores_ativos }}</td>
              </tr>
              {% endif %}
            {% endif %}
            {% if hierarchy_summary.children and hierarchy_summary.aggregate %}
            <tr class="table-light fw-semibold">
              <td>{{ hierarchy_summary.aggregate.label|default:"Total geral" }}</td>
              <td class="text-end">{{ hierarchy_summary.aggregate.metrics.metas_ativas }}</td>
              <td class="text-end">{{ hierarchy_summary.aggregate.metrics.percentual_metas_concluidas|floatformat:1 }}%</td>
              <td class="text-end">{{ hierarchy_summary.aggregate.metrics.atividades_concluidas_hoje }}</td>
              <td class="text-end">{{ hierarchy_summary.aggregate.metrics.servidores_ativos }}</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row g-3" data-kpis-container>
    <div class="col-12 col-sm-6 col-xl-3">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <p class="text-muted text-uppercase fw-semibold small mb-1">Metas ativas</p>
            <div class="display-6 fw-bold mb-0" data-kpi="metas_ativas">--</div>
          </div>
          <span class="rounded-circle bg-primary-subtle text-primary-emphasis d-inline-flex align-items-center justify-content-center"
            style="width: 3rem; height: 3rem;">
            <i class="bi bi-flag" aria-hidden="true"></i>
          </span>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-xl-3">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <p class="text-muted text-uppercase fw-semibold small mb-1">% metas concluidas</p>
            <div class="display-6 fw-bold mb-0" data-kpi="percentual_metas_concluidas">--</div>
          </div>
          <span class="rounded-circle bg-success-subtle text-success-emphasis d-inline-flex align-items-center justify-content-center"
            style="width: 3rem; height: 3rem;">
            <i class="bi bi-graph-up-arrow" aria-hidden="true"></i>
          </span>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-xl-3">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <p class="text-muted text-uppercase fw-semibold small mb-1">Atividades concluidas hoje</p>
            <div class="display-6 fw-bold mb-0" data-kpi="atividades_concluidas_hoje">--</div>
          </div>
          <span class="rounded-circle bg-info-subtle text-info-emphasis d-inline-flex align-items-center justify-content-center"
            style="width: 3rem; height: 3rem;">
            <i class="bi bi-check2-circle" aria-hidden="true"></i>
          </span>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-xl-3">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <p class="text-muted text-uppercase fw-semibold small mb-1">Servidores ativos</p>
            <div class="display-6 fw-bold mb-0" data-kpi="servidores_ativos">--</div>
          </div>
          <span class="rounded-circle bg-warning-subtle text-warning-emphasis d-inline-flex align-items-center justify-content-center"
            style="width: 3rem; height: 3rem;">
            <i class="bi bi-people" aria-hidden="true"></i>
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-2">
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white fw-semibold d-flex justify-content-between align-items-center">
          <span>Metas por unidade</span>
        </div>
        <div class="card-body">
          <canvas id="chartMetasUnidade" data-endpoint="{% url 'core:dashboard_metas_por_unidade' %}" height="260"></canvas>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white fw-semibold d-flex justify-content-between align-items-center">
          <span>Atividades por area</span>
        </div>
        <div class="card-body">
          <canvas id="chartAtividadesArea" data-endpoint="{% url 'core:dashboard_atividades_por_area' %}" height="260"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1">
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white fw-semibold">Progresso mensal (quantidade)</div>
        <div class="card-body">
          <canvas id="chartProgressoMensal" data-endpoint="{% url 'core:dashboard_progresso_mensal' %}" height="260"></canvas>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white fw-semibold">Programacoes concluidas vs pendentes</div>
        <div class="card-body">
          <canvas id="chartProgramacoesStatus" data-endpoint="{% url 'core:dashboard_programacoes_status_mensal' %}" height="260"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1">
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white fw-semibold">Uso de veiculos em programacoes</div>
        <div class="card-body">
          <canvas id="chartUsoVeiculos" data-endpoint="{% url 'core:dashboard_uso_veiculos' %}" height="260"></canvas>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white fw-semibold">Top servidores em atividades</div>
        <div class="card-body">
          <canvas id="chartTopServidores" data-endpoint="{% url 'core:dashboard_top_servidores' %}" height="260"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1">
    <div class="col-12">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white fw-semibold">Plantoes por semana</div>
        <div class="card-body">
          <canvas id="chartPlantaoSemanal" data-endpoint="{% url 'core:dashboard_plantao_heatmap' %}" height="260"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    window.DashboardEndpoints = {
      kpis: "{% url 'core:dashboard_kpis' %}",
      metasPorUnidade: "{% url 'core:dashboard_metas_por_unidade' %}",
      atividadesPorArea: "{% url 'core:dashboard_atividades_por_area' %}",
      progressoMensal: "{% url 'core:dashboard_progresso_mensal' %}",
      programacoesStatus: "{% url 'core:dashboard_programacoes_status_mensal' %}",
      plantaoHeatmap: "{% url 'core:dashboard_plantao_heatmap' %}",
      usoVeiculos: "{% url 'core:dashboard_uso_veiculos' %}",
      topServidores: "{% url 'core:dashboard_top_servidores' %}",
    };
  </script>
  <script src="{% static 'core/js/dashboard.js' %}?v=20260113-2" defer></script>
{% endblock %}
