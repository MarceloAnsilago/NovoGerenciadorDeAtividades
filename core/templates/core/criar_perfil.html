{% extends "base.html" %}
{% block title %}Perfis por Nó{% endblock %}

{% block extra_head %}
<style>
  :root { --indent-step: 18px; }

  /* Paleta sutil por nível */
  .level-0 { --lvl-bg: #f1f8ff; --lvl-border: #cfe5ff; }
  .level-1 { --lvl-bg: #f6f9ff; --lvl-border: #d9e5ff; }
  .level-2 { --lvl-bg: #f7fff8; --lvl-border: #d6f5da; }
  .level-3 { --lvl-bg: #fff9f1; --lvl-border: #ffe3c2; }
  .level-4 { --lvl-bg: #fdf7ff; --lvl-border: #ead9ff; }
  .level-5 { --lvl-bg: #fff7f8; --lvl-border: #ffd6dc; }
  .level-6, .level-default { --lvl-bg: #f5f5f5; --lvl-border: #e0e0e0; }

  .row-level {
    /* Fallbacks se a classe level-X não existir */
    --lvl-bg: #f5f5f5;
    --lvl-border: #e0e0e0;

    background: var(--lvl-bg, #f5f5f5);
    border-left: 4px solid var(--lvl-border, #e0e0e0);
    transition: background-color .2s ease;
  }
  .row-level:hover { filter: brightness(0.98); }

  /* Indicador de nível (bolinha colorida) */
  .lvl-dot {
    width: 10px; height: 10px; border-radius: 50%;
    display: inline-block; background-color: var(--lvl-border, #e0e0e0);
    margin-right: .5rem;
  }

  /* Indentação por classe (sem style inline) */
  .indent { display: inline-block; height: 1px; }
  .indent.lvl-0  { width: calc(var(--indent-step) * 0); }
  .indent.lvl-1  { width: calc(var(--indent-step) * 1); }
  .indent.lvl-2  { width: calc(var(--indent-step) * 2); }
  .indent.lvl-3  { width: calc(var(--indent-step) * 3); }
  .indent.lvl-4  { width: calc(var(--indent-step) * 4); }
  .indent.lvl-5  { width: calc(var(--indent-step) * 5); }
  .indent.lvl-6  { width: calc(var(--indent-step) * 6); }
  .indent.lvl-7  { width: calc(var(--indent-step) * 7); }
  .indent.lvl-8  { width: calc(var(--indent-step) * 8); }
  .indent.lvl-9  { width: calc(var(--indent-step) * 9); }
  .indent.lvl-10 { width: calc(var(--indent-step) * 10); }

  /* Tabela mais clean */
  .table-clean thead th {
    background: #f8f9fc;
    border-bottom: 1px solid #e9ecef;
  }
  .table-clean tbody td {
    border-top: 1px dashed #eceff3;
    vertical-align: middle;
  }
  .card.table-card {
    border: 1px solid #e9ecef;
    border-radius: .75rem;
  }

  /* Coluna de ações mais elegante */
  .actions-col {
    width: 1%;
    white-space: nowrap;
  }

  /* Botão circular com ícone */
  .btn-icon {
    --size: 36px;
    width: var(--size);
    height: var(--size);
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0">Perfis por Nó</h1>
    <span class="text-muted small">{{ total_nos }} nó(s)</span>
  </div>

  <div class="card table-card shadow-sm">
    <div class="card-body">

      <div class="alert alert-secondary d-flex align-items-center mb-4" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        Cada linha representa um nó da hierarquia. Use o botão <strong>+</strong> para iniciar a criação de um perfil vinculado a esse nó.
      </div>

      {% if nos_planos %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 table-clean">
          <thead>
            <tr>
              <th style="width: 45%">Nó</th>
              <th style="width: 20%">Tipo</th>
              <th>Caminho completo</th>
              <th class="text-end actions-col">Ações</th>
            </tr>
          </thead>
         
          <tbody>
            {% for no in nos_planos %}
              {# define level com fallback para 0 #}
              {% with level=no.level|default_if_none:0 %}
                <tr class="row-level {% if level|add:0 <= 10 %}level-{{ level }}{% else %}level-default{% endif %}">
                  <td>
                    <span class="lvl-dot" aria-hidden="true"></span>
                    <span class="badge bg-light text-dark border me-2">Nível {{ level }}</span>
                    <span class="indent lvl-{{ level }}"></span>
                    <strong>{{ no.nome }}</strong>
                  </td>
                  <td>
                    {% if no.tipo %}
                      <span class="badge bg-primary text-white">{{ no.tipo }}</span>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td class="text-muted small">{{ no.path }}</td>
                  <td class="text-end">
                    <a href="{% url 'core:novo_perfil' %}?no={{ no.id }}"
                      class="btn btn-outline-primary btn-icon"
                      title="Criar Perfil para {{ no.nome }}"
                      data-bs-toggle="tooltip" data-bs-placement="left"
                      aria-label="Criar Perfil para {{ no.nome }}">
                      <i class="bi bi-person-plus"></i>
                    </a>
                  </td>
                </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Nenhum nó encontrado. Crie a estrutura na página <a href="{% url 'core:admin_arvore' %}">Administrador</a>.
        </div>
      {% endif %}

    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (el) { new bootstrap.Tooltip(el); });
  });
</script>
{% endblock %}
