{% load static %}
{% load unidade_tags %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Gerenciador de Atividades{% endblock %}</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      --sidebar-width: 260px;
      --sidebar-width-collapsed: 70px;
      --navbar-height: 56px;
    }

    body {
      margin: 0;
      padding-top: var(--navbar-height);
      background-color: #f8f9fa;
      font-family: system-ui, sans-serif;
    }

    .navbar {
      background: linear-gradient(135deg, #07162e, #04112b);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      z-index: 1040;
    }

    .navbar .navbar-brand,
    .navbar .nav-link,
    .navbar .navbar-text {
      color: #ffffff !important;
    }

    .sidebar {
      position: fixed;
      top: var(--navbar-height);
      left: 0;
      width: var(--sidebar-width);
      height: calc(100vh - var(--navbar-height));
      background: linear-gradient(135deg, #07162e, #04112b);
      border-right: 1px solid #1f2a40;
      overflow-y: auto;
      z-index: 1030;
      color: white;
      transition: width 0.3s ease;
    }

    .sidebar.collapsed {
      width: var(--sidebar-width-collapsed);
    }

    .sidebar .nav-link {
      display: flex;
      align-items: center;
      padding: 0.5rem 1rem;
      color: white;
      text-decoration: none;
      border-radius: 0.375rem;
      margin: 0.125rem 0.5rem;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .sidebar .nav-link i { margin-right: 0.5rem; }

    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .sidebar.collapsed .nav-link span { display: none; }

    .sidebar .nav-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: #adb5bd;
      padding: 0.75rem 1rem 0.25rem;
    }

    .sidebar-header { padding: 0 1rem; }

    .content {
      margin-left: var(--sidebar-width);
      padding: 2rem;
      transition: margin-left 0.3s ease;
    }

    .content.expanded { margin-left: var(--sidebar-width-collapsed); }

    .sidebar.collapsed { width: var(--sidebar-width-collapsed); text-align: center; }

    .sidebar .nav-link { gap: 0.5rem; padding: 0.65rem 1rem; position: relative; }

    .sidebar.collapsed .nav-link { justify-content: center; padding: 0.75rem 0.5rem; }
    .sidebar .nav-link i { font-size: 1.2rem; }
    .sidebar.collapsed .nav-link i { font-size: 1.4rem; margin: 0; }
    .sidebar.collapsed .nav-link span { display: none; }

    /* Tooltip ao passar o mouse */
    .sidebar.collapsed .nav-link::after {
      content: attr(data-bs-title);
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 4px 8px;
      font-size: 0.75rem;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      border-radius: 0.25rem;
      margin-left: 0.5rem;
      transition: all 0.2s ease;
      z-index: 9999;
    }

    .sidebar.collapsed .nav-link:hover::after { opacity: 1; visibility: visible; }

    @media (max-width: 768px) {
      .sidebar {
        position: relative;
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid #dee2e6;
      }
      .content { margin-left: 0; }
    }

    /* esconder elementos marcados com .no-print apenas na impressão */
    @media print {
      .no-print { display: none !important; }
    }

    /* tarja fixa topo (espaçamento do conteúdo é feito pelo padding-top do body) */
    #global-messages-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1060;
      pointer-events: none; /* para não bloquear clicks atrás; alerts têm pointer-events:auto */
    }
    #global-messages-wrapper .container { pointer-events: auto; }
  </style>

  {% block extra_head %}
    {% if request.resolver_match.url_name == 'admin_arvore' %}
      <!-- jsTree CSS -->
      <link href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" rel="stylesheet" />
    {% endif %}
  {% endblock %}
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top">
  <div class="container-fluid px-4">
    <a class="navbar-brand" href="{% url 'core:dashboard' %}">Gerenciador de Atividades IDARON</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMain">
      <ul class="navbar-nav ms-auto align-items-center gap-2">
        {% if request.user.is_authenticated %}
          <li class="nav-item">
            <span class="navbar-text">
              <i class="bi bi-person-circle me-1"></i>
              {{ request.user.get_short_name|default:request.user.username }}
            </span>
          </li>

          {% if request.session.contexto_nome %}
            <li class="nav-item">
              <span class="badge bg-info text-dark ms-1">
                Unidade atual: {{ request.session.contexto_nome }}
              </span>
            </li>
            <li class="nav-item">
              <a href="{% url 'core:voltar_contexto' %}" class="btn btn-outline-warning btn-sm ms-1">
                <i class="bi bi-arrow-counterclockwise"></i> Voltar
              </a>
            </li>
          {% endif %}

          <!-- dentro da navbar -->
          {% if perms.core.assumir_unidade and unidades_disponiveis %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle btn btn-sm btn-outline-light" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Trocar unidade
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                {% unidade_tree unidades_disponiveis contexto_atual=request.session.contexto_atual %}
              </ul>
            </li>
          {% endif %}

          <li class="nav-item">
            <form method="post" action="{% url 'core:logout' %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-light btn-sm">
                <i class="bi bi-box-arrow-right"></i> Sair
              </button>
            </form>
          </li>

        {% else %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'core:login' %}">
              <i class="bi bi-box-arrow-in-right"></i> Entrar
            </a>
          </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

{# ===== GLOBAL TARJA DE MENSAGENS (fixa no topo) ===== #}
{% if messages %}
  <div id="global-messages-wrapper" class="no-print">
    <div class="container" style="max-width: 980px; margin-top: .5rem;">
      {% for message in messages %}
        {% with bs=message.tags|default:"info" %}
          <div class="alert alert-{{ bs }} alert-dismissible fade show mb-2 shadow-sm" role="alert" aria-live="polite">
            {{ message|safe }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
          </div>
        {% endwith %}
      {% endfor %}
    </div>
  </div>
{% endif %}

<!-- SIDEBAR + CONTEÚDO -->
<div class="app-wrapper">

<!-- SIDEBAR -->
<aside id="sidebar" class="sidebar">
  <div class="d-flex justify-content-end px-3 pt-2">
    <button id="sidebarToggle" class="btn btn-sm btn-outline-light">
      <i class="bi bi-layout-sidebar-inset"></i>
    </button>
  </div>

  <div class="sidebar-header py-2 text-center">
    <span class="fw-semibold">Menu</span>
  </div>

  <ul class="nav flex-column px-2 text-start text-md-start">
    <li class="nav-item">
      <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
        href="{% url 'core:dashboard' %}" data-bs-title="Dashboard">
        <i class="bi bi-speedometer2"></i> <span>Dashboard</span>
      </a>
    </li>

    <li class="nav-item">
      <a class="nav-link {% if request.resolver_match.app_name == 'servidores' or 'servidores' in request.resolver_match.namespaces %}active{% endif %}"
        href="{% url 'servidores:lista' %}" data-bs-title="Servidores" aria-current="{% if request.resolver_match.app_name == 'servidores' %}page{% endif %}">
        <i class="bi bi-person-gear"></i> <span>Servidores</span>
      </a>
    </li>

    <li class="nav-item">
      <a class="nav-link {% if request.resolver_match.app_name == 'veiculos' or 'veiculos' in request.resolver_match.namespaces %}active{% endif %}"
        href="{% url 'veiculos:lista' %}" data-bs-title="Veículos" aria-current="{% if request.resolver_match.app_name == 'veiculos' %}page{% endif %}">
        <i class="bi bi-truck"></i> <span>Veículos</span>
      </a>
    </li>

    <li class="nav-item">
      <a class="nav-link {% if request.resolver_match.app_name == 'atividades' or 'atividades' in request.resolver_match.namespaces %}active{% endif %}"
        href="{% url 'atividades:lista' %}" data-bs-title="Atividades" aria-current="{% if request.resolver_match.app_name == 'atividades' %}page{% endif %}">
        <i class="bi bi-list-task"></i> <span>Atividades</span>
      </a>
    </li>

    <li class="nav-item">
      <a class="nav-link {% if request.resolver_match.app_name == 'descanso' or 'descanso' in request.resolver_match.namespaces %}active{% endif %}"
        href="{% url 'descanso:lista_servidores' %}" data-bs-title="Descanso" aria-current="{% if request.resolver_match.app_name == 'descanso' %}page{% endif %}">
        <i class="bi bi-calendar-check"></i> <span>Descanso</span>
      </a>
    </li>

    <li class="nav-item">
      <a class="nav-link {% if request.resolver_match.app_name == 'plantao' or 'plantao' in request.resolver_match.namespaces %}active{% endif %}"
        href="{% url 'plantao:lista_plantao' %}" data-bs-title="Plantão" aria-current="{% if request.resolver_match.app_name == 'plantao' %}page{% endif %}">
        <i class="bi bi-calendar-week"></i> <span>Plantão</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if request.resolver_match.app_name == 'metas' or 'metas' in request.resolver_match.namespaces %}active{% endif %}"
        href="{% url 'metas:atividades-lista' %}"
        data-bs-title="Metas"
        aria-current="{% if request.resolver_match.app_name == 'metas' %}page{% endif %}">
        <i class="bi bi-bullseye"></i> <span>Metas</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if request.resolver_match.app_name == 'minhas_metas' or 'minhas_metas' in request.resolver_match.namespaces %}active{% endif %}"
        href="{% url 'minhas_metas:minhas_metas' %}"
        data-bs-title="Minhas Metas"
        aria-current="{% if request.resolver_match.app_name == 'minhas_metas' %}page{% endif %}">
        <i class="bi bi-clipboard-check"></i> <span>Minhas Metas</span>
      </a>
    </li>
    {% with ns=request.resolver_match.namespace app=request.resolver_match.app_name %}

      {# Novo #}
      <li class="nav-item">
        <a class="nav-link {% if ns == 'programar' or app == 'programar' %}active{% endif %}"
          href="{% url 'programar:calendario' %}"
          data-bs-toggle="tooltip"
          data-bs-title="Programação (novo)"
          aria-current="{% if ns == 'programar' or app == 'programar' %}page{% endif %}">
          <i class="bi bi-calendar-event"></i>
          <span>Programação</span>
          <span class="badge text-bg-success ms-1">novo</span>
        </a>
      </li>

    {% endwith %}

    {% if request.user.is_superuser %}
      <li class="nav-item mt-3"><div class="nav-section-title">Administração</div></li>

      <li class="nav-item">
        <a class="nav-link {% if request.resolver_match.url_name == 'perfis' %}active{% endif %}" href="{% url 'core:perfis' %}" data-bs-title="Perfis">
          <i class="bi bi-people"></i> <span>Perfis</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if request.resolver_match.url_name == 'admin_arvore' %}active{% endif %}" href="{% url 'core:admin_arvore' %}" data-bs-title="Administrador">
          <i class="bi bi-diagram-3"></i> <span>Administrador</span>
        </a>
      </li>
    {% endif %}
  </ul>
</aside>

  <!-- CONTEÚDO -->
  <main class="content">
    <div class="container-fluid py-4">
      {% block content %}{% endblock %}
    </div>
  </main>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const sidebar = document.getElementById('sidebar');
    const toggle = document.getElementById('sidebarToggle');
    const content = document.querySelector('.content');

    const collapsed = localStorage.getItem('sidebar-collapsed') === 'true';
    if (collapsed) {
      sidebar.classList.add('collapsed');
      content.classList.add('expanded');
    }

    toggle?.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      content.classList.toggle('expanded');
      localStorage.setItem('sidebar-collapsed', sidebar.classList.contains('collapsed'));
    });

    // auto-dismiss global messages após X ms (6s)
    setTimeout(() => {
      document.querySelectorAll('#global-messages-wrapper .alert').forEach(alertEl => {
        try {
          const bsAlert = bootstrap.Alert.getInstance(alertEl) || new bootstrap.Alert(alertEl);
          bsAlert.close();
        } catch (e) {
          alertEl.remove();
        }
      });
    }, 6000);
  });
</script>

{% block extra_js %}
  {% if request.resolver_match.url_name == 'admin_arvore' %}
    <!-- jsTree JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        $('#jstree').jstree({
          'core': {
            'data': { 'url': '/core/nos/', 'dataType': 'json' },
            'check_callback': true,
            'themes': { 'variant': 'large' }
          },
          'plugins': ['contextmenu', 'dnd', 'types', 'wholerow']
        })
        .on('create_node.jstree', function (e, data) {
          $.post('/core/nos/criar/', {
            nome: data.node.text,
            parent: data.node.parent !== "#" ? data.node.parent : "",
            csrfmiddlewaretoken: '{{ csrf_token }}'
          }, function (res) {
            $('#jstree').jstree(true).set_id(data.node, res.id);
          });
        })
        .on('rename_node.jstree', function (e, data) {
          $.post(`/core/nos/renomear/${data.node.id}/`, {
            nome: data.text, csrfmiddlewaretoken: '{{ csrf_token }}'
          });
        })
        .on('move_node.jstree', function (e, data) {
          $.post(`/core/nos/mover/${data.node.id}/`, {
            parent: data.parent !== "#" ? data.parent : "", csrfmiddlewaretoken: '{{ csrf_token }}'
          });
        })
        .on('delete_node.jstree', function (e, data) {
          $.post(`/core/nos/deletar/${data.node.id}/`, { csrfmiddlewaretoken: '{{ csrf_token }}' });
        });
      });
    </script>
  {% endif %}
{% endblock %}

{% block scripts %}{% endblock %}
</body>
</html>
