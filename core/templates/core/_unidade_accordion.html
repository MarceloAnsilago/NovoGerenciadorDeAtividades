{% load unidade_tags %}
<div class="accordion-item">
  <h2 class="accordion-header" id="heading{{ unidade.id }}">
    {% with nivel=unidade|depth %}
    <button class="accordion-button collapsed 
                  {% if nivel == 0 %} bg-primary-subtle
                  {% elif nivel == 1 %} bg-info-subtle
                  {% elif nivel == 2 %} bg-success-subtle
                  {% else %} bg-secondary-subtle
                  {% endif %}"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapse{{ unidade.id }}"
            aria-expanded="false"
            aria-controls="collapse{{ unidade.id }}">
      {{ unidade.nome }}
    </button>
    {% endwith %}
  </h2>

  <div id="collapse{{ unidade.id }}" class="accordion-collapse collapse"
       aria-labelledby="heading{{ unidade.id }}"
       data-bs-parent="#accordion{{ unidade.parent.id|default:'Root' }}">
    <div class="accordion-body">

      <!-- Botão Criar Perfil -->
      <div class="d-flex justify-content-end mb-2">
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                data-bs-target="#modalCriarPerfil" data-unidade-id="{{ unidade.id }}">
          Criar Perfil
        </button>
      </div>

      <!-- Tabela de Perfis -->
      <div class="table-responsive">
        <table class="table table-sm table-bordered">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for perfil in unidade.userprofile_set.all %}
              <tr>
                <td>{{ perfil.user.username }}</td>
                <td>
                  {% if perfil.user.is_active %}
                    <span class="badge bg-success">Ativo</span>
                  {% else %}
                    <span class="badge bg-secondary">Inativo</span>
                  {% endif %}
                </td>
                <td class="d-flex gap-1 flex-wrap">
                  <button class="btn btn-sm btn-outline-secondary"
                          data-user-id="{{ perfil.user.id }}"
                          data-username="{{ perfil.user.username }}"
                          onclick="handleRedefinirSenha(this)">
                    Redefinir Senha
                  </button>
                  <button class="btn btn-sm btn-outline-danger"
                          data-user-id="{{ perfil.user.id }}"
                          onclick="handleExcluirPerfil(this)">
                    Excluir
                  </button>
                  <a href="{% url 'controle_acesso:gerenciar_permissoes' %}?user_id={{ perfil.user.id }}"
                     class="btn btn-sm btn-outline-warning">
                    Permissões
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="text-muted text-center">Nenhum perfil nesta unidade.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Accordion de Subunidades -->
      {% if unidade.filhos.all %}
        <div class="accordion mt-3" id="accordion{{ unidade.id }}">
          {% for filho in unidade.filhos.all %}
            {% include "core/_unidade_accordion.html" with unidade=filho %}
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</div>
